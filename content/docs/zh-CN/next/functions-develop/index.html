<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>开发 Pulsar Function · Apache Pulsar</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="你将学习如何使用 Java 、 Python 和 Go来开发不同的 API 的 Pulsar Function。"/><meta name="docsearch:version" content="next"/><meta name="docsearch:language" content="zh-CN"/><meta property="og:title" content="开发 Pulsar Function · Apache Pulsar"/><meta property="og:type" content="website"/><meta property="og:url" content="https://pulsar.apache.org/"/><meta property="og:description" content="你将学习如何使用 Java 、 Python 和 Go来开发不同的 API 的 Pulsar Function。"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://pulsar.apache.org/img/pulsar.svg"/><link rel="shortcut icon" href="/img/pulsar.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"/><link rel="alternate" type="application/atom+xml" href="https://pulsar.apache.org/blog/atom.xml" title="Apache Pulsar Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://pulsar.apache.org/blog/feed.xml" title="Apache Pulsar Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-102219959-1', 'auto');
              ga('send', 'pageview');
            </script><link rel="stylesheet" href="/css/code-blocks-buttons.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="/js/custom.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/zh-CN"><img class="logo" src="/img/pulsar.svg" alt="Apache Pulsar"/></a><a href="/zh-CN/versions"><h3>next</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/zh-CN/next/standalone" target="_self">文档</a></li><li class=""><a href="/zh-CN/download" target="_self">下载</a></li><li class="siteNavGroupActive"><a href="/docs/zh-CN/next/client-libraries" target="_self">客户端</a></li><li class=""><a href="#restapis" target="_self">REST API</a></li><li class=""><a href="#cli" target="_self">命令行</a></li><li class=""><a href="/blog/" target="_self">博客</a></li><li class=""><a href="#community" target="_self">社区</a></li><li class=""><a href="#apache" target="_self">Apache</a></li><li class=""><a href="https://pulsar-next.staged.apache.org/" target="_self">New Website(Beta)</a></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/img/language.svg" alt="Languages icon"/>中文</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/en/next/functions-develop">English</a></li><li><a href="/docs/ja/next/functions-develop">日本語</a></li><li><a href="/docs/fr/next/functions-develop">Français</a></li><li><a href="/docs/ko/next/functions-develop">한국어</a></li><li><a href="/docs/zh-TW/next/functions-develop">繁體中文</a></li><li><a href="https://crowdin.com/project/apache-pulsar" target="_blank" rel="noreferrer noopener">参与翻译</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Pulsar Functions</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Get Started</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/standalone">本地运行 Pulsar</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/standalone-docker">在 Docker 中运行 Pulsar</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/kubernetes-helm">在 Kubernetes 中运行 Pulsar</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">概念和架构</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-overview">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-messaging">消息</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-architecture-overview">架构</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-clients">客户端</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-replication">跨机房复制</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-multi-tenancy">多租户</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-authentication">认证和授权</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-topic-compaction">消息压缩</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-proxy-sni-routing">Pulsar Proxy 支持 SNI 路由</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/concepts-multiple-advertised-listeners">配置 Advertised 监听器</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Pulsar Schema</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/schema-get-started">开始</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/schema-understand">理解 schema</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/schema-evolution-compatibility">Schema 演化和兼容</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/schema-manage">管理 Schema</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Pulsar Functions</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/functions-overview">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/functions-runtime">设置：配置 Pulsar Functions 运行时</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/functions-worker">设置：Pulsar Functions Worker</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/zh-CN/next/functions-develop">操作：开发</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/functions-package">如何打包</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/functions-debug">操作：调试</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/functions-deploy">操作：部署</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/functions-cli">参考：命令</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/window-functions-context">窗口函数：上下文</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Pulsar IO</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/io-overview">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/io-quickstart">开始</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/io-use">使用</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/io-debug">调试</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/io-connectors">内置 connector</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/io-cdc">CDC connector</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/io-develop">开发</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/io-cli">CLI</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Pulsar SQL</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/sql-overview">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/sql-getting-started">查询数据</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/sql-deployment-configurations">配置和部署</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/sql-rest-api">REST API</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">层级存储</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/tiered-storage-overview">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/tiered-storage-aws">亚马逊 AWS S3 offloader</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/tiered-storage-gcs">GCS offloader</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/tiered-storage-filesystem">Filesystem offloader</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/tiered-storage-azure">Azure BlobStore offloader</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/tiered-storage-aliyun">阿里云 OSS offloader</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">事务</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/txn-why">为什么需要事务？</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/txn-what">什么是事务？</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/txn-how">事务运行原理</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/txn-use">如何使用事务？</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/txn-monitor">如何监控事务？</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Kubernetes (Helm)</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/helm-overview">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/helm-prepare">准备</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/helm-install">安装</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/helm-deploy">部署</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/helm-upgrade">升级</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/helm-tools">所需工具</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">部署</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/deploy-aws">Amazon Web Services (Aws)</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/deploy-kubernetes">Kubernetes</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/deploy-bare-metal">裸机</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/deploy-bare-metal-multi-cluster">裸机多集群部署</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/deploy-docker">Docker</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/deploy-monitoring">Monitor</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">系统管理</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/administration-zk-bk">ZooKeeper 和 BookKeeper</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/administration-geo">跨地域复制</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/administration-pulsar-manager">Pulsar Manager</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/administration-stats">Pulsar 统计数据</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/administration-load-balance">负载均衡</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/administration-proxy">Pulsar 代理</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/administration-upgrade">升级</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/administration-isolation">Pulsar 隔离</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">安全</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-overview">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-policy-and-supported-versions">安全政策和支持的版本</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-tls-transport">使用TLS进行传输加密</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-tls-authentication">使用TLS进行认证</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-tls-keystore">使用 TLS 配置KeyStore</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-jwt">使用 JWT 认证</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-athenz">使用 Athenz 验证</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-kerberos">使用 Kerberos 进行身份验证</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-oauth2">使用 OAuth 2.0 访问令牌进行身份验证</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-authorization">授权和ACL</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-encryption">端到端加密</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-extending">Extend Authentication and Authorization</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/security-bouncy-castle">Bouncy Castle Providers</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">性能</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/performance-pulsar-perf">Pulsar Perf 性能测试</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">客户端库</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries-java">Java</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries-go">Go</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries-python">Python</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries-cpp">C++</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries-node">Node.js
</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries-websocket">WebSocket</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries-dotnet">C#</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/client-libraries-rest">REST</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Admin API</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-overview">概述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-clusters">集群</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-tenants">租户</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-brokers">Brokers</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-namespaces">命名空间</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-permissions">权限管理</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-topics">Topic</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-functions">Functions</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/admin-api-packages">Package</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">适配器</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/adaptors-kafka">Kafka 客户端封装</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/adaptors-spark">Apache Spark</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/adaptors-storm">Apache Storm</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">参考手册</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/cookbooks-compaction">Topic compaction</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/cookbooks-deduplication">消息去重</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/cookbooks-non-persistent">非持久化消息</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/cookbooks-retention-expiry">消息保留和过期</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/cookbooks-encryption">加密</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/cookbooks-message-queue">消息队列</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/cookbooks-bookkeepermetadata">BookKeeper Ledger 元数据</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">开发</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/develop-tools">模拟工具</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/develop-binary-protocol">二进制协议</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/develop-load-manager">模块化负载管理器</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/develop-plugin">Plugin</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">参考</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/reference-terminology">术语</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/reference-cli-tools">Pulsar 命令行工具</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/reference-configuration">Pulsar configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/next/reference-metrics">Pulsar Metrics</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://crowdin.com/project/apache-pulsar/zh-CN" target="_blank" rel="noreferrer noopener">Translate</a><h1 id="__docusaurus" class="postHeaderTitle">开发 Pulsar Function</h1></header><article><div><span><p>你将学习如何使用 Java 、 Python 和 Go来开发不同的 API 的 Pulsar Function。</p>
<h2><a class="anchor" aria-hidden="true" id="可用-api"></a><a href="#可用-api" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可用 API</h2>
<p>在 Java 和 Python 中，编写 Pulsar Functions 的方式有两种。 在 Go 中，可以使用 Pulsar Functions SDK。</p>
<table>
<thead>
<tr><th style="text-align:left">接口</th><th style="text-align:left">说明</th><th style="text-align:left">使用场景</th></tr>
</thead>
<tbody>
<tr><td style="text-align:left">语言原生接口</td><td style="text-align:left">不需要特定于 Pulsar 的库或特殊依赖（仅需要 Java/Python 的核心库）。</td><td style="text-align:left">不需要访问 <a href="#context">context</a> function 的 functions。</td></tr>
<tr><td style="text-align:left">适用于 Java/Python/Go 的 Pulsar Function SDK</td><td style="text-align:left">特定于 Pulsar 的库，提供“本地”接口未提供的一系列功能。</td><td style="text-align:left">需要访问 <a href="#context">context</a> function 的 functions。</td></tr>
<tr><td style="text-align:left">Java 的 Pulsar 扩展 Function SDK</td><td style="text-align:left">一个 Pulsar 专用库的扩展，提供了 Java 的初始化和关闭界面。</td><td style="text-align:left">需要初始化和释放外部资源的 Function。</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="语言原生接口"></a><a href="#语言原生接口" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语言原生接口</h3>
<p>语言原生 function 没有外部依赖关系，该 function 为所有传入的字符串添加感叹号，并将结果发布到 topic。 语言原生 function示例如下。</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3207-tab-3208" class="nav-link active" data-group="group_3207" data-tab="tab-group-3207-content-3208">Java</div><div id="tab-group-3207-tab-3209" class="nav-link" data-group="group_3207" data-tab="tab-group-3207-content-3209">Python</div></div><div class="tab-content"><div id="tab-group-3207-content-3208" class="tab-pane active" data-group="group_3207" tabindex="-1"><div><span><pre><code class="hljs css language-Java"><span class="hljs-keyword">import</span> java.util.function.Function;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaNativeExclamationFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">String</span>&gt; </span>{<br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">apply</span><span class="hljs-params">(String input)</span> </span>{<br />        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%s!"</span>, input);<br />    }<br />}<br /></code></pre>
<p>查看完整代码，请点击<a href="https://github.com/apache/pulsar/blob/master/pulsar-functions/java-examples/src/main/java/org/apache/pulsar/functions/api/examples/JavaNativeExclamationFunction.java">这里</a>。</p>
</span></div></div><div id="tab-group-3207-content-3209" class="tab-pane" data-group="group_3207" tabindex="-1"><div><span><pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(input)</span>:</span><br />    <span class="hljs-keyword">return</span> <span class="hljs-string">"{}!"</span>.format(input)<br /></code></pre>
<p>查看完整代码，请点击<a href="https://github.com/apache/pulsar/blob/master/pulsar-functions/python-examples/native_exclamation_function.py">这里</a>。</p>
<blockquote>
<p>注意 可以在 Python2 或 Python3 中编写 Pulsar Functions。 但是，Pulsar 只将 <code>python</code> 作为解释器。</p>
<p>如果在仅支持 python3 的 Ubuntu 系统上运行 Pulsar Functions，则可能无法运行 functions。 在这种情况下，可以创建符号链接。 然后，安装任何依赖于 Python 2.x 的包，系统都会运行失败。解决方案仍在开发中 <a href="https://github.com/apache/pulsar/issues/5518">Issue 5518</a>。</p>
<pre><code class="hljs css language-bash">sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 10<br /></code></pre>
</blockquote>
</span></div></div></div></div>
<h3><a class="anchor" aria-hidden="true" id="适用于-javapythongo-的-pulsar-function-sdk"></a><a href="#适用于-javapythongo-的-pulsar-function-sdk" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>适用于 Java/Python/Go 的 Pulsar Function SDK</h3>
<p>使用 Pulsar Functions SDK 的示例如下。 <div class="tabs"><div class="nav-tabs"><div id="tab-group-3210-tab-3211" class="nav-link active" data-group="group_3210" data-tab="tab-group-3210-content-3211">Java</div><div id="tab-group-3210-tab-3212" class="nav-link" data-group="group_3210" data-tab="tab-group-3210-content-3212">Python</div><div id="tab-group-3210-tab-3213" class="nav-link" data-group="group_3210" data-tab="tab-group-3210-content-3213">Go</div><div id="tab-group-3210-tab-3214" class="nav-link" data-group="group_3210" data-tab="tab-group-3210-content-3214">Java</div></div><div class="tab-content"><div id="tab-group-3210-content-3211" class="tab-pane active" data-group="group_3210" tabindex="-1"><div><span><pre><code class="hljs css language-Java"><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Context;<br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Function;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExclamationFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">String</span>&gt; </span>{<br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">process</span><span class="hljs-params">(String input, Context context)</span> </span>{<br />        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;%s!&quot;</span>, input);<br />    }<br />}<br /></code></pre></p>
<p>查看完整代码，请点击<a href="https://github.com/apache/pulsar/blob/master/pulsar-functions/java-examples/src/main/java/org/apache/pulsar/functions/api/examples/ExclamationFunction.java">这里</a>。</p>
</span></div></div><div id="tab-group-3210-content-3212" class="tab-pane" data-group="group_3210" tabindex="-1"><div><span><pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> pulsar <span class="hljs-keyword">import</span> Function<br /><br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExclamationFunction</span><span class="hljs-params">(Function)</span>:</span><br />  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span><br />    <span class="hljs-keyword">pass</span><br /><br />  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(self, input, context)</span>:</span><br />    <span class="hljs-keyword">return</span> input + <span class="hljs-string">'!'</span><br /></code></pre>
<p>查看完整代码，请点击<a href="https://github.com/apache/pulsar/blob/master/pulsar-functions/python-examples/exclamation_function.py">这里</a>。</p>
</span></div></div><div id="tab-group-3210-content-3213" class="tab-pane" data-group="group_3210" tabindex="-1"><div><span><pre><code class="hljs css language-Go"><span class="hljs-keyword">package</span> main<br /><br /><span class="hljs-keyword">import</span> (<br />    <span class="hljs-string">"context"</span><br />    <span class="hljs-string">"fmt"</span><br /><br />    <span class="hljs-string">"github.com/apache/pulsar/pulsar-function-go/pf"</span><br />)<br /><br /><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HandleRequest</span><span class="hljs-params">(ctx context.Context, in []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">error</span></span>{<br />    fmt.Println(<span class="hljs-keyword">string</span>(in) + <span class="hljs-string">"!"</span>)<br />    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<br />    pf.Start(HandleRequest)<br />}<br /></code></pre>
<h3><a class="anchor" aria-hidden="true" id="java-的-pulsar-扩展-function-sdk"></a><a href="#java-的-pulsar-扩展-function-sdk" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Java 的 Pulsar 扩展 Function SDK</h3>
<p>这个扩展的 Pulsar Function SDK 提供了另外两个接口来初始化和释放外部资源。</p>
<ul>
<li>通过使用 <code>initialize</code> 接口，您可以仅需要在 Function 实例启动时一次性初始化外部资源。</li>
<li>通过使用 <code>close</code> 接口，当 Function 实例关闭时，您可以关闭引用的外部资源。</li>
</ul>
<blockquote>
<p><strong>Note</strong></p>
<p>扩展的 Java Pulsar Function SDK 可在 Pulsar 2.10.0 及以后版本中使用。 在使用前，您需要设置 Pulsar Function worker 2.10.0 或以后的版本。</p>
</blockquote>
<p>下面的例子使用 Java 的 Pulsar Function SDK 的扩展接口，在 Function 实例启动时初始化 RedisClient 并在 Function 实例关闭时释放它。</p>
</span></div></div><div id="tab-group-3210-content-3214" class="tab-pane" data-group="group_3210" tabindex="-1"><div><span><pre><code class="hljs css language-Java"><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Context;<br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Function;<br /><span class="hljs-keyword">import</span> io.lettuce.core.RedisClient;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InitializableFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">String</span>&gt; </span>{<br />    <span class="hljs-keyword">private</span> RedisClient redisClient;<br /><br />    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initRedisClient</span><span class="hljs-params">(Map&lt;String, Object&gt; connectInfo)</span> </span>{<br />        redisClient = RedisClient.create(connectInfo.get(<span class="hljs-string">"redisURI"</span>));<br />    }<br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">(Context context)</span> </span>{<br />        Map&lt;String, Object&gt; connectInfo = context.getUserConfigMap();<br />        redisClient = initRedisClient(connectInfo);<br />    }<br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">process</span><span class="hljs-params">(String input, Context context)</span> </span>{<br />        String value = client.get(key);<br />        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%s-%s"</span>, input, value);<br />    }<br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> </span>{<br />        redisClient.close();<br />    }<br />}<br /></code></pre>
</span></div></div></div></div>
<h2><a class="anchor" aria-hidden="true" id="schema-registry"></a><a href="#schema-registry" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Schema registry</h2>
<p>Pulsar 有一个内置的 schema registry，还有各种常用的 schema 类型（avro、json、protobuf）。 Pulsar Functions 可以利用输入 topic 中现有 schema 的信息，并派生出输入类型。 Schema registry 也适用于输出 topic。</p>
<h2><a class="anchor" aria-hidden="true" id="serde"></a><a href="#serde" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SerDe</h2>
<p>SerDe stands for <strong>Ser</strong>ialization and <strong>De</strong>serialization. Pulsar Functions 使用 SerDe 向 Pulsar topic 发布数据或使用其中的数据。 默认情况下，SerDe 的工作方式取决于特定 function 所使用的语言。</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3215-tab-3216" class="nav-link active" data-group="group_3215" data-tab="tab-group-3215-content-3216">Java</div><div id="tab-group-3215-tab-3217" class="nav-link" data-group="group_3215" data-tab="tab-group-3215-content-3217">Python</div><div id="tab-group-3215-tab-3218" class="nav-link" data-group="group_3215" data-tab="tab-group-3215-content-3218">Go</div></div><div class="tab-content"><div id="tab-group-3215-content-3216" class="tab-pane active" data-group="group_3215" tabindex="-1"><div><span><p><code>String</code>, <code>Double</code> <code>Integer</code>, <code>Float</code>, <code>Long</code> &lt;code Short </code>和 <code>Byte</code>。</p>
<p>要自定义 Java 类型，需要实现以下接口。</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SerDe</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<br />    <span class="hljs-function">T <span class="hljs-title">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] input)</span></span>;<br />    <span class="hljs-keyword">byte</span>[] serialize(T input);<br />}<br /></code></pre>
<p>SerDe 在Java 函数中以以下方式工作。 - 如果输入和输出主题有 schema，Pulsar Function 对 Serde 使用 schema。 - 如果输入或输出主题不存在， Pulsar Function 采用以下规则来确定 Serde： - 如果指定了 schema 类型， Pulsar Function 将使用指定的 schema 类型。 - 如果指定了SerDe ，Pulsar Functions 使用指定的SerDe，输入和输出主题的schema 类型是 <code>Byte</code>。 - 如果没有指明schema类型或SerDe ，Pulsar Functions 使用内置的Serde。 对于非原始schema类型，内置的 SerDe 会以 JSON 格式序列化和反序列化对象。</p>
</span></div></div><div id="tab-group-3215-content-3217" class="tab-pane" data-group="group_3215" tabindex="-1"><div><span><p>在<a href="/docs/zh-CN/next/functions-deploy#cluster-mode">创建</a>或<a href="/docs/zh-CN/next/functions-deploy#local-run-mode">运行</a> function 时，可以指定 SerDe。</p>
<pre><code class="hljs css language-bash">$ bin/pulsar-admin <span class="hljs-built_in">functions</span> create \<br />  --tenant public \<br />  --namespace default \<br />  --name my_function \<br />  --py my_function.py \<br />  --classname my_function.MyFunction \<br />  --custom-serde-inputs <span class="hljs-string">'{"input-topic-1":"Serde1","input-topic-2":"Serde2"}'</span> \<br />  --output-serde-classname Serde3 \<br />  --output output-topic-1<br /></code></pre>
<p>此案例包含两个输入 topic：<code>input-topic-1</code> 和 <code>input-topic-2</code>，它们分别映射到不同的 SerDe 类（映射必须指定为 JSON 字符串）。 The output topic, <code>output-topic-1</code>, uses the <code>Serde3</code> class for SerDe. 目前，所有 Pulsar Functions 逻辑（包括处理函数和 SerDe 类）都必须包含在同一个 Python 文件中。</p>
<p>在将 Pulsar Functions 用于 Python 时，有三个 SerDe 可供选择：</p>
<ol>
<li>You can use the <a href="https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L70"><code>IdentitySerde</code></a>, which leaves the data unchanged. The <code>IdentitySerDe</code> is the <strong>default</strong>. 在未显式指定 SerDe 的情况下创建或运行 function 即使用此选项。</li>
<li>可以使用 <a href="https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L62"><code>PickleSerDe</code></a>，将 Python <a href="https://docs.python.org/3/library/pickle.html"><code>pickle</code></a> 用于 SerDe。</li>
<li>You can create a custom SerDe class by implementing the baseline <a href="https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L50"><code>SerDe</code></a> class, which has just two methods: <a href="https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L53"><code>serialize</code></a> for converting the object into bytes, and <a href="https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L58"><code>deserialize</code></a> for converting bytes into an object of the required application-specific type.</li>
</ol>
<p>下表显示了每个 SerDe 的使用情形。</p>
<table>
<thead>
<tr><th style="text-align:left">SerDe option</th><th style="text-align:left">When to use</th></tr>
</thead>
<tbody>
<tr><td style="text-align:left"><code>IdentitySerde</code></td><td style="text-align:left">在使用简单类型（如：字符串、布尔值、整型）时。</td></tr>
<tr><td style="text-align:left"><code>PickleSerDe</code></td><td style="text-align:left">在使用复杂的、特定于某应用程序的类型，并且适合于 <code>pickle</code> 的 “best effort”方法时。</td></tr>
<tr><td style="text-align:left">Custom SerDe</td><td style="text-align:left">在需要显示控制 SerDe 时，可能是出于性能或数据兼容性的考虑。</td></tr>
</tbody>
</table>
</span></div></div><div id="tab-group-3215-content-3218" class="tab-pane" data-group="group_3215" tabindex="-1"><div><span></span></div></div></div></div>
<h3><a class="anchor" aria-hidden="true" id="示例"></a><a href="#示例" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>示例</h3>
<p>Imagine that you're writing Pulsar Functions that are processing tweet objects, you can refer to the following example of <code>Tweet</code> class.</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3219-tab-3220" class="nav-link active" data-group="group_3219" data-tab="tab-group-3219-content-3220">Java</div><div id="tab-group-3219-tab-3221" class="nav-link" data-group="group_3219" data-tab="tab-group-3219-content-3221">Python</div></div><div class="tab-content"><div id="tab-group-3219-content-3220" class="tab-pane active" data-group="group_3219" tabindex="-1"><div><span><pre><code class="hljs css language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tweet</span> </span>{<br />    <span class="hljs-keyword">private</span> String username;<br />    <span class="hljs-keyword">private</span> String tweetContent;<br /><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Tweet</span><span class="hljs-params">(String username, String tweetContent)</span> </span>{<br />        <span class="hljs-keyword">this</span>.username = username;<br />        <span class="hljs-keyword">this</span>.tweetContent = tweetContent;<br />    }<br /><br />    <span class="hljs-comment">// Standard setters and getters</span><br />}<br /></code></pre>
<p>To pass <code>Tweet</code> objects directly between Pulsar Functions, you need to provide a custom SerDe class. In the example below, <code>Tweet</code> objects are basically strings in which the username and tweet content are separated by a <code>|</code>.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">package</span> com.example.serde;<br /><br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.SerDe;<br /><br /><span class="hljs-keyword">import</span> java.util.regex.Pattern;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TweetSerde</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SerDe</span>&lt;<span class="hljs-title">Tweet</span>&gt; </span>{<br />    <span class="hljs-function"><span class="hljs-keyword">public</span> Tweet <span class="hljs-title">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] input)</span> </span>{<br />        String s = <span class="hljs-keyword">new</span> String(input);<br />        String[] fields = s.split(Pattern.quote(<span class="hljs-string">"|"</span>));<br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Tweet(fields[<span class="hljs-number">0</span>], fields[<span class="hljs-number">1</span>]);<br />    }<br /><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] serialize(Tweet input) {<br />        <span class="hljs-keyword">return</span> <span class="hljs-string">"%s|%s"</span>.format(input.getUsername(), input.getTweetContent()).getBytes();<br />    }<br />}<br /></code></pre>
<p>To apply this customized SerDe to a particular Pulsar Function, you need to:</p>
<ul>
<li>将 <code>Tweet</code> 和 <code>TweetSerde</code> 类打包到一个 JAR 中。</li>
<li>部署 function 时，指定 JAR 和 SerDe 类名称的路径。</li>
</ul>
<p>The following is an example of <a href="/docs/zh-CN/next/pulsar-admin#create-1"><code>create</code></a> operation.</p>
<pre><code class="hljs css language-bash">$ bin/pulsar-admin <span class="hljs-built_in">functions</span> create \<br />  --jar /path/to/your.jar \<br />  --output-serde-classname com.example.serde.TweetSerde \<br />  <span class="hljs-comment"># Other function attributes</span><br /></code></pre>
<blockquote>
<h4><a class="anchor" aria-hidden="true" id="custom-serde-classes-must-be-packaged-with-your-function-jars"></a><a href="#custom-serde-classes-must-be-packaged-with-your-function-jars" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom SerDe classes must be packaged with your function JARs</h4>
<p>Pulsar does not store your custom SerDe classes separately from your Pulsar Functions. 需要在 function JAR 中包含 SerDe 类。 否则，Pulsar 将返回错误。</p>
</blockquote>
</span></div></div><div id="tab-group-3219-content-3221" class="tab-pane" data-group="group_3219" tabindex="-1"><div><span><pre><code class="hljs css language-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tweet</span><span class="hljs-params">(object)</span>:</span><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, username, tweet_content)</span>:</span><br />        self.username = username<br />        self.tweet_content = tweet_content<br /></code></pre>
<p>In order to use this class in Pulsar Functions, you have two options:</p>
<ol>
<li>可以指定 <code>PickleSerDe</code>，它将应用 <a href="https://docs.python.org/3/library/pickle.html"><code>pickle</code></a> 库 SerDe.</li>
<li>可以自己创建 SerDe 类。 The following is an example.</li>
</ol>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> pulsar <span class="hljs-keyword">import</span> SerDe<br /><br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TweetSerDe</span><span class="hljs-params">(SerDe)</span>:</span><br /><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">serialize</span><span class="hljs-params">(self, input)</span>:</span><br />        <span class="hljs-keyword">return</span> bytes(<span class="hljs-string">"{0}|{1}"</span>.format(input.username, input.tweet_content))<br /><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deserialize</span><span class="hljs-params">(self, input_bytes)</span>:</span><br />        tweet_components = str(input_bytes).split(<span class="hljs-string">'|'</span>)<br />        <span class="hljs-keyword">return</span> Tweet(tweet_components[<span class="hljs-number">0</span>], tweet_componentsp[<span class="hljs-number">1</span>])<br /></code></pre>
<p>查看完整代码,  请点击 <a href="https://github.com/apache/pulsar/blob/master/pulsar-functions/python-examples/custom_object_function.py">here</a>.</p>
</span></div></div></div></div>
<p>你可以用两种语言为更复杂的应用程序类型编写自定义的SerDe 逻辑。</p>
<h2><a class="anchor" aria-hidden="true" id="上下文context"></a><a href="#上下文context" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>上下文(Context)</h2>
<p>Java，Python 和 Go 的SDK提供了函数能够使用的<strong>context 对象</strong>。 并提供了各种各样的信息和功能。</p>
<ul>
<li>Pulsar Function 的名称和ID</li>
<li>每条消息的消息 ID。 每条 Pulsar 消息都会自动分配一个 ID。</li>
<li>消息的消息key，事件时间，分区key。</li>
<li>消息所在的主题的名称。</li>
<li>和函数有关的所有的输入主题和输出主题名称。</li>
<li>使用<a href="#serde">SerDe</a> 的类的名称。</li>
<li>函数所在的<a href="/docs/zh-CN/next/reference-terminology#tenant">tenant</a>和命名空间信息。</li>
<li>运行函数的 Pulsar Functions 实例的 ID。</li>
<li>函数的版本。</li>
<li>函数使用的<a href="/docs/zh-CN/next/functions-develop#logger">logger 对象</a> ，用于函数记录日志信息。</li>
<li>通过 CLI 传入的自定义的 <a href="#user-config">user configuration</a> 信息。</li>
<li>用于记录<a href="#metrics">metrics</a> 的接口。</li>
<li>用户保存和接收状态信息的接口<a href="#state-storage">state storage</a>。</li>
<li>用于向任意主题发布新消息的函数。</li>
<li>用于对正在处理的消息进行 ack 的函数（如果自动 ack 被禁用的话）。</li>
<li>(Java) get Pulsar admin client.</li>
</ul>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3222-tab-3223" class="nav-link active" data-group="group_3222" data-tab="tab-group-3222-content-3223">Java</div><div id="tab-group-3222-tab-3224" class="nav-link" data-group="group_3222" data-tab="tab-group-3222-content-3224">Python</div><div id="tab-group-3222-tab-3225" class="nav-link" data-group="group_3222" data-tab="tab-group-3222-content-3225">Go</div></div><div class="tab-content"><div id="tab-group-3222-content-3223" class="tab-pane active" data-group="group_3222" tabindex="-1"><div><span><p><a href="https://github.com/apache/pulsar/blob/master/pulsar-functions/api-java/src/main/java/org/apache/pulsar/functions/api/Context.java">Context</a> 接口提供了一系列方法 ，你可以通过函数的<a href="#context">context</a>对象去调用它. “Context” 对象的各种操作方法如下所示：</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Context</span> </span>{<br />    Record&lt;?&gt; getCurrentRecord();<br />    <span class="hljs-function">Collection&lt;String&gt; <span class="hljs-title">getInputTopics</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">String <span class="hljs-title">getOutputTopic</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">String <span class="hljs-title">getOutputSchemaType</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">String <span class="hljs-title">getTenant</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">String <span class="hljs-title">getNamespace</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">String <span class="hljs-title">getFunctionName</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">String <span class="hljs-title">getFunctionId</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">String <span class="hljs-title">getInstanceId</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">String <span class="hljs-title">getFunctionVersion</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">Logger <span class="hljs-title">getLogger</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">incrCounter</span><span class="hljs-params">(String key, <span class="hljs-keyword">long</span> amount)</span></span>;<br />    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">incrCounterAsync</span><span class="hljs-params">(String key, <span class="hljs-keyword">long</span> amount)</span></span>;<br />    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getCounter</span><span class="hljs-params">(String key)</span></span>;<br />    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getCounterAsync</span><span class="hljs-params">(String key)</span></span>;<br />    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putState</span><span class="hljs-params">(String key, ByteBuffer value)</span></span>;<br />    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putStateAsync</span><span class="hljs-params">(String key, ByteBuffer value)</span></span>;<br />    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deleteState</span><span class="hljs-params">(String key)</span></span>;<br />    <span class="hljs-function">ByteBuffer <span class="hljs-title">getState</span><span class="hljs-params">(String key)</span></span>;<br />    <span class="hljs-function">ByteBuffer <span class="hljs-title">getStateAsync</span><span class="hljs-params">(String key)</span></span>;<br />    <span class="hljs-function">Map&lt;String, Object&gt; <span class="hljs-title">getUserConfigMap</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">Optional&lt;Object&gt; <span class="hljs-title">getUserConfigValue</span><span class="hljs-params">(String key)</span></span>;<br />    <span class="hljs-function">Object <span class="hljs-title">getUserConfigValueOrDefault</span><span class="hljs-params">(String key, Object defaultValue)</span></span>;<br />    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">recordMetric</span><span class="hljs-params">(String metricName, <span class="hljs-keyword">double</span> value)</span></span>;<br />    &lt;O&gt; <span class="hljs-function">CompletableFuture&lt;Void&gt; <span class="hljs-title">publish</span><span class="hljs-params">(String topicName, O object, String schemaOrSerdeClassName)</span></span>;<br />    &lt;O&gt; <span class="hljs-function">CompletableFuture&lt;Void&gt; <span class="hljs-title">publish</span><span class="hljs-params">(String topicName, O object)</span></span>;<br />    &lt;O&gt; <span class="hljs-function">TypedMessageBuilder&lt;O&gt; <span class="hljs-title">newOutputMessage</span><span class="hljs-params">(String topicName, Schema&lt;O&gt; schema)</span> <span class="hljs-keyword">throws</span> PulsarClientException</span>;<br />    &lt;O&gt; <span class="hljs-function">ConsumerBuilder&lt;O&gt; <span class="hljs-title">newConsumerBuilder</span><span class="hljs-params">(Schema&lt;O&gt; schema)</span> <span class="hljs-keyword">throws</span> PulsarClientException</span>;<br />    <span class="hljs-function">PulsarAdmin <span class="hljs-title">getPulsarAdmin</span><span class="hljs-params">()</span></span>;<br />    <span class="hljs-function">PulsarAdmin <span class="hljs-title">getPulsarAdmin</span><span class="hljs-params">(String clusterName)</span></span>;<br />}<br /></code></pre>
<p>The following example uses several methods available via the <code>Context</code> object.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Context;<br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Function;<br /><span class="hljs-keyword">import</span> org.slf4j.Logger;<br /><br /><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContextFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Void</span>&gt; </span>{<br />    <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">process</span><span class="hljs-params">(String input, Context context)</span> </span>{<br />        Logger LOG = context.getLogger();<br />        String inputTopics = context.getInputTopics().stream().collect(Collectors.joining(<span class="hljs-string">", "</span>));<br />        String functionName = context.getFunctionName();<br /><br />        String logMessage = String.format(<span class="hljs-string">"A message with a value of \"%s\" has arrived on one of the following topics: %s\n"</span>,<br />                input,<br />                inputTopics);<br /><br />        LOG.info(logMessage);<br /><br />        String metricName = String.format(<span class="hljs-string">"function-%s-messages-received"</span>, functionName);<br />        context.recordMetric(metricName, <span class="hljs-number">1</span>);<br /><br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br />    }<br />}<br /></code></pre>
</span></div></div><div id="tab-group-3222-content-3224" class="tab-pane" data-group="group_3222" tabindex="-1"><div><span><pre><code class="hljs">class ContextImpl(pulsar.Context):<br />  def get_message_id(self):<br />    ...<br />  def get_message_key(self):<br />    ...<br />  def get_message_eventtime(self):<br />    ...<br />  def get_message_properties(self):<br />    ...<br />  def get_current_message_topic_name(self):<br />    ...<br />  def get_partition_key(self):<br />    ...<br />  def get_function_name(self):<br />    ...<br />  def get_function_tenant(self):<br />    ...<br />  def get_function_namespace(self):<br />    ...<br />  def get_function_id(self):<br />    ...<br />  def get_instance_id(self):<br />    ...<br />  def get_function_version(self):<br />    ...<br />  def get_logger(self):<br />    ...<br />  def get_user_config_value(self, key):<br />    ...<br />  def get_user_config_map(self):<br />    ...<br />  def record_metric(self, metric_name, metric_value):<br />    ...<br />  def get_input_topics(self):<br />    ...<br />  def get_output_topic(self):<br />    ...<br />  def get_output_serde_class_name(self):<br />    ...<br />  def publish(self, topic_name, message, serde_class_name=&quot;serde.IdentitySerDe&quot;,<br />              properties=None, compression_type=None, callback=None, message_conf=None):<br />    ...<br />  def ack(self, msgid, topic):<br />    ...<br />  def get_and_reset_metrics(self):<br />    ...<br />  def reset_metrics(self):<br />    ...<br />  def get_metrics(self):<br />    ...<br />  def incr_counter(self, key, amount):<br />    ...<br />  def get_counter(self, key):<br />    ...<br />  def del_counter(self, key):<br />    ...<br />  def put_state(self, key, value):<br />    ...<br />  def get_state(self, key):<br />    ...<br /></code></pre>
</span></div></div><div id="tab-group-3222-content-3225" class="tab-pane" data-group="group_3222" tabindex="-1"><div><span><pre><code class="hljs">func (c *FunctionContext) GetInstanceID() int {<br />  return c.instanceConf.instanceID<br />}<br /><br />func (c *FunctionContext) GetInputTopics() []string {<br />  return c.inputTopics<br />}<br /><br />func (c *FunctionContext) GetOutputTopic() string {<br />  return c.instanceConf.funcDetails.GetSink().Topic<br />}<br /><br />func (c *FunctionContext) GetFuncTenant() string {<br />  return c.instanceConf.funcDetails.Tenant<br />}<br /><br />func (c *FunctionContext) GetFuncName() string {<br />  return c.instanceConf.funcDetails.Name<br />}<br /><br />func (c *FunctionContext) GetFuncNamespace() string {<br />  return c.instanceConf.funcDetails.Namespace<br />}<br /><br />func (c *FunctionContext) GetFuncID() string {<br />  return c.instanceConf.funcID<br />}<br /><br />func (c *FunctionContext) GetFuncVersion() string {<br />  return c.instanceConf.funcVersion<br />}<br /><br />func (c *FunctionContext) GetUserConfValue(key string) interface{} {<br />  return c.userConfigs[key]<br />}<br /><br />func (c *FunctionContext) GetUserConfMap() map[string]interface{} {<br />  return c.userConfigs<br />}<br /><br />func (c *FunctionContext) SetCurrentRecord(record pulsar.Message) {<br />  c.record = record<br />}<br /><br />func (c *FunctionContext) GetCurrentRecord() pulsar.Message {<br />  return c.record<br />}<br /><br />func (c *FunctionContext) NewOutputMessage(topic string) pulsar.Producer {<br />  return c.outputMessage(topic)<br />}<br /></code></pre>
<p>The following example uses several methods available via the <code>Context</code> object.</p>
<pre><code class="hljs">import (<br />    &quot;context&quot;<br />    &quot;fmt&quot;<br /><br />    &quot;github.com/apache/pulsar/pulsar-function-go/pf&quot;<br />)<br /><br />func contextFunc(ctx context.Context) {<br />    if fc, ok := pf.FromContext(ctx); ok {<br />        fmt.Printf(&quot;function ID is:%s, &quot;, fc.GetFuncID())<br />        fmt.Printf(&quot;function version is:%s\n&quot;, fc.GetFuncVersion())<br />    }<br />}<br /></code></pre>
<p>查看完整代码，请点击<a href="https://github.com/apache/pulsar/blob/77cf09eafa4f1626a53a1fe2e65dd25f377c1127/pulsar-function-go/examples/contextFunc/contextFunc.go#L29-L34">这里</a>。</p>
</span></div></div></div></div>
<h3><a class="anchor" aria-hidden="true" id="user-config"></a><a href="#user-config" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>User config</h3>
<p>当你使用SDK 运行或者更新函数时，你能够通过<code>--user-config</code>参数传递任意的key/value格式的参数。 Key/values must be specified as JSON. The following function creation command passes a user configured key/value to a function.</p>
<pre><code class="hljs css language-bash">$ bin/pulsar-admin <span class="hljs-built_in">functions</span> create \
  --name word-filter \
  <span class="hljs-comment"># Other function configs</span>
  --user-config <span class="hljs-string">'{"forbidden-word":"rosebud"}'</span>
</code></pre>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3226-tab-3227" class="nav-link active" data-group="group_3226" data-tab="tab-group-3226-content-3227">Java</div><div id="tab-group-3226-tab-3228" class="nav-link" data-group="group_3226" data-tab="tab-group-3226-content-3228">Python</div><div id="tab-group-3226-tab-3229" class="nav-link" data-group="group_3226" data-tab="tab-group-3226-content-3229">Go</div></div><div class="tab-content"><div id="tab-group-3226-content-3227" class="tab-pane active" data-group="group_3226" tabindex="-1"><div><span><p><a href="#context"><code>Context</code></a> object enables you to access key/value pairs provided to Pulsar Functions via the command line (as JSON). The following example passes a key/value pair.</p>
<pre><code class="hljs css language-bash">$ bin/pulsar-admin <span class="hljs-built_in">functions</span> create \<br />  <span class="hljs-comment"># Other function configs</span><br />  --user-config <span class="hljs-string">'{"word-of-the-day":"verdure"}'</span><br /></code></pre>
<p>To access that value in a Java function:</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Context;<br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Function;<br /><span class="hljs-keyword">import</span> org.slf4j.Logger;<br /><br /><span class="hljs-keyword">import</span> java.util.Optional;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserConfigFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Void</span>&gt; </span>{<br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">apply</span><span class="hljs-params">(String input, Context context)</span> </span>{<br />        Logger LOG = context.getLogger();<br />        Optional&lt;String&gt; wotd = context.getUserConfigValue(<span class="hljs-string">"word-of-the-day"</span>);<br />        <span class="hljs-keyword">if</span> (wotd.isPresent()) {<br />            LOG.info(<span class="hljs-string">"The word of the day is {}"</span>, wotd);<br />        } <span class="hljs-keyword">else</span> {<br />            LOG.warn(<span class="hljs-string">"No word of the day provided"</span>);<br />        }<br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br />    }<br />}<br /></code></pre>
<p>The <code>UserConfigFunction</code> function will log the string <code>&quot;The word of the day is verdure&quot;</code> every time the function is invoked (which means every time a message arrives). The <code>word-of-the-day</code> user config will be changed only when the function is updated with a new config value via the command line.</p>
<p>You can also access the entire user config map or set a default value in case no value is present:</p>
<pre><code class="hljs css language-java"><span class="hljs-comment">// Get the whole config map</span><br />Map&lt;String, String&gt; allConfigs = context.getUserConfigMap();<br /><br /><span class="hljs-comment">// Get value or resort to default</span><br />String wotd = context.getUserConfigValueOrDefault(<span class="hljs-string">"word-of-the-day"</span>, <span class="hljs-string">"perspicacious"</span>);<br /></code></pre>
<blockquote>
<p>对于所有传递给 Java function 的键/值对，键<em>和</em>值都是 <code>String</code>。 要将值设置为其他类型，则需要对 <code>String</code> 类型反序列化。</p>
</blockquote>
</span></div></div><div id="tab-group-3226-content-3228" class="tab-pane" data-group="group_3226" tabindex="-1"><div><span><pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> pulsar <span class="hljs-keyword">import</span> Function<br /><br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WordFilter</span><span class="hljs-params">(Function)</span>:</span><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(self, context, input)</span>:</span><br />        forbidden_word = context.user_config()[<span class="hljs-string">"forbidden-word"</span>]<br /><br />        <span class="hljs-comment"># Don't publish the message if it contains the user-supplied</span><br />        <span class="hljs-comment"># forbidden word</span><br />        <span class="hljs-keyword">if</span> forbidden_word <span class="hljs-keyword">in</span> input:<br />            <span class="hljs-keyword">pass</span><br />        <span class="hljs-comment"># Otherwise publish the message</span><br />        <span class="hljs-keyword">else</span>:<br />            <span class="hljs-keyword">return</span> input<br /></code></pre>
<p>The Python SDK <a href="#context"><code>Context</code></a> object enables you to access key/value pairs provided to Pulsar Functions via the command line (as JSON). The following example passes a key/value pair.</p>
<pre><code class="hljs css language-bash">$ bin/pulsar-admin <span class="hljs-built_in">functions</span> create \<br />  <span class="hljs-comment"># Other function configs \</span><br />  --user-config <span class="hljs-string">'{"word-of-the-day":"verdure"}'</span><br /></code></pre>
<p>To access that value in a Python function:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> pulsar <span class="hljs-keyword">import</span> Function<br /><br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserConfigFunction</span><span class="hljs-params">(Function)</span>:</span><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(self, input, context)</span>:</span><br />        logger = context.get_logger()<br />        wotd = context.get_user_config_value(<span class="hljs-string">'word-of-the-day'</span>)<br />        <span class="hljs-keyword">if</span> wotd <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br />            logger.warn(<span class="hljs-string">'No word of the day provided'</span>)<br />        <span class="hljs-keyword">else</span>:<br />            logger.info(<span class="hljs-string">"The word of the day is {0}"</span>.format(wotd))<br /></code></pre>
</span></div></div><div id="tab-group-3226-content-3229" class="tab-pane" data-group="group_3226" tabindex="-1"><div><span><p>Go SDK 中的 <a href="#context"><code>Context</code></a> 对象允许通过命令行来访问提供给Pulsar Functions 的密钥/值对(JSON格式)。 The following example passes a key/value pair.</p>
<pre><code class="hljs css language-bash">$ bin/pulsar-admin <span class="hljs-built_in">functions</span> create \<br />  --go path/to/go/binary<br />  --user-config <span class="hljs-string">'{"word-of-the-day":"lackadaisical"}'</span><br /></code></pre>
<p>要在函数中访问该值：</p>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">contextFunc</span><span class="hljs-params">(ctx context.Context)</span></span> {<br />  fc, ok := pf.FromContext(ctx)<br />  <span class="hljs-keyword">if</span> !ok {<br />    logutil.Fatal(<span class="hljs-string">"Function context is not defined"</span>)<br />  }<br /><br />  wotd := fc.GetUserConfValue(<span class="hljs-string">"word-of-the-day"</span>)<br /><br />  <span class="hljs-keyword">if</span> wotd == <span class="hljs-literal">nil</span> {<br />    logutil.Warn(<span class="hljs-string">"The word of the day is empty"</span>)<br />  } <span class="hljs-keyword">else</span> {<br />    logutil.Infof(<span class="hljs-string">"The word of the day is %s"</span>, wotd.(<span class="hljs-keyword">string</span>))<br />  }<br />}<br /></code></pre>
</span></div></div></div></div>
<h3><a class="anchor" aria-hidden="true" id="logger"></a><a href="#logger" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Logger</h3>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3230-tab-3231" class="nav-link active" data-group="group_3230" data-tab="tab-group-3230-content-3231">Java</div><div id="tab-group-3230-tab-3232" class="nav-link" data-group="group_3230" data-tab="tab-group-3230-content-3232">Python</div><div id="tab-group-3230-tab-3233" class="nav-link" data-group="group_3230" data-tab="tab-group-3230-content-3233">Go</div></div><div class="tab-content"><div id="tab-group-3230-content-3231" class="tab-pane active" data-group="group_3230" tabindex="-1"><div><span><p><a href="https://www.slf4j.org/">SLF4j</a> <a href="https://www.slf4j.org/api/org/apache/log4j/Logger.html"><code>Logger</code></a> object that can be used to produce logs at the chosen log level. The following example logs either a <code>WARNING</code>- or <code>INFO</code>-level log based on whether the incoming string contains the word <code>danger</code>.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Context;<br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Function;<br /><span class="hljs-keyword">import</span> org.slf4j.Logger;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoggingFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Void</span>&gt; </span>{<br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">apply</span><span class="hljs-params">(String input, Context context)</span> </span>{<br />        Logger LOG = context.getLogger();<br />        String messageId = <span class="hljs-keyword">new</span> String(context.getMessageId());<br /><br />        <span class="hljs-keyword">if</span> (input.contains(<span class="hljs-string">"danger"</span>)) {<br />            LOG.warn(<span class="hljs-string">"A warning was received in message {}"</span>, messageId);<br />        } <span class="hljs-keyword">else</span> {<br />            LOG.info(<span class="hljs-string">"Message {} received\nContent: {}"</span>, messageId, input);<br />        }<br /><br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br />    }<br />}<br /></code></pre>
<p>If you want your function to produce logs, you need to specify a log topic when creating or running the function. The following is an example.</p>
<pre><code class="hljs css language-bash">$ bin/pulsar-admin <span class="hljs-built_in">functions</span> create \<br />  --jar my-functions.jar \<br />  --classname my.package.LoggingFunction \<br />  --<span class="hljs-built_in">log</span>-topic persistent://public/default/logging-function-logs \<br />  <span class="hljs-comment"># Other function configs</span><br /></code></pre>
<p>All logs produced by <code>LoggingFunction</code> above can be accessed via the <code>persistent://public/default/logging-function-logs</code> topic.</p>
<h4><a class="anchor" aria-hidden="true" id="自定义函数日志级别"></a><a href="#自定义函数日志级别" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自定义函数日志级别</h4>
<p>此外，您可以使用 XML 文件， <code>functions_log4j2.xml</code>来自定义函数日志级别。 要自定义函数日志级别，请在 Pulsar conf 目录中创建或更新 <code>functions_log4j2.xml</code> (例如，在物理机上是 <code>/etc/pulsar/</code> 目录， 在Kubernetes是 <code>/pulsar/conf</code> 目录) 目录包含如下内容：</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Configuration</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>pulsar-functions-instance<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">monitorInterval</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">monitorInterval</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">Properties</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">Property</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>pulsar.log.appender<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>RollingFile<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Property</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">Property</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>pulsar.log.level<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>debug<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Property</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">Property</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>bk.log.level<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>debug<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Property</span>&gt;</span><br />    <span class="hljs-tag">&lt;/<span class="hljs-name">Properties</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">Appenders</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">Console</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Console<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>SYSTEM_OUT<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">Pattern</span>&gt;</span>%d{ISO8601_OFFSET_DATE_TIME_HHMM} [%t] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">Pattern</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">PatternLayout</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Console</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">RollingFile</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>RollingFile<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">fileName</span>&gt;</span>${sys:pulsar.function.log.dir}/${sys:pulsar.function.log.file}.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileName</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">filePattern</span>&gt;</span>${sys:pulsar.function.log.dir}/${sys:pulsar.function.log.file}-%d{MM-dd-yyyy}-%i.log.gz<span class="hljs-tag">&lt;/<span class="hljs-name">filePattern</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">immediateFlush</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">immediateFlush</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">Pattern</span>&gt;</span>%d{ISO8601_OFFSET_DATE_TIME_HHMM} [%t] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">Pattern</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">PatternLayout</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">Policies</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">TimeBasedTriggeringPolicy</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">interval</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">interval</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">modulate</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">modulate</span>&gt;</span><br />                <span class="hljs-tag">&lt;/<span class="hljs-name">TimeBasedTriggeringPolicy</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">SizeBasedTriggeringPolicy</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>1 GB<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br />                <span class="hljs-tag">&lt;/<span class="hljs-name">SizeBasedTriggeringPolicy</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">CronTriggeringPolicy</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">schedule</span>&gt;</span>0 0 0 * * ?<span class="hljs-tag">&lt;/<span class="hljs-name">schedule</span>&gt;</span><br />                <span class="hljs-tag">&lt;/<span class="hljs-name">CronTriggeringPolicy</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">Policies</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">DefaultRolloverStrategy</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">Delete</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">basePath</span>&gt;</span>${sys:pulsar.function.log.dir}<span class="hljs-tag">&lt;/<span class="hljs-name">basePath</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">maxDepth</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">maxDepth</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">IfFileName</span>&gt;</span><br />                        <span class="hljs-tag">&lt;<span class="hljs-name">glob</span>&gt;</span>*/${sys:pulsar.function.log.file}*log.gz<span class="hljs-tag">&lt;/<span class="hljs-name">glob</span>&gt;</span><br />                    <span class="hljs-tag">&lt;/<span class="hljs-name">IfFileName</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">IfLastModified</span>&gt;</span><br />                        <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>30d<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span><br />                    <span class="hljs-tag">&lt;/<span class="hljs-name">IfLastModified</span>&gt;</span><br />                <span class="hljs-tag">&lt;/<span class="hljs-name">Delete</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">DefaultRolloverStrategy</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">RollingFile</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">RollingRandomAccessFile</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>BkRollingFile<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">fileName</span>&gt;</span>${sys:pulsar.function.log.dir}/${sys:pulsar.function.log.file}.bk<span class="hljs-tag">&lt;/<span class="hljs-name">fileName</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">filePattern</span>&gt;</span>${sys:pulsar.function.log.dir}/${sys:pulsar.function.log.file}.bk-%d{MM-dd-yyyy}-%i.log.gz<span class="hljs-tag">&lt;/<span class="hljs-name">filePattern</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">immediateFlush</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">immediateFlush</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">Pattern</span>&gt;</span>%d{ISO8601_OFFSET_DATE_TIME_HHMM} [%t] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">Pattern</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">PatternLayout</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">Policies</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">TimeBasedTriggeringPolicy</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">interval</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">interval</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">modulate</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">modulate</span>&gt;</span><br />                <span class="hljs-tag">&lt;/<span class="hljs-name">TimeBasedTriggeringPolicy</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">SizeBasedTriggeringPolicy</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>1 GB<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br />                <span class="hljs-tag">&lt;/<span class="hljs-name">SizeBasedTriggeringPolicy</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">CronTriggeringPolicy</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">schedule</span>&gt;</span>0 0 0 * * ?<span class="hljs-tag">&lt;/<span class="hljs-name">schedule</span>&gt;</span><br />                <span class="hljs-tag">&lt;/<span class="hljs-name">CronTriggeringPolicy</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">Policies</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">DefaultRolloverStrategy</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">Delete</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">basePath</span>&gt;</span>${sys:pulsar.function.log.dir}<span class="hljs-tag">&lt;/<span class="hljs-name">basePath</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">maxDepth</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">maxDepth</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">IfFileName</span>&gt;</span><br />                        <span class="hljs-tag">&lt;<span class="hljs-name">glob</span>&gt;</span>*/${sys:pulsar.function.log.file}.bk*log.gz<span class="hljs-tag">&lt;/<span class="hljs-name">glob</span>&gt;</span><br />                    <span class="hljs-tag">&lt;/<span class="hljs-name">IfFileName</span>&gt;</span><br />                    <span class="hljs-tag">&lt;<span class="hljs-name">IfLastModified</span>&gt;</span><br />                        <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>30d<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span><br />                    <span class="hljs-tag">&lt;/<span class="hljs-name">IfLastModified</span>&gt;</span><br />                <span class="hljs-tag">&lt;/<span class="hljs-name">Delete</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">DefaultRolloverStrategy</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">RollingRandomAccessFile</span>&gt;</span><br />    <span class="hljs-tag">&lt;/<span class="hljs-name">Appenders</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">Loggers</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">Logger</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>org.apache.pulsar.functions.runtime.shaded.org.apache.bookkeeper<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>${sys:bk.log.level}<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">additivity</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">additivity</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span>&gt;</span>BkRollingFile<span class="hljs-tag">&lt;/<span class="hljs-name">ref</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">AppenderRef</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">Root</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>${sys:pulsar.log.level}<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span>&gt;</span>${sys:pulsar.log.appender}<span class="hljs-tag">&lt;/<span class="hljs-name">ref</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>${sys:pulsar.log.level}<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">AppenderRef</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Root</span>&gt;</span><br />    <span class="hljs-tag">&lt;/<span class="hljs-name">Loggers</span>&gt;</span><br /><span class="hljs-tag">&lt;/<span class="hljs-name">Configuration</span>&gt;</span><br /></code></pre>
<p>属性设置如下：</p>
<pre><code class="hljs css language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Property</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>pulsar.log.level<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>调试<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Property</span>&gt;</span><br /></code></pre>
<p>传到他们被引用的地方，例如：</p>
<pre><code class="hljs css language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Root</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>${sys:pulsar.log.level}<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span>&gt;</span>${sys:pulsar.log.appender}<span class="hljs-tag">&lt;/<span class="hljs-name">ref</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>${sys:pulsar.log.level}<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">AppenderRef</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Root</span>&gt;</span><br /></code></pre>
<p>在上述示例中，调试级别日志将应用于所有函数日志。 这可能比你想要的更详细。 您可以对不同的类或模块应用不同的日志等级来进行更广泛的选择 例如:</p>
<pre><code class="hljs css language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Logger</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>com.example.module<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>info<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">additivity</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">additivity</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span>&gt;</span>${sys:pulsar.log.appender}<span class="hljs-tag">&lt;/<span class="hljs-name">ref</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">AppenderRef</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span><br /></code></pre>
<p>您也可以更加具体，例如对模块中的一个类应用更详细的日志等级，例如：</p>
<pre><code class="hljs css language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Logger</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>com.example.module.className<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>debug<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">additivity</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">additivity</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span>&gt;</span><br />                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span>&gt;</span>Console<span class="hljs-tag">&lt;/<span class="hljs-name">ref</span>&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">AppenderRef</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span><br /></code></pre>
<p>每一个 <code>&lt;AppenderRef&gt;</code> 值对允许将日志输出到附录定义中指定的目标。</p>
<p>可加性与如果多个 Logger 条目重叠时是否会复制日志消息有关。 要禁用可加性，请指定</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">additivity</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">additivity</span>&gt;</span><br /></code></pre>
<p>正如上文示例。 当一个或多个 <code>&lt;Logger&gt;</code> 条目含有重叠的类或模块时，禁用可加性可以防止日志信息的重复。</p>
<p><code>&lt;AppenderRef&gt;</code> 是在 <code>&lt;Appenders&gt;</code> 章节中定义的，例如：</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Console</span>&gt;</span><br />  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Console<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br />  <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>SYSTEM_OUT<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br />  <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">Pattern</span>&gt;</span>%d{ISO8601_OFFSET_DATE_TIME_HHMM} [%t] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">Pattern</span>&gt;</span><br />  <span class="hljs-tag">&lt;/<span class="hljs-name">PatternLayout</span>&gt;</span><br /><span class="hljs-tag">&lt;/<span class="hljs-name">Console</span>&gt;</span><br /></code></pre>
</span></div></div><div id="tab-group-3230-content-3232" class="tab-pane" data-group="group_3230" tabindex="-1"><div><span><p><code>WARNING</code>- or <code>INFO</code>-level log based on whether the incoming string contains the word <code>danger</code>.</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> pulsar <span class="hljs-keyword">import</span> Function<br /><br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoggingFunction</span><span class="hljs-params">(Function)</span>:</span><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(self, input, context)</span>:</span><br />        logger = context.get_logger()<br />        msg_id = context.get_message_id()<br />        <span class="hljs-keyword">if</span> <span class="hljs-string">'danger'</span> <span class="hljs-keyword">in</span> input:<br />            logger.warn(<span class="hljs-string">"A warning was received in message {0}"</span>.format(context.get_message_id()))<br />        <span class="hljs-keyword">else</span>:<br />            logger.info(<span class="hljs-string">"Message {0} received\nContent: {1}"</span>.format(msg_id, input))<br /></code></pre>
<p>If you want your function to produce logs on a Pulsar topic, you need to specify a <strong>log topic</strong> when creating or running the function. The following is an example.</p>
<pre><code class="hljs css language-bash">$ bin/pulsar-admin <span class="hljs-built_in">functions</span> create \<br />  --py logging_function.py \<br />  --classname logging_function.LoggingFunction \<br />  --<span class="hljs-built_in">log</span>-topic logging-function-logs \<br />  <span class="hljs-comment"># Other function configs</span><br /></code></pre>
<p>All logs produced by <code>LoggingFunction</code> above can be accessed via the <code>logging-function-logs</code> topic. 此外，您可以通过 broker XML文件指定函数日志级别： <a href="#customize-function-log-level">自定义函数日志级别</a>.</p>
</span></div></div><div id="tab-group-3230-content-3233" class="tab-pane" data-group="group_3230" tabindex="-1"><div><span><pre><code class="hljs">import (<br />    &quot;context&quot;<br /><br />    &quot;github.com/apache/pulsar/pulsar-function-go/pf&quot;<br /><br />    log &quot;github.com/apache/pulsar/pulsar-function-go/logutil&quot;<br />)<br /><br />func loggerFunc(ctx context.Context, input []byte) {<br />  if len(input) &lt;= 100 {<br />    log.Infof(&quot;This input has a length of: %d&quot;, len(input))<br />  } else {<br />    log.Warnf(&quot;This input is getting too long! It has {%d} characters&quot;, len(input))<br />  }<br />}<br /><br />func main() {<br />  pf.Start(loggerFunc)<br />}<br /></code></pre>
<p>当你在 GO 函数里面使用<code>logTopic</code>相关函数时，需要导入<code>github.com/apache/pulsar/pulsar-function-go/logutil</code>包，这时你不必使用<code>getLogger()</code> 上下文对象。</p>
<p>此外，您可以通过 broker XML文件指定函数日志级别： <a href="#customize-function-log-level">自定义函数日志级别</a></p>
</span></div></div></div></div>
<h3><a class="anchor" aria-hidden="true" id="pulsar-admin"></a><a href="#pulsar-admin" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pulsar-admin</h3>
<p>Pulsar Functions using the Java SDK has access to the Pulsar admin client, which allows the Pulsar admin client to manage API calls to current Pulsar clusters or external clusters (if <code>external-pulsars</code> is provided).</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3234-tab-3235" class="nav-link active" data-group="group_3234" data-tab="tab-group-3234-content-3235">Java</div></div><div class="tab-content"><div id="tab-group-3234-content-3235" class="tab-pane active" data-group="group_3234" tabindex="-1"><div><span><p>Below is an example of how to use the Pulsar admin client exposed from the Function <code>context</code>.</p>
<pre><code class="hljs">import org.apache.pulsar.client.admin.PulsarAdmin;<br />import org.apache.pulsar.functions.api.Context;<br />import org.apache.pulsar.functions.api.Function;<br /><br />/**<br /> * In this particular example, for every input message,<br /> * the function resets the cursor of the current function's subscription to a<br /> * specified timestamp.<br /> */<br />public class CursorManagementFunction implements Function&lt;String, String&gt; {<br /><br />    @Override<br />    public String process(String input, Context context) throws Exception {<br />        PulsarAdmin adminClient = context.getPulsarAdmin();<br />        if (adminClient != null) {<br />            String topic = context.getCurrentRecord().getTopicName().isPresent() ?<br />                    context.getCurrentRecord().getTopicName().get() : null;<br />            String subName = context.getTenant() + &quot;/&quot; + context.getNamespace() + &quot;/&quot; + context.getFunctionName();<br />            if (topic != null) {<br />                // 1578188166 below is a random-pick timestamp<br />                adminClient.topics().resetCursor(topic, subName, 1578188166);<br />                return &quot;reset cursor successfully&quot;;<br />            }<br />        }<br />        return null;<br />    }<br />}<br /></code></pre>
<p>If you want your function to get access to the Pulsar admin client, you need to enable this feature by setting <code>exposeAdminClientEnabled=true</code> in the <code>functions_worker.yml</code> file. You can test whether this feature is enabled or not using the command <code>pulsar-admin functions localrun</code> with the flag <code>--web-service-url</code>.</p>
<pre><code class="hljs">$ bin/pulsar-admin functions localrun \<br /> --jar my-functions.jar \<br /> --classname my.package.CursorManagementFunction \<br /> --web-service-url http://pulsar-web-service:8080 \<br /> # Other function configs<br /></code></pre>
</span></div></div></div></div>
<h2><a class="anchor" aria-hidden="true" id="metrics"></a><a href="#metrics" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Metrics</h2>
<p>Pulsar Function 允许您部署和管理处理函数，这些函数消费消息并轻松发布消息到 Pulsar 主题。 必须确保运行的连接器在任何时候都是正常运行的。 Pulsar Functions can publish arbitrary metrics to the metrics interface which can be queried.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>如果 Pulsar Function 使用 Java 或 Python 的语言本机接口，则该 function 无法将度量和统计信息发布到 Pulsar。</p>
</blockquote>
<p>你可以通过以下方法监控已部署的 Pulsar Functions：</p>
<ul>
<li><p>检查由 Pulsar 提供的 Metrics。</p>
<p>Pulsar Function 暴露了可以用于监测和收集 <strong>Java、Python, 和Go</strong> 连接器健康状况的 Metrics。 你可以通过关注 <a href="/docs/zh-CN/next/deploy-monitoring">监控</a> 指南来检查这些指标。</p>
<p>函数指标的完整列表见 <a href="/docs/zh-CN/next/reference-metrics#pulsar-functions">这里</a>。</p></li>
<li><p>设置并检查你的自定义 Metrics。</p>
<p>除了由 Pulsar 提供的 Metrics 之外，Pulsar 允许你为 <strong>Java 和 Python</strong> 连接器添加自定义 Metrics。 Function workers 会自动将这些 Metrics 数据收集并发送到 Prometheus，你可以在 Grafana 中查看这些指标。</p></li>
</ul>
<p>下面是如何为 Java 和 Python 函数定制指标的例子。</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3236-tab-3237" class="nav-link active" data-group="group_3236" data-tab="tab-group-3236-content-3237">Java</div><div id="tab-group-3236-tab-3238" class="nav-link" data-group="group_3236" data-tab="tab-group-3236-content-3238">Python</div><div id="tab-group-3236-tab-3239" class="nav-link" data-group="group_3236" data-tab="tab-group-3236-content-3239">Go</div></div><div class="tab-content"><div id="tab-group-3236-content-3237" class="tab-pane active" data-group="group_3236" tabindex="-1"><div><span><p><a href="#context"><code>Context</code></a> object on a per-key basis. For example, you can set a metric for the <code>process-count</code> key and a different metric for the <code>elevens-count</code> key every time the function processes a message.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Context;<br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Function;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MetricRecorderFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">Integer</span>, <span class="hljs-title">Void</span>&gt; </span>{<br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">apply</span><span class="hljs-params">(Integer input, Context context)</span> </span>{<br />        <span class="hljs-comment">// Records the metric 1 every time a message arrives</span><br />        context.recordMetric(<span class="hljs-string">"hit-count"</span>, <span class="hljs-number">1</span>);<br /><br />        <span class="hljs-comment">// Records the metric only if the arriving number equals 11</span><br />        <span class="hljs-keyword">if</span> (input == <span class="hljs-number">11</span>) {<br />            context.recordMetric(<span class="hljs-string">"elevens-count"</span>, <span class="hljs-number">1</span>);<br />        }<br /><br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br />    }<br />}<br /></code></pre>
</span></div></div><div id="tab-group-3236-content-3238" class="tab-pane" data-group="group_3236" tabindex="-1"><div><span><p><a href="#context"><code>Context</code></a> object on a per-key basis. For example, you can set a metric for the <code>process-count</code> key and a different metric for the <code>elevens-count</code> key every time the function processes a message. The following is an example.</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> pulsar <span class="hljs-keyword">import</span> Function<br /><br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MetricRecorderFunction</span><span class="hljs-params">(Function)</span>:</span><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(self, input, context)</span>:</span><br />        context.record_metric(<span class="hljs-string">'hit-count'</span>, <span class="hljs-number">1</span>)<br /><br />        <span class="hljs-keyword">if</span> input == <span class="hljs-number">11</span>:<br />            context.record_metric(<span class="hljs-string">'elevens-count'</span>, <span class="hljs-number">1</span>)<br /></code></pre>
</span></div></div><div id="tab-group-3236-content-3239" class="tab-pane" data-group="group_3236" tabindex="-1"><div><span><p><a href="#context"><code>Context</code></a> 对象使您能够按每个密钥记录计量。 比如，你能够在 Function 每次处理消息时为 <code>process-count</code> 键和 <code>elevens-count</code> 键设置不同的指标：</p>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">metricRecorderFunction</span><span class="hljs-params">(ctx context.Context, in []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">error</span></span> {<br />  inputstr := <span class="hljs-keyword">string</span>(in)<br />  fctx, ok := pf.FromContext(ctx)<br />  <span class="hljs-keyword">if</span> !ok {<br />    <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"get Go Functions Context error"</span>)<br />  }<br />  fctx.RecordMetric(<span class="hljs-string">"hit-count"</span>, <span class="hljs-number">1</span>)<br />  <span class="hljs-keyword">if</span> inputstr == <span class="hljs-string">"eleven"</span> {<br />    fctx.RecordMetric(<span class="hljs-string">"elevens-count"</span>, <span class="hljs-number">1</span>)<br />  }<br />  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br />}<br /></code></pre>
</span></div></div></div></div>
<h2><a class="anchor" aria-hidden="true" id="安全"></a><a href="#安全" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安全</h2>
<p>如果你想在函数里面启用安全机制，首先你需要在<a href="/docs/zh-CN/next/functions-worker">Functions Workers</a>上启用安全机制。 了解更多详情，参考 <a href="/docs/zh-CN/next/functions-worker#security-settings">安全设置</a></p>
<p>Pulsar Function 可以支持如下的 provider:</p>
<ul>
<li>ClearTextSecretsProvider</li>
<li>EnvironmentBasedSecretsProvider</li>
</ul>
<blockquote>
<p>Pulsar Function 默认支持 ClearTextSecretsProvider。</p>
</blockquote>
<p>同时，Pulsar支持两个接口，** SecretsProvider ** 和** SecretsProviderConfigurator **，允许你自定义实现安全 provider。</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3240-tab-3241" class="nav-link active" data-group="group_3240" data-tab="tab-group-3240-content-3241">Java</div><div id="tab-group-3240-tab-3242" class="nav-link" data-group="group_3240" data-tab="tab-group-3240-content-3242">Python</div><div id="tab-group-3240-tab-3243" class="nav-link" data-group="group_3240" data-tab="tab-group-3240-content-3243">Go</div></div><div class="tab-content"><div id="tab-group-3240-content-3241" class="tab-pane active" data-group="group_3240" tabindex="-1"><div><span><p><a href="#context"><code>Context</code></a> 对象获取到安全 provider。 如下所示：</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Context;<br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Function;<br /><span class="hljs-keyword">import</span> org.slf4j.Logger;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetSecretProviderFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Void</span>&gt; </span>{<br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">process</span><span class="hljs-params">(String input, Context context)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br />        Logger LOG = context.getLogger();<br />        String secretProvider = context.getSecret(input);<br /><br />        <span class="hljs-keyword">if</span> (!secretProvider.isEmpty()) {<br />            LOG.info(<span class="hljs-string">"The secret provider is {}"</span>, secretProvider);<br />        } <span class="hljs-keyword">else</span> {<br />            LOG.warn(<span class="hljs-string">"No secret provider"</span>);<br />        }<br /><br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br />    }<br />}<br /></code></pre>
</span></div></div><div id="tab-group-3240-content-3242" class="tab-pane" data-group="group_3240" tabindex="-1"><div><span><p><a href="#context"><code>Context</code></a> 对象获取到安全 provider。 如下所示：</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> pulsar <span class="hljs-keyword">import</span> Function<br /><br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetSecretProviderFunction</span><span class="hljs-params">(Function)</span>:</span><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(self, input, context)</span>:</span><br />        logger = context.get_logger()<br />        secret_provider = context.get_secret(input)<br />        <span class="hljs-keyword">if</span> secret_provider <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br />            logger.warn(<span class="hljs-string">'No secret provider'</span>)<br />        <span class="hljs-keyword">else</span>:<br />            logger.info(<span class="hljs-string">"The secret provider is {0}"</span>.format(secret_provider))<br /></code></pre>
</span></div></div><div id="tab-group-3240-content-3243" class="tab-pane" data-group="group_3240" tabindex="-1"><div><span></span></div></div></div></div>
<h2><a class="anchor" aria-hidden="true" id="state-storage"></a><a href="#state-storage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>State storage</h2>
<p>Pulsar Functions使用 <a href="https://bookkeeper.apache.org">Apache Bookerper</a> 存储状态。 Pulsar installation, including the local standalone installation, includes deployment of BookKeeper bookies.</p>
<p>Since Pulsar 2.1.0 release, Pulsar integrates with Apache BookKeeper <a href="https://docs.google.com/document/d/155xAwWv5IdOitHh1NVMEwCMGgB28M3FyMiQSxEpjE-Y/edit#heading=h.56rbh52koe3f">table service</a> to store the <code>State</code> for functions. For example, a <code>WordCount</code> function can store its <code>counters</code> state into BookKeeper table service via Pulsar Functions State API.</p>
<p>States are key-value pairs, where the key is a string and the value is arbitrary binary data - counters are stored as 64-bit big-endian binary values. Keys are scoped to an individual Pulsar Function, and shared between instances of that function.</p>
<p>在 Pulsar Java Functions 中，你可以调用 Context 对象中的<code>putState</code>，<code>putStateAsync</code>，<code>getState</code>，<code>getStateAsync</code>，<code>incrCounter</code>，<code>incrCounterAsync</code>，<code>getCounter</code>，<code>getCounterAsync</code>和<code>deleteState</code>等方法访问函数中的状态信息。 在 Pulsar Python Functions 中，可以调用 Context 对象中的 <code>putState</code>，<code>getState</code>，<code>incrCounter</code>，<code>getCounter</code>和<code>deleteState</code>等方法访问函数中的状态信息。 You can also manage states using the <a href="#query-state">querystate</a> and <a href="#putstate">putstate</a> options to <code>pulsar-admin functions</code>.</p>
<blockquote>
<p>注意<br>
GoLang中不能使用状态存储。</p>
</blockquote>
<h3><a class="anchor" aria-hidden="true" id="api"></a><a href="#api" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>API</h3>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3244-tab-3245" class="nav-link active" data-group="group_3244" data-tab="tab-group-3244-content-3245">Java</div><div id="tab-group-3244-tab-3246" class="nav-link" data-group="group_3244" data-tab="tab-group-3244-content-3246">Python</div></div><div class="tab-content"><div id="tab-group-3244-content-3245" class="tab-pane active" data-group="group_3244" tabindex="-1"><div><span><p><a href="/docs/zh-CN/next/functions-develop#context">Context</a> object when you are using Java SDK functions.</p>
<h4><a class="anchor" aria-hidden="true" id="incrcounter"></a><a href="#incrcounter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>incrCounter</h4>
<pre><code class="hljs css language-java">    <span class="hljs-comment">/**<br />     * 增加指定 key 引用的 counter 的值<br />     * @参数 key - key 的名称<br />     * @参数 amount - 需要增加的值<br />     */</span><br />    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">incrCounter</span><span class="hljs-params">(String key, <span class="hljs-keyword">long</span> amount)</span></span>;<br /></code></pre>
<p><code>incrCounter</code>为应用提供了根据指定 <code>key</code>增加指定 <code>值</code> 的计数器功能。</p>
<h4><a class="anchor" aria-hidden="true" id="incrcounterasync"></a><a href="#incrcounterasync" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>incrCounterAsync</h4>
<pre><code class="hljs css language-java">     <span class="hljs-comment">/**<br />     * 内置的根据key 增加对应值的分布式计数器<br />     * 不必等待增加操作完成即可返回<br />     *<br />     * <span class="hljs-doctag">@param</span> key The name of the key<br />     * <span class="hljs-doctag">@param</span> amount The amount to be incremented<br />     */</span><br />    <span class="hljs-function">CompletableFuture&lt;Void&gt; <span class="hljs-title">incrCounterAsync</span><span class="hljs-params">(String key, <span class="hljs-keyword">long</span> amount)</span></span>;<br /></code></pre>
<p><code>incrCounterAsync</code>为应用提供了异步的根据指定 <code>key</code> 增加指定 <code>值</code> 的计数器功能。</p>
<h4><a class="anchor" aria-hidden="true" id="getcounter"></a><a href="#getcounter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>getCounter</h4>
<pre><code class="hljs css language-java">    <span class="hljs-comment">/**<br />     * Retrieve the counter value for the key.<br />     *<br />     * <span class="hljs-doctag">@param</span> key name of the key<br />     * <span class="hljs-doctag">@return</span> the amount of the counter value for this key<br />     */</span><br />    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getCounter</span><span class="hljs-params">(String key)</span></span>;<br /></code></pre>
<p>应用可以使用<code>getCounter</code>，根据<code>key</code>获取到<code>incrCounter</code>方法累加后的计数器的值。</p>
<p>Except the <code>counter</code> API, Pulsar also exposes a general key/value API for functions to store general key/value state.</p>
<h4><a class="anchor" aria-hidden="true" id="getcounterasync"></a><a href="#getcounterasync" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>getCounterAsync</h4>
<pre><code class="hljs css language-java">     <span class="hljs-comment">/**<br />     * 根据 key 获取计数器的值, 但不必等待<br />     * 操作完成即可返回<br />     *<br />     * <span class="hljs-doctag">@param</span> key name of the key<br />     * <span class="hljs-doctag">@return</span> the amount of the counter value for this key<br />     */</span><br />    <span class="hljs-function">CompletableFuture&lt;Long&gt; <span class="hljs-title">getCounterAsync</span><span class="hljs-params">(String key)</span></span>;<br /></code></pre>
<p>应用可以使用<code>getCounter</code>，根据 <code>key</code> 异步的获取到<code>incrCounter</code> 方法累加后的计数器的值。</p>
<h4><a class="anchor" aria-hidden="true" id="putstate"></a><a href="#putstate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>putState</h4>
<pre><code class="hljs css language-java">    <span class="hljs-comment">/**<br />     * Update the state value for the key.<br />     *<br />     * <span class="hljs-doctag">@param</span> key name of the key<br />     * <span class="hljs-doctag">@param</span> value state value of the key<br />     */</span><br />    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putState</span><span class="hljs-params">(String key, ByteBuffer value)</span></span>;<br /></code></pre>
<h4><a class="anchor" aria-hidden="true" id="putstateasync"></a><a href="#putstateasync" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>putStateAsync</h4>
<pre><code class="hljs css language-java">    <span class="hljs-comment">/**<br />     * 根据 Key 更新状态的值，但不需要等待操作完成即可返回<br />     *<br />     * <span class="hljs-doctag">@param</span> key name of the key<br />     * <span class="hljs-doctag">@param</span> value state value of the key<br />     */</span><br />    <span class="hljs-function">CompletableFuture&lt;Void&gt; <span class="hljs-title">putStateAsync</span><span class="hljs-params">(String key, ByteBuffer value)</span></span>;<br /></code></pre>
<p>应用能够使用<code>putStateAsync</code>方法异步的根据<code>key</code>去更新其状态。</p>
<h4><a class="anchor" aria-hidden="true" id="getstate"></a><a href="#getstate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>getState</h4>
<pre><code class="hljs css language-java">    <span class="hljs-comment">/**<br />     * Retrieve the state value for the key.<br />     *<br />     * <span class="hljs-doctag">@param</span> key name of the key<br />     * <span class="hljs-doctag">@return</span> the state value for the key.<br />     */</span><br />    <span class="hljs-function">ByteBuffer <span class="hljs-title">getState</span><span class="hljs-params">(String key)</span></span>;<br /></code></pre>
<h4><a class="anchor" aria-hidden="true" id="getstateasync"></a><a href="#getstateasync" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>getStateAsync</h4>
<pre><code class="hljs css language-java">    <span class="hljs-comment">/**<br />     * 获取到 key 的状态值, 但是不必等到操作完成即可返回。<br />     *<br />     * <span class="hljs-doctag">@param</span> key的名称<br />     * <span class="hljs-doctag">@return</span>  key的状态值<br />     */</span><br />    <span class="hljs-function">CompletableFuture&lt;ByteBuffer&gt; <span class="hljs-title">getStateAsync</span><span class="hljs-params">(String key)</span></span>;<br /></code></pre>
<p>应用能够使用<code>getStateAsync</code>异步的根据<code>key</code>获取到其状态值。</p>
<h4><a class="anchor" aria-hidden="true" id="deletestate"></a><a href="#deletestate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deleteState</h4>
<pre><code class="hljs css language-java">    <span class="hljs-comment">/**<br />     * Delete the state value for the key.<br />     *<br />     * <span class="hljs-doctag">@param</span> key   name of the key<br />     */</span><br /></code></pre>
<p>Counters and binary values share the same keyspace, so this deletes either type.</p>
</span></div></div><div id="tab-group-3244-content-3246" class="tab-pane" data-group="group_3244" tabindex="-1"><div><span><p><a href="#context">Context</a> object when you are using Python SDK functions.</p>
<h4><a class="anchor" aria-hidden="true" id="incr_counter"></a><a href="#incr_counter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>incr_counter</h4>
<pre><code class="hljs css language-python">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">incr_counter</span><span class="hljs-params">(self, key, amount)</span>:</span><br />    <span class="hljs-string">"""incr the counter of a given key in the managed state"""</span><br /></code></pre>
<p>Application can use <code>incr_counter</code> to change the counter of a given <code>key</code> by the given <code>amount</code>. If the <code>key</code> does not exist, a new key is created.</p>
<h4><a class="anchor" aria-hidden="true" id="get_counter"></a><a href="#get_counter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>get_counter</h4>
<pre><code class="hljs css language-python">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_counter</span><span class="hljs-params">(self, key)</span>:</span><br />    <span class="hljs-string">"""get the counter of a given key in the managed state"""</span><br /></code></pre>
<p>Application can use <code>get_counter</code> to retrieve the counter of a given <code>key</code> mutated by <code>incrCounter</code>.</p>
<p>Except the <code>counter</code> API, Pulsar also exposes a general key/value API for functions to store general key/value state.</p>
<h4><a class="anchor" aria-hidden="true" id="put_state"></a><a href="#put_state" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>put_state</h4>
<pre><code class="hljs css language-python">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put_state</span><span class="hljs-params">(self, key, value)</span>:</span><br />    <span class="hljs-string">"""update the value of a given key in the managed state"""</span><br /></code></pre>
<p>The key is a string, and the value is arbitrary binary data.</p>
<h4><a class="anchor" aria-hidden="true" id="get_state"></a><a href="#get_state" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>get_state</h4>
<pre><code class="hljs css language-python">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_state</span><span class="hljs-params">(self, key)</span>:</span><br />    <span class="hljs-string">"""get the value of a given key in the managed state"""</span><br /></code></pre>
<h4><a class="anchor" aria-hidden="true" id="del_counter"></a><a href="#del_counter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>del_counter</h4>
<pre><code class="hljs css language-python">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">del_counter</span><span class="hljs-params">(self, key)</span>:</span><br />    <span class="hljs-string">"""delete the counter of a given key in the managed state"""</span><br /></code></pre>
<p>Counters and binary values share the same keyspace, so this deletes either type.</p>
</span></div></div></div></div>
<h3><a class="anchor" aria-hidden="true" id="query-state"></a><a href="#query-state" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Query State</h3>
<p>A Pulsar Function can use the <a href="#api">State API</a> for storing state into Pulsar's state storage and retrieving state back from Pulsar's state storage. Additionally Pulsar also provides CLI commands for querying its state.</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> bin/pulsar-admin <span class="hljs-built_in">functions</span> querystate \</span>
    --tenant &lt;tenant&gt; \
    --namespace &lt;namespace&gt; \
    --name &lt;function-name&gt; \
    --state-storage-url &lt;bookkeeper-service-url&gt; \
    --key &lt;state-key&gt; \
    [---watch]
</code></pre>
<p>If <code>--watch</code> is specified, the CLI will watch the value of the provided <code>state-key</code>.</p>
<h3><a class="anchor" aria-hidden="true" id="示例-1"></a><a href="#示例-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>示例</h3>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-3247-tab-3248" class="nav-link active" data-group="group_3247" data-tab="tab-group-3247-content-3248">Java</div><div id="tab-group-3247-tab-3249" class="nav-link" data-group="group_3247" data-tab="tab-group-3247-content-3249">Python</div></div><div class="tab-content"><div id="tab-group-3247-content-3248" class="tab-pane active" data-group="group_3247" tabindex="-1"><div><span><p><a href="https://github.com/apache/pulsar/tree/master//pulsar-functions/java-examples/src/main/java/org/apache/pulsar/functions/api/examples/WordCountFunction.java"><code>WordCountFunction</code></a>
 is a very good example demonstrating on how Application can easily store <code>state</code> in Pulsar Functions.</p>
<pre><code class="hljs css language-java"><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Context;<br /><span class="hljs-keyword">import</span> org.apache.pulsar.functions.api.Function;<br /><br /><span class="hljs-keyword">import</span> java.util.Arrays;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WordCountFunction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Void</span>&gt; </span>{<br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">process</span><span class="hljs-params">(String input, Context context)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br />        Arrays.asList(input.split(<span class="hljs-string">"\\."</span>)).forEach(word -&gt; context.incrCounter(word, <span class="hljs-number">1</span>));<br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br />    }<br />}<br /></code></pre>
<p>The logic of this <code>WordCount</code> function is pretty simple and straightforward:</p>
<ol>
<li>The function first splits the received <code>String</code> into multiple words using regex <code>\\.</code>.</li>
<li>For each <code>word</code>, the function increments the corresponding <code>counter</code> by 1 (via <code>incrCounter(key, amount)</code>).</li>
</ol>
</span></div></div><div id="tab-group-3247-content-3249" class="tab-pane" data-group="group_3247" tabindex="-1"><div><span><pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> pulsar <span class="hljs-keyword">import</span> Function<br /><br /><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WordCount</span><span class="hljs-params">(Function)</span>:</span><br />    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(self, item, context)</span>:</span><br />        <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> item.split():<br />            context.incr_counter(word, <span class="hljs-number">1</span>)<br /></code></pre>
<p>The logic of this <code>WordCount</code> function is pretty simple and straightforward:</p>
<ol>
<li>该 function 首先将接收到的字符串拆分为多个单词。</li>
<li>对于每个 <code>word</code>，该 function 将相应的 <code>counter</code> 递增1(通过 <code>incr_counter(key, amount)</code>)。</li>
</ol>
</span></div></div></div></div></span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/zh-CN/next/functions-worker"><span class="arrow-prev">← </span><span>设置：Pulsar Functions Worker</span></a><a class="docs-next button" href="/docs/zh-CN/next/functions-package"><span>如何打包</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#可用-api">可用 API</a><ul class="toc-headings"><li><a href="#语言原生接口">语言原生接口</a></li><li><a href="#适用于-javapythongo-的-pulsar-function-sdk">适用于 Java/Python/Go 的 Pulsar Function SDK</a></li><li><a href="#java-的-pulsar-扩展-function-sdk">Java 的 Pulsar 扩展 Function SDK</a></li></ul></li><li><a href="#schema-registry">Schema registry</a></li><li><a href="#serde">SerDe</a><ul class="toc-headings"><li><a href="#示例">示例</a></li></ul></li><li><a href="#上下文context">上下文(Context)</a><ul class="toc-headings"><li><a href="#user-config">User config</a></li><li><a href="#logger">Logger</a></li><li><a href="#pulsar-admin">Pulsar-admin</a></li></ul></li><li><a href="#metrics">Metrics</a></li><li><a href="#安全">安全</a></li><li><a href="#state-storage">State storage</a><ul class="toc-headings"><li><a href="#api">API</a></li><li><a href="#query-state">Query State</a></li><li><a href="#示例-1">示例</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2022 The Apache Software Foundation. All Rights Reserved. Apache, Apache Pulsar and the Apache feather logo are trademarks of The Apache Software Foundation.</section><span><script>
      const community = document.querySelector("a[href='#community']").parentNode;
      const communityMenu =
        '<li>' +
        '<a id="community-menu" href="#">Community <span style="font-size: 0.75em">&nbsp;▼</span></a>' +
        '<div id="community-dropdown" class="hide">' +
          '<ul id="community-dropdown-items">' +
            '<li><a href="/zh-CN/contact">Contact</a></li>' +
            '<li><a href="/zh-CN/contributing">Contributing</a></li>' +
            '<li><a href="/zh-CN/coding-guide">Coding guide</a></li>' +
            '<li><a href="/zh-CN/events">Events</a></li>' +
            '<li><a href="https://twitter.com/Apache_Pulsar" target="_blank">Twitter &#x2750</a></li>' +
            '<li><a href="https://github.com/apache/pulsar/wiki" target="_blank">Wiki &#x2750</a></li>' +
            '<li><a href="https://github.com/apache/pulsar/issues" target="_blank">Issue tracking &#x2750</a></li>' +
            '<li><a href="https://pulsar-summit.org/" target="_blank">Pulsar Summit &#x2750</a></li>' +
            '<li>&nbsp;</li>' +
            '<li><a href="/zh-CN/resources">Resources</a></li>' +
            '<li><a href="/zh-CN/team">Team</a></li>' +
            '<li><a href="/zh-CN/powered-by">Powered By</a></li>' +
          '</ul>' +
        '</div>' +
        '</li>';

      community.innerHTML = communityMenu;

      const communityMenuItem = document.getElementById("community-menu");
      const communityDropDown = document.getElementById("community-dropdown");
      communityMenuItem.addEventListener("click", function(event) {
        event.preventDefault();

        if (communityDropDown.className == 'hide') {
          communityDropDown.className = 'visible';
        } else {
          communityDropDown.className = 'hide';
        }
      });
    </script></span></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'd226a455cecdd4bc18a554c1b47e5b52',
                indexName: 'apache_pulsar',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["language:zh-CN","version:next"]}
              });
            </script></body></html>