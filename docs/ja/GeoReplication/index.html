<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript">
  var shiftWindow = function() { scrollBy(0, -108) };
  window.addEventListener("hashchange", shiftWindow);
  window.addEventListener("pageshow", shiftWindow);
  function load() { if (window.location.hash) shiftWindow(); }
</script>

<title>Pulsar ジオレプリケーション</title>

<link rel="stylesheet" href="/incubator-pulsar/css/style.css">
<link rel="shortcut icon" href="/incubator-pulsar/img/favicon.ico">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="/incubator-pulsar/js/jquery.tocify.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

<script async src="/incubator-pulsar/js/main.js"></script>

  </head>
  <body class="body">
    <main class="main">
      <header class="container-fluid sticky-top top-nav">
        <nav class="navbar navbar-default navbar-toggleable-xl container">
  <a class="navbar-brand" href="/incubator-pulsar/">
    <img src="/incubator-pulsar/img/pulsar-logo.png">
  </a>

  <div class="collapse navbar-collapse justify-content-end" id="nav-content">
    <ul class="nav navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/incubator-pulsar/docs/1.18">Documentation</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/incubator-pulsar/docs/1.18/getting-started/Clients">Client libraries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/incubator-pulsar/ja"><img class="japan-flag" src="/incubator-pulsar/img/japan-flag.svg"></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/yahoo/pulsar"><i class="fa fa-github fa-lg"></i></a>
      </li>
      <li class="nav-item version">
        <a class="nav-link">Pulsar 1.17.5</a>
      </li>
    </ul>
  </div>
</nav>

      </header>

      <main>
        <div class="docs-container container-fluid">
  <div class="row">
    <nav class="sidebar-nav col-sm-3 col-lg-3">
      <ul class="sidebar">
  
  <section class="sidebar-group">
    <h4>Getting started</h4>
    <ul>
      
      
      
      
      <li><a href="/incubator-pulsar/ja/GettingStarted/"><i class="fa fa-file-text-o"></i>Pulsar入門</a></li>
      
      
      
      
      
      <li><a href="/incubator-pulsar/ja/Architecture/"><i class="fa fa-file-text-o"></i>システム概要</a></li>
      
      
    </ul>
  </section>
  
  <section class="sidebar-group">
    <h4>運用管理</h4>
    <ul>
      
      
      
      
      <li><a href="/incubator-pulsar/ja/ClusterSetup/"><i class="fa fa-file-text-o"></i>クラスタのセットアップ</a></li>
      
      
      
      
      
      <li><a href="/incubator-pulsar/ja/AdminTools/"><i class="fa fa-file-text-o"></i>adminツールとAPI</a></li>
      
      
    </ul>
  </section>
  
</ul>

    </nav>

    <article class="col-sm-7 col-lg-7">
      <section class="docs-header">
        <h1 class="docs-title">Pulsar ジオレプリケーション</h1>
        
        <hr />
      </section>

      <section class="content">
        <h2 id="レプリケーションモデル">レプリケーションモデル</h2>

<p>複数のクラスタを設定されたプロパティはそれらのクラスタ間においてレプリケーションを有効にできます。レプリケーションはネームスペースレベルで利用者が直接管理します。グローバルネームスペース内のすべてのトピックがレプリケートされます。利用者はグローバルネームスペースを作成し、2つあるいはそれ以上のクラスタ間でレプリケートされるよう設定します。そのネームスペース内のトピックに発行されたすべてのメッセージは、設定したすべてのクラスタにレプリケートされます。</p>

<p>メッセージはまずローカルクラスタに永続化され、そして非同期にリモートクラスタに転送されます。</p>

<p>通常時、接続の問題がない場合、メッセージはローカルのConsumerに配信されると同時に即座にレプリケートされます。一般的にend-to-endの配送にかかるレイテンシはリモートの地域間のネットワーク<em>RTT</em> (Round Trip Time; 往復遅延時間) によって定義されます。</p>

<p>アプリケーションはリモートクラスタが到達不可能 (例. ネットワークが分離されている状況) であっても、ProducerとConsumerをどのクラスタにも作ることができます。</p>

<p>サブスクリプションはそれが作成されたクラスタ内に閉じており、クラスタ間で転送されることはありません。</p>

<p><img src="../../img/GeoReplication.png" alt="Replication Diagram" /></p>

<p>上の例ではトピックは<strong><em>Cluster-A</em></strong>, <strong><em>Cluster-B</em></strong>, <strong><em>Cluster-C</em></strong>という3つのクラスタにレプリケートされます。</p>

<p>任意のクラスタにproduceされたすべてのメッセージはすべてのクラスタのすべてのサブスクリプションに配送されます。この例では、<strong><em>C1</em></strong>と<strong><em>C2</em></strong>の両方は<strong><em>P1</em></strong>, <strong><em>P2</em></strong>, <strong><em>P3</em></strong>に発行されたすべてのメッセージを受け取ります。Producerごとのメッセージの順序は保証されます。</p>

<h2 id="レプリケーション設定">レプリケーション設定</h2>

<h3 id="プロパティへの権限付与">プロパティへの権限付与</h3>

<p>クラスタ間のレプリケーションを行うため、テナントにクラスタを利用する権限が必要です。この権限はプロパティ作成時に付与するか、後で更新できます。</p>

<p>作成時、利用したいクラスタを指定します:</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>bin/pulsar-admin properties create my-property    <span class="se">\</span>
        --admin-roles my-admin-role                 <span class="se">\</span>
        --allowed-clusters us-west,us-east,us-cent
</code></pre>
</div>

<p>既存のプロパティの権限を更新する際は、<code class="highlighter-rouge">create</code>の代わりに<code class="highlighter-rouge">update</code>を使用します。</p>

<h3 id="グローバルネームスペースの作成">グローバルネームスペースの作成</h3>

<p>レプリケーションを利用するためには<em>グローバル</em>トピック、すなわちグローバルネームスペースに属し、特定のクラスタに紐付けられていないトピックが必要となります。</p>

<p>グローバルネームスペースは<strong><em>global</em></strong>仮想クラスタの中に作成される必要があります:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>bin/pulsar-admin namespaces create my-property/global/my-namespace
</code></pre>
</div>

<p>最初はネームスペースはどのクラスタにも紐付けられていません。</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>bin/pulsar-admin namespaces <span class="nb">set</span>-clusters
                          my-property/global/my-namespace <span class="se">\</span>
                          --clusters us-west,us-east,us-cent
</code></pre>
</div>

<p>ネームスペースのレプリケーション先クラスタは進行中のトラフィックを中断することなく、いつでも変更が可能です。設定が変更されると即座にすべてのクラスタのレプリケーションチャンネルはセットアップあるいは停止されます。</p>

<h3 id="グローバルトピックの利用">グローバルトピックの利用</h3>

<p>この時点でProducerまたはConsumerを単に作成すれば、自動的にグローバルトピックを作成できます。</p>

<p>一般的に各アプリケーションはローカルクラスタの<code class="highlighter-rouge">serviceUrl</code>を使用します。</p>

<h4 id="選択的レプリケーション">選択的レプリケーション</h4>

<p>デフォルトでは、メッセージはネームスペースに設定されているすべてのクラスタにレプリケートされます。メッセージのレプリケーションリストを指定することでレプリケーション先を制限できます。するとメッセージは一部のクラスタのみにレプリケートされます。</p>

<p>Java APIでは、これは<code class="highlighter-rouge">MessageBuilder</code>において行われます:</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">...</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">restrictReplicationTo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">restrictReplicationTo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"us-west"</span><span class="o">);</span>
<span class="n">restrictReplicationTo</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"us-east"</span><span class="o">);</span>

<span class="n">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">MessageBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
              <span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="s">"my-payload"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">())</span>
              <span class="o">.</span><span class="na">setReplicationClusters</span><span class="o">(</span><span class="n">restrictReplicationTo</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</code></pre>
</div>

<h4 id="トピックの統計情報">トピックの統計情報</h4>

<p>グローバルトピックの統計情報は通常のトピックと同じAPIとツールによって取得できます:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>bin/pulsar-admin persistent stats persistent://my-property/global/my-namespace/my-topic
</code></pre>
</div>

<p>各クラスタは入力/出力のレプリケーションのレートおよびバックログを含む自身の統計情報をレポートします。</p>

<h4 id="グローバルトピックの削除">グローバルトピックの削除</h4>

<p>複数の地域に存在するグローバルトピックを直接削除はできません。削除の処理は自動的に行われるトピックのガベージコレクションに依存します。</p>

<p>Pulsarではトピックがもう利用されていないとき、すなわちProducerまたはConsumerが一つも接続しておらず、<strong><em>かつ</em></strong>サブスクリプションが存在しないときに自動的に削除されます。</p>

<p>グローバルトピックにおいて、各地域はフォールトトレラントな仕組みを使用して、そのトピックをいつローカルで削除するのが安全かを判断します。</p>

<p>グローバルトピックを削除するために、そのトピックのすべてのProducerとConsumerを閉じ、すべてのレプリケーション先クラスタにおけるローカルなサブスクリプションを削除します。Pulsarがシステム内に有効なサブスクリプションが残っていないと判断すると、そのトピックをガベージコレクトします。</p>

      </section>
    </article>

    <nav class="toc-bar col-sm-2 col-lg-2">
      <div id="toc"></div>
    </nav>
  </div>
</div>

      </main>
    </main>

    <footer class="footer">
  <div class="container">
    <p class="text-center">&copy; Apache Foundation 2017</p>
  </div>
</footer>


    
  </body>
</html>
