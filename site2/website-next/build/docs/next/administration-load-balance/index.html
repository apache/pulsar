<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Pulsar Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Pulsar Blog Atom Feed"><title data-react-helmet="true">Pulsar load balance | Apache Pulsar</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://pulsar.apache.com/docs/next/administration-load-balance"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Pulsar load balance | Apache Pulsar"><meta data-react-helmet="true" name="description" content="Load balance across Pulsar brokers"><meta data-react-helmet="true" property="og:description" content="Load balance across Pulsar brokers"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pulsar.apache.com/docs/next/administration-load-balance"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.com/docs/next/administration-load-balance" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.com/docs/next/administration-load-balance" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.4a6b6be2.css">
<link rel="preload" href="/assets/js/runtime~main.668ae9d7.js" as="script">
<link rel="preload" href="/assets/js/main.3d3de418.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache Pulsar" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Apache Pulsar" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title"></b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/next/">Docs</a><a class="navbar__item navbar__link" href="/versions">Versions</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/apache/pulsar" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/docs">Version</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/">2.8.0</a></li><li><a class="dropdown__link" href="/docs/2.7.3/">2.7.3</a></li><li><a class="dropdown__link" href="/docs/2.7.2/">2.7.2</a></li><li><a class="dropdown__link" href="/docs/2.7.1/">2.7.1</a></li><li><a class="dropdown__link" href="/docs/2.7.0/">2.7.0</a></li><li><a class="dropdown__link" href="/docs/2.6.4/">2.6.4</a></li><li><a class="dropdown__link" href="/docs/2.6.3/">2.6.3</a></li><li><a class="dropdown__link" href="/docs/2.6.2/">2.6.2</a></li><li><a class="dropdown__link" href="/docs/2.2.0/">2.2.0</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Get Started</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts and Architecture</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pulsar Schema</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pulsar Functions</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pulsar IO</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pulsar SQL</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tiered Storage</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Transactions</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes (Helm)</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deployment</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Administration</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/administration-zk-bk">ZooKeeper and BookKeeper</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/administration-geo">Geo-replication</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/administration-pulsar-manager">Pulsar Manager</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/administration-stats">Pulsar statistics</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/next/administration-load-balance">Load balance</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/administration-proxy">Pulsar proxy</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/administration-upgrade">Upgrade</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/administration-isolation">Pulsar isolation</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Security</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Performance</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Client Libraries</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Admin API</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Adaptors</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Cookbooks</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Reference</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for Apache Pulsar <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/administration-load-balance">latest version</a></b> (2.8.0).</div></div><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: Next</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Pulsar load balance</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="load-balance-across-pulsar-brokers"></a>Load balance across Pulsar brokers<a class="hash-link" href="#load-balance-across-pulsar-brokers" title="Direct link to heading">#</a></h2><p>Pulsar is an horizontally scalable messaging system, so the traffic in a logical cluster must be balanced across all the available Pulsar brokers as evenly as possible, which is a core requirement.</p><p>You can use multiple settings and tools to control the traffic distribution which require a bit of context to understand how the traffic is managed in Pulsar. Though, in most cases, the core requirement mentioned above is true out of the box and you should not worry about it. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="pulsar-load-manager-architecture"></a>Pulsar load manager architecture<a class="hash-link" href="#pulsar-load-manager-architecture" title="Direct link to heading">#</a></h2><p>The following part introduces the basic architecture of the Pulsar load manager.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="assign-topics-to-brokers-dynamically"></a>Assign topics to brokers dynamically<a class="hash-link" href="#assign-topics-to-brokers-dynamically" title="Direct link to heading">#</a></h3><p>Topics are dynamically assigned to brokers based on the load conditions of all brokers in the cluster.</p><p>When a client starts using new topics that are not assigned to any broker, a process is triggered to choose the best suited broker to acquire ownership of these topics according to the load conditions. </p><p>In case of partitioned topics, different partitions are assigned to different brokers. Here &quot;topic&quot; means either a non-partitioned topic or one partition of a topic.</p><p>The assignment is &quot;dynamic&quot; because the assignment changes quickly. For example, if the broker owning the topic crashes, the topic is reassigned immediately to another broker. Another scenario is that the broker owning the topic becomes overloaded. In this case, the topic is reassigned to a less loaded broker.</p><p>The stateless nature of brokers makes the dynamic assignment possible, so you can quickly expand or shrink the cluster based on usage.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="assignment-granularity"></a>Assignment granularity<a class="hash-link" href="#assignment-granularity" title="Direct link to heading">#</a></h4><p>The assignment of topics or partitions to brokers is not done at the topics or partitions level, but done at the Bundle level (a higher level). The reason is to amortize the amount of information that you need to keep track. Based on CPU, memory, traffic load and other indexes, topics are assigned to a particular broker dynamically. </p><p>Instead of individual topic or partition assignment, each broker takes ownership of a subset of the topics for a namespace. This subset is called a &quot;<em>bundle</em>&quot; and effectively this subset is a sharding mechanism.</p><p>The namespace is the &quot;administrative&quot; unit: many config knobs or operations are done at the namespace level.</p><p>For assignment, a namespaces is sharded into a list of &quot;bundles&quot;, with each bundle comprising a portion of overall hash range of the namespace.</p><p>Topics are assigned to a particular bundle by taking the hash of the topic name and checking in which bundle the hash falls into.</p><p>Each bundle is independent of the others and thus is independently assigned to different brokers.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-namespaces-and-bundles"></a>Create namespaces and bundles<a class="hash-link" href="#create-namespaces-and-bundles" title="Direct link to heading">#</a></h3><p>When you create a new namespace, the new namespace sets to use the default number of bundles. You can set this in <code>conf/broker.conf</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly properties"><pre tabindex="0" class="prism-code language-properties codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># When a namespace is created without specifying the number of bundle, this</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># value will be used as the default</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">defaultNumberOfNamespaceBundles=4</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You can either change the system default, or override it when you create a new namespace:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ bin/pulsar-admin namespaces create my-tenant/my-namespace --clusters us-west --bundles </span><span class="token number">16</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With this command, you create a namespace with 16 initial bundles. Therefore the topics for this namespaces can immediately be spread across up to 16 brokers.</p><p>In general, if you know the expected traffic and number of topics in advance, you had better start with a reasonable number of bundles instead of waiting for the system to auto-correct the distribution.</p><p>On the same note, it is beneficial to start with more bundles than the number of brokers, because of the hashing nature of the distribution of topics into bundles. For example, for a namespace with 1000 topics, using something like 64 bundles achieves a good distribution of traffic across 16 brokers.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="unload-topics-and-bundles"></a>Unload topics and bundles<a class="hash-link" href="#unload-topics-and-bundles" title="Direct link to heading">#</a></h3><p>You can &quot;unload&quot; a topic in Pulsar with admin operation. Unloading means to close the topics, release ownership and reassign the topics to a new broker, based on current load.</p><p>When unloading happens, the client experiences a small latency blip, typically in the order of tens of milliseconds, while the topic is reassigned.</p><p>Unloading is the mechanism that the load-manager uses to perform the load shedding, but you can also trigger the unloading manually, for example to correct the assignments and redistribute traffic even before having any broker overloaded.</p><p>Unloading a topic has no effect on the assignment, but just closes and reopens the particular topic:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pulsar-admin topics unload persistent://tenant/namespace/topic</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To unload all topics for a namespace and trigger reassignments:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pulsar-admin namespaces unload tenant/namespace</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="split-namespace-bundles"></a>Split namespace bundles<a class="hash-link" href="#split-namespace-bundles" title="Direct link to heading">#</a></h3><p>Since the load for the topics in a bundle might change over time and predicting the load might be hard, bundle split is designed to deal with these issues. The broker splits a bundle into two and the new smaller bundles can be reassigned to different brokers.</p><p>The splitting is based on some tunable thresholds. Any existing bundle that exceeds any of the threshold is a candidate to be split. By default the newly split bundles are also immediately offloaded to other brokers, to facilitate the traffic distribution. </p><p>You can split namespace bundles in two ways, by setting <code>supportedNamespaceBundleSplitAlgorithms</code> to <code>range_equally_divide</code> or <code>topic_count_equally_divide</code> in <code>broker.conf</code> file. The former splits the bundle into two parts with the same hash range size; the latter splits the bundle into two parts with the same number of topics. You can also configure other parameters for namespace bundles.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly properties"><pre tabindex="0" class="prism-code language-properties codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># enable/disable namespace bundle auto split</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerAutoBundleSplitEnabled=true</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># enable/disable automatic unloading of split bundles</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerAutoUnloadSplitBundlesEnabled=true</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># maximum topics in a bundle, otherwise bundle split will be triggered</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerNamespaceBundleMaxTopics=1000</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># maximum sessions (producers + consumers) in a bundle, otherwise bundle split will be triggered</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerNamespaceBundleMaxSessions=1000</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># maximum msgRate (in + out) in a bundle, otherwise bundle split will be triggered</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerNamespaceBundleMaxMsgRate=30000</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># maximum bandwidth (in + out) in a bundle, otherwise bundle split will be triggered</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerNamespaceBundleMaxBandwidthMbytes=100</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># maximum number of bundles in a namespace (for auto-split)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerNamespaceMaximumBundles=128</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="shed-load-automatically"></a>Shed load automatically<a class="hash-link" href="#shed-load-automatically" title="Direct link to heading">#</a></h3><p>The support for automatic load shedding is available in the load manager of Pulsar. This means that whenever the system recognizes a particular broker is overloaded, the system forces some traffic to be reassigned to less loaded brokers.</p><p>When a broker is identified as overloaded, the broker forces to &quot;unload&quot; a subset of the bundles, the ones with higher traffic, that make up for the overload percentage.</p><p>For example, the default threshold is 85% and if a broker is over quota at 95% CPU usage, then the broker unloads the percent difference plus a 5% margin: <code>(95% - 85%) + 5% = 15%</code>.</p><p>Given the selection of bundles to offload is based on traffic (as a proxy measure for cpu, network and memory), broker unloads bundles for at least 15% of traffic.</p><p>The automatic load shedding is enabled by default and you can disable the automatic load shedding with this setting:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly properties"><pre tabindex="0" class="prism-code language-properties codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Enable/disable automatic bundle unloading for load-shedding</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerSheddingEnabled=true</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Additional settings that apply to shedding:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly properties"><pre tabindex="0" class="prism-code language-properties codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Load shedding interval. Broker periodically checks whether some traffic should be offload from</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># some over-loaded broker to other under-loaded brokers</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerSheddingIntervalMinutes=1</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Prevent the same topics to be shed and moved to other brokers more that once within this timeframe</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerSheddingGracePeriodMinutes=30</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="broker-overload-thresholds"></a>Broker overload thresholds<a class="hash-link" href="#broker-overload-thresholds" title="Direct link to heading">#</a></h4><p>The determinations of when a broker is overloaded is based on threshold of CPU, network and memory usage. Whenever either of those metrics reaches the threshold, the system triggers the shedding (if enabled).</p><p>By default, overload threshold is set at 85%:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly properties"><pre tabindex="0" class="prism-code language-properties codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Usage threshold to determine a broker as over-loaded</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerBrokerOverloadedThresholdPercentage=85</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Pulsar gathers the usage stats from the system metrics.</p><p>In case of network utilization, in some cases the network interface speed that Linux reports is not correct and needs to be manually overridden. This is the case in AWS EC2 instances with 1Gbps NIC speed for which the OS reports 10Gbps speed.</p><p>Because of the incorrect max speed, the Pulsar load manager might think the broker has not reached the NIC capacity, while in fact the broker already uses all the bandwidth and the traffic is slowed down.</p><p>You can use the following setting to correct the max NIC speed:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly properties"><pre tabindex="0" class="prism-code language-properties codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Override the auto-detection of the network interfaces max speed.</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># This option is useful in some environments (eg: EC2 VMs) where the max speed</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># reported by Linux is not reflecting the real bandwidth available to the broker.</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Since the network usage is employed by the load manager to decide when a broker</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># is overloaded, it is important to make sure the info is correct or override it</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># with the right value here. The configured value can be a double (eg: 0.8) and that</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># can be used to trigger load-shedding even before hitting on NIC limits.</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">loadBalancerOverrideBrokerNicSpeedGbps=</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When the value is empty, Pulsar uses the value that the OS reports.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/pulsar/edit/master/site2/website-next/docs/administration-load-balance.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/next/administration-stats"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Pulsar statistics</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/next/administration-proxy"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Pulsar proxy Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#load-balance-across-pulsar-brokers" class="table-of-contents__link">Load balance across Pulsar brokers</a></li><li><a href="#pulsar-load-manager-architecture" class="table-of-contents__link">Pulsar load manager architecture</a><ul><li><a href="#assign-topics-to-brokers-dynamically" class="table-of-contents__link">Assign topics to brokers dynamically</a></li><li><a href="#create-namespaces-and-bundles" class="table-of-contents__link">Create namespaces and bundles</a></li><li><a href="#unload-topics-and-bundles" class="table-of-contents__link">Unload topics and bundles</a></li><li><a href="#split-namespace-bundles" class="table-of-contents__link">Split namespace bundles</a></li><li><a href="#shed-load-automatically" class="table-of-contents__link">Shed load automatically</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Inc.Copyright Â© 2021 The Apache Software Foundation. All Rights Reserved. Apache, Apache Pulsar and the Apache feather logo are trademarks of The Apache Software Foundation.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.668ae9d7.js"></script>
<script src="/assets/js/main.3d3de418.js"></script>
</body>
</html>