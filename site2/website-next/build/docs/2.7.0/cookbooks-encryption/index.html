<!doctype html>
<html class="docs-version-2.7.0" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Pulsar Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Pulsar Blog Atom Feed"><title data-react-helmet="true">Pulsar Encryption | Apache Pulsar</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://pulsar.apache.com/docs/2.7.0/cookbooks-encryption"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="2.7.0"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-2.7.0"><meta data-react-helmet="true" property="og:title" content="Pulsar Encryption | Apache Pulsar"><meta data-react-helmet="true" name="description" content="Pulsar encryption allows applications to encrypt messages at the producer and decrypt at the consumer. Encryption is performed using the public/private key pair configured by the application. Encrypted messages can only be decrypted by consumers with a valid key."><meta data-react-helmet="true" property="og:description" content="Pulsar encryption allows applications to encrypt messages at the producer and decrypt at the consumer. Encryption is performed using the public/private key pair configured by the application. Encrypted messages can only be decrypted by consumers with a valid key."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pulsar.apache.com/docs/2.7.0/cookbooks-encryption"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.com/docs/2.7.0/cookbooks-encryption" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.com/docs/2.7.0/cookbooks-encryption" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.4a6b6be2.css">
<link rel="preload" href="/assets/js/runtime~main.668ae9d7.js" as="script">
<link rel="preload" href="/assets/js/main.3d3de418.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache Pulsar" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Apache Pulsar" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title"></b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/2.7.0/">Docs</a><a class="navbar__item navbar__link" href="/versions">Versions</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/apache/pulsar" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/docs">Version</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/">2.8.0</a></li><li><a class="dropdown__link" href="/docs/2.7.3/">2.7.3</a></li><li><a class="dropdown__link" href="/docs/2.7.2/">2.7.2</a></li><li><a class="dropdown__link" href="/docs/2.7.1/">2.7.1</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/2.7.0/">2.7.0</a></li><li><a class="dropdown__link" href="/docs/2.6.4/">2.6.4</a></li><li><a class="dropdown__link" href="/docs/2.6.3/">2.6.3</a></li><li><a class="dropdown__link" href="/docs/2.6.2/">2.6.2</a></li><li><a class="dropdown__link" href="/docs/2.2.0/">2.2.0</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Get Started</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts and Architecture</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pulsar Schema</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pulsar Functions</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pulsar IO</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pulsar SQL</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tiered Storage</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Transactions</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes (Helm)</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deployment</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Administration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Security</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Performance</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Client Libraries</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Admin API</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Adaptors</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Cookbooks</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.7.0/cookbooks-compaction">Topic compaction</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.7.0/cookbooks-deduplication">Message deduplication</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.7.0/cookbooks-non-persistent">Non-persistent messaging</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.7.0/cookbooks-retention-expiry">Message retention and expiry</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2.7.0/cookbooks-encryption">Encryption</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.7.0/cookbooks-message-queue">Message queue</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.7.0/cookbooks-bookkeepermetadata">BookKeeper Ledger Metadata</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Reference</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for Apache Pulsar <b>2.7.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/cookbooks-encryption">latest version</a></b> (2.8.0).</div></div><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: 2.7.0</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Pulsar Encryption</h1></header><p>Pulsar encryption allows applications to encrypt messages at the producer and decrypt at the consumer. Encryption is performed using the public/private key pair configured by the application. Encrypted messages can only be decrypted by consumers with a valid key.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="asymmetric-and-symmetric-encryption"></a>Asymmetric and symmetric encryption<a class="hash-link" href="#asymmetric-and-symmetric-encryption" title="Direct link to heading">#</a></h2><p>Pulsar uses dynamically generated symmetric AES key to encrypt messages(data). The AES key(data key) is encrypted using application provided ECDSA/RSA key pair, as a result there is no need to share the secret with everyone.</p><p>Key is a public/private key pair used for encryption/decryption. The producer key is the public key, and the consumer key is the private key of the key pair.</p><p>The application configures the producer with the public  key. This key is used to encrypt the AES data key. The encrypted data key is sent as part of message header. Only entities with the private key(in this case the consumer) will be able to decrypt the data key which is used to decrypt the message.</p><p>A message can be encrypted with more than one key.  Any one of the keys used for encrypting the message is sufficient to decrypt the message</p><p>Pulsar does not store the encryption key anywhere in the pulsar service. If you lose/delete the private key, your message is irretrievably lost, and is unrecoverable</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="producer"></a>Producer<a class="hash-link" href="#producer" title="Direct link to heading">#</a></h2><p><img alt="alt text" src="/assets/images/pulsar-encryption-producer-1d7f4562a5c743e0442a0ec472ca8ef6.jpg" title="Pulsar Encryption Producer"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="consumer"></a>Consumer<a class="hash-link" href="#consumer" title="Direct link to heading">#</a></h2><p><img alt="alt text" src="/assets/images/pulsar-encryption-consumer-2831a122b5b79a1619d00af823b2506c.jpg" title="Pulsar Encryption Consumer"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="here-are-the-steps-to-get-started"></a>Here are the steps to get started:<a class="hash-link" href="#here-are-the-steps-to-get-started" title="Direct link to heading">#</a></h2><ol><li>Create your ECDSA or RSA public/private key pair.</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">openssl ecparam -name secp521r1 -genkey -param_enc explicit -out test_ecdsa_privkey.pem</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">openssl ec -in test_ecdsa_privkey.pem -pubout -outform pkcs8 -out test_ecdsa_pubkey.pem</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>Add the public and private key to the key management and configure your producers to retrieve public keys and consumers clients to retrieve private keys.</li><li>Implement CryptoKeyReader::getPublicKey() interface from producer and CryptoKeyReader::getPrivateKey() interface from consumer, which will be invoked by Pulsar client to load the key.</li><li>Add encryption key to producer configuration: conf.addEncryptionKey(&quot;myapp.key&quot;)</li><li>Add CryptoKeyReader implementation to producer/consumer config: conf.setCryptoKeyReader(keyReader)</li><li>Sample producer application:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class RawFileKeyReader implements CryptoKeyReader {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String publicKeyFile = &quot;&quot;;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String privateKeyFile = &quot;&quot;;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    RawFileKeyReader(String pubKeyFile, String privKeyFile) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        publicKeyFile = pubKeyFile;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        privateKeyFile = privKeyFile;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public EncryptionKeyInfo getPublicKey(String keyName, Map&lt;String, String&gt; keyMeta) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        EncryptionKeyInfo keyInfo = new EncryptionKeyInfo();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            keyInfo.setKey(Files.readAllBytes(Paths.get(publicKeyFile)));</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(&quot;ERROR: Failed to read public key from file &quot; + publicKeyFile);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return keyInfo;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public EncryptionKeyInfo getPrivateKey(String keyName, Map&lt;String, String&gt; keyMeta) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        EncryptionKeyInfo keyInfo = new EncryptionKeyInfo();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            keyInfo.setKey(Files.readAllBytes(Paths.get(privateKeyFile)));</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(&quot;ERROR: Failed to read private key from file &quot; + privateKeyFile);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return keyInfo;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">PulsarClient pulsarClient = PulsarClient.create(&quot;http://localhost:8080&quot;);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ProducerConfiguration prodConf = new ProducerConfiguration();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">prodConf.setCryptoKeyReader(new RawFileKeyReader(&quot;test_ecdsa_pubkey.pem&quot;, &quot;test_ecdsa_privkey.pem&quot;));</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">prodConf.addEncryptionKey(&quot;myappkey&quot;);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Producer producer = pulsarClient.createProducer(&quot;persistent://my-tenant/my-ns/my-topic&quot;, prodConf);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">for (int i = 0; i &lt; 10; i++) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    producer.send(&quot;my-message&quot;.getBytes());</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pulsarClient.close();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="7"><li>Sample Consumer Application:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class RawFileKeyReader implements CryptoKeyReader {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String publicKeyFile = &quot;&quot;;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String privateKeyFile = &quot;&quot;;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    RawFileKeyReader(String pubKeyFile, String privKeyFile) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        publicKeyFile = pubKeyFile;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        privateKeyFile = privKeyFile;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public EncryptionKeyInfo getPublicKey(String keyName, Map&lt;String, String&gt; keyMeta) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        EncryptionKeyInfo keyInfo = new EncryptionKeyInfo();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            keyInfo.setKey(Files.readAllBytes(Paths.get(publicKeyFile)));</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(&quot;ERROR: Failed to read public key from file &quot; + publicKeyFile);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return keyInfo;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public EncryptionKeyInfo getPrivateKey(String keyName, Map&lt;String, String&gt; keyMeta) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        EncryptionKeyInfo keyInfo = new EncryptionKeyInfo();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            keyInfo.setKey(Files.readAllBytes(Paths.get(privateKeyFile)));</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(&quot;ERROR: Failed to read private key from file &quot; + privateKeyFile);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return keyInfo;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ConsumerConfiguration consConf = new ConsumerConfiguration();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">consConf.setCryptoKeyReader(new RawFileKeyReader(&quot;test_ecdsa_pubkey.pem&quot;, &quot;test_ecdsa_privkey.pem&quot;));</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">PulsarClient pulsarClient = PulsarClient.create(&quot;http://localhost:8080&quot;);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Consumer consumer = pulsarClient.subscribe(&quot;persistent://my-tenant//my-ns/my-topic&quot;, &quot;my-subscriber-name&quot;, consConf);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Message msg = null;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">for (int i = 0; i &lt; 10; i++) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg = consumer.receive();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // do something</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    System.out.println(&quot;Received: &quot; + new String(msg.getData()));</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Acknowledge the consumption of all messages at once</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">consumer.acknowledgeCumulative(msg);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pulsarClient.close();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="key-rotation"></a>Key rotation<a class="hash-link" href="#key-rotation" title="Direct link to heading">#</a></h2><p>Pulsar generates new AES data key every 4 hours or after a certain number of messages are published. The asymmetric public key is automatically fetched by producer every 4 hours by calling CryptoKeyReader::getPublicKey() to retrieve the latest version.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="enabling-encryption-at-the-producer-application"></a>Enabling encryption at the producer application:<a class="hash-link" href="#enabling-encryption-at-the-producer-application" title="Direct link to heading">#</a></h2><p>If you produce messages that are consumed across application boundaries, you need to ensure that consumers in other applications have access to one of the private keys that can decrypt the messages.  This can be done in two ways:</p><ol><li>The consumer application provides you access to their public key, which you add to your producer keys</li><li>You grant access to one of the private keys from the pairs used by producer </li></ol><p>In some cases, the producer may want to encrypt the messages with multiple keys. For this, add all such keys to the config. Consumer will be able to decrypt the message, as long as it has access to at least one of the keys.</p><p>E.g: If messages needs to be encrypted using 2 keys myapp.messagekey1 and myapp.messagekey2,</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conf.addEncryptionKey(&quot;myapp.messagekey1&quot;);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conf.addEncryptionKey(&quot;myapp.messagekey2&quot;);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="decrypting-encrypted-messages-at-the-consumer-application"></a>Decrypting encrypted messages at the consumer application:<a class="hash-link" href="#decrypting-encrypted-messages-at-the-consumer-application" title="Direct link to heading">#</a></h2><p>Consumers require access one of the private keys to decrypt messages produced by the producer. If you would like to receive encrypted messages, create a public/private key and give your public key to the producer application to encrypt messages using your public key.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="handling-failures"></a>Handling Failures:<a class="hash-link" href="#handling-failures" title="Direct link to heading">#</a></h2><ul><li>Producer/ Consumer loses access to the key<ul><li>Producer action will fail indicating the cause of the failure. Application has the option to proceed with sending unencrypted message in such cases. Call conf.setCryptoFailureAction(ProducerCryptoFailureAction) to control the producer behavior. The default behavior is to fail the request.</li><li>If consumption failed due to decryption failure or missing keys in consumer, application has the option to consume the encrypted message or discard it. Call conf.setCryptoFailureAction(ConsumerCryptoFailureAction) to control the consumer behavior. The default behavior is to fail the request.
Application will never be able to decrypt the messages if the private key is permanently lost.</li></ul></li><li>Batch messaging<ul><li>If decryption fails and the message contain batch messages, client will not be able to retrieve individual messages in the batch, hence message consumption fails even if conf.setCryptoFailureAction() is set to CONSUME.</li></ul></li><li>If decryption fails, the message consumption stops and application will notice backlog growth in addition to decryption failure messages in the client log. If application does not have access to the private key to decrypt the message, the only option is to skip/discard backlogged messages.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/pulsar/edit/master/site2/website-next/versioned_docs/version-2.7.0/cookbooks-encryption.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/2.7.0/cookbooks-retention-expiry"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Message retention and expiry</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/2.7.0/cookbooks-message-queue"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Message queue Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#asymmetric-and-symmetric-encryption" class="table-of-contents__link">Asymmetric and symmetric encryption</a></li><li><a href="#producer" class="table-of-contents__link">Producer</a></li><li><a href="#consumer" class="table-of-contents__link">Consumer</a></li><li><a href="#here-are-the-steps-to-get-started" class="table-of-contents__link">Here are the steps to get started:</a></li><li><a href="#key-rotation" class="table-of-contents__link">Key rotation</a></li><li><a href="#enabling-encryption-at-the-producer-application" class="table-of-contents__link">Enabling encryption at the producer application:</a></li><li><a href="#decrypting-encrypted-messages-at-the-consumer-application" class="table-of-contents__link">Decrypting encrypted messages at the consumer application:</a></li><li><a href="#handling-failures" class="table-of-contents__link">Handling Failures:</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Inc.Copyright Â© 2021 The Apache Software Foundation. All Rights Reserved. Apache, Apache Pulsar and the Apache feather logo are trademarks of The Apache Software Foundation.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.668ae9d7.js"></script>
<script src="/assets/js/main.3d3de418.js"></script>
</body>
</html>