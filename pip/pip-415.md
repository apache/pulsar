# PIP-415: Support getting message ID by offset

# Background knowledge


- In [PIP-70](https://github.com/apache/pulsar/wiki/PIP-70%3A-Introduce-lightweight-broker-entry-metadata), we introduced `Broker Entry Metadata` containing an `index` field - a continuous sequence identifier for messages within a topic partition.
This sequence ID simplifies message sequence management compared to the composite MessageId (ledgerId+entryId+batchIndex) which becomes discontinuous across ledgers.
- In [PIP-90](https://github.com/apache/pulsar/wiki/PIP-90%3A-Expose-broker-entry-metadata-to-the-client), we exposed this metadata via the `Message.getIndex()` API. 
- In [PR-6331](https://github.com/apache/pulsar/pull/6331), we added a new `get-message-by-id` cmd into pulsar-admin.

After these three works, we can now obtain the offset of a message by its message id:

1. Get the message by id using `get-message-by-id` cmd
2. Get the index of the message using `Message.getIndex()`

But we cannot obtain the message id by offset. Then we need to add a new API to get the message id by offset.

# Motivation

Our organization is currently planning a migration from RocketMQ to Pulsar. To facilitate this transition, we aim to implement a standardized abstraction layer for MQ clients that encapsulates implementation details of specific messaging systems. This abstraction layer will allow seamless engine replacement while maintaining consistent client interfaces.
However, one critical compatibility issues hinder the unification of message fetching pat terns between RocketMQ/Kafka and Pulsar:

**Positioning Mechanism Mismatch**:
- RocketMQ/Kafka: Utilize monotonically increasing numerical offsets for message positioning and acknowledgment
- Pulsar: Relies on composite MessageID (ledgerId + entryId + batchIndex) for message identification

We propose to add a new API to retrieve the message ID by offset, enabling us to cache the mapping between message ID and offset.
This will allow us to use offsets for seek and acknowledgment operations when consuming messages through the standardized API.

# Goals

## In Scope

- Add a new API to retrieve the message ID by offset

# High Level Design

# Detailed Design
The core implementation involves adding a new HTTP endpoint to query MessageId by offset (index). Underlying implementation will leverage existing `Broker Entry Metadata` containing index values.

## Design & Implementation Details

## Public-facing Changes

### Public API

```java
    @GET
    @Path("/{tenant}/{namespace}/{topic}/getMessageIdByOffset")
    @ApiOperation(hidden = true, value = "Get Message ID by offset.",
            notes = "If the specified offset is a system message, "
                    + "it will return the message id of the later message.")
    @ApiResponses(value = {
            @ApiResponse(code = 307, message = "Current broker doesn't serve the namespace of this topic"),
            @ApiResponse(code = 403, message = "Don't have admin permission"),
            @ApiResponse(code = 404, message = "Namespace or partitioned topic does not exist, "
                    + "or the offset is invalid")})
    public void getMessageIDByOffsetAndPartitionID(@Suspended final AsyncResponse asyncResponse,
                                                   @PathParam("tenant") String tenant,
                                                   @PathParam("namespace") String namespace,
                                                   @PathParam("topic") @Encoded String encodedTopic,
                                                   @QueryParam("offset") long offset,
                                                   @QueryParam("authoritative") @DefaultValue("false")
                                                   boolean authoritative){
        validateTopicName(tenant, namespace, encodedTopic);
        internalGetMessageIDByOffsetAsync(offset, authoritative)
                .thenAccept(asyncResponse::resume)
                .exceptionally(ex -> {
                    if (!isRedirectException(ex)) {
                        log.error("[{}] Failed to get message id by offset for topic {}, partition id {}, offset {}",
                                clientAppId(), topicName, offset, ex);
                    }
                    resumeAsyncResponseExceptionally(asyncResponse, ex);
                    return null;
                });
    }
```

### Binary protocol

### Configuration

### CLI
Add new subcommand to pulsar-admin:

```bash
    pulsar-admin topics get-message-id-by-offset \
    --offset 12345 \
    persistent://tenant/ns/topic
```
### Metrics

# Monitoring

# Security Considerations
# Backward & Forward Compatibility

## Upgrade

## Downgrade / Rollback

## Pulsar Geo-Replication Upgrade & Downgrade/Rollback Considerations


# Alternatives

# General Notes

# Links

* Mailing List discussion thread:
* Mailing List voting thread:
