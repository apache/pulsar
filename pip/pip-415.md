# PIP-415: Support getting message ID by offset(index)

# Background knowledge


- In [PIP-70](https://github.com/apache/pulsar/wiki/PIP-70%3A-Introduce-lightweight-broker-entry-metadata), we introduced `Broker Entry Metadata` containing an `index` field - a continuous sequence identifier for messages within a topic partition.
This sequence ID simplifies message sequence management compared to the composite MessageId (ledgerId+entryId+batchIndex) which becomes discontinuous across ledgers.
- In [PIP-90](https://github.com/apache/pulsar/wiki/PIP-90%3A-Expose-broker-entry-metadata-to-the-client), we exposed this metadata via the `Message.getIndex()` API. 
- In [PR-6331](https://github.com/apache/pulsar/pull/6331), we added a new `get-message-by-id` cmd into pulsar-admin.

After these three works, we can now obtain the offset(index) of a message by its message id:

1. Get the message by id using `get-message-by-id` cmd
2. Get the index of the message using `Message.getIndex()`

But we cannot obtain the message id by offset(index). Then we need to add a new API to get the message id by offset(index).

# Motivation

Our organization is currently planning a migration from RocketMQ to Pulsar. To facilitate this transition, we aim to implement a standardized abstraction layer for MQ clients that encapsulates implementation details of specific messaging systems. This abstraction layer will allow seamless engine replacement while maintaining consistent client interfaces.
However, one critical compatibility issues hinder the unification of message fetching pat terns between RocketMQ/Kafka and Pulsar:

**Positioning Mechanism Mismatch**:
- RocketMQ/Kafka: Utilize monotonically increasing numerical offset(index)s for message positioning and acknowledgment
- Pulsar: Relies on composite MessageID (ledgerId + entryId + batchIndex) for message identification

We propose to add a new API to retrieve the message ID by offset(index), enabling us to cache the mapping between message ID and offset(index).
This will allow us to use offset(index)s for seek and acknowledgment operations when consuming messages through the standardized API.

# Goals

## In Scope

- Add a new API to retrieve the message ID by offset(index)

# High Level Design

# Detailed Design
The core implementation involves adding a new HTTP endpoint to query MessageId by offset(index). Underlying implementation will leverage existing `Broker Entry Metadata` containing index values.

## Design & Implementation Details

## Public-facing Changes

### Public API

#### Request Path
- **Path Template**:  
  ```http
  GET /{tenant}/{namespace}/{topic}/getMessageIdByIndex
  ```  
- `{tenant}`: Tenant name (string, path parameter).
- `{namespace}`: Namespace name (string, path parameter).
- `{topic}`: Topic name (URL-encoded string, path parameter).

#### HTTP Method
- **Method**: `GET`
- **Purpose**: Retrieve the message ID associated with a specific message index in a topic.

#### Parameters

| Type           | Name               | Data Type    | Required | Description                                                                                                           |
|----------------|--------------------|--------------|----------|-----------------------------------------------------------------------------------------------------------------------|
| **Path Param** | `tenant`           | `String`     | Yes      | Tenant identifier for multi-tenancy isolation.                                                                        |
|                | `namespace`        | `String`     | Yes      | Namespace identifier to group topics under a tenant.                                                                  |
|                | `topic`            | `String`     | Yes      | Topic name (URL-encoded). The `@Encoded` annotation ensures raw URL decoding is avoided during parsing.               |
| **Query Param**| `index`            | `long`       | Yes      | Zero-based index of the message in the topic.                                                                         |
|                | `authoritative`    | `boolean`    | No       | If `false`, the broker may return `307 Redirect` if it does not own the topic. Default: `false`.                      |

#### Response

##### Success Response
- **Status Code**: `200 OK`
- **Body Format**:
  ```json
  {
    "ledgerId": 12345,
    "entryId": 67890,
    "partitionIndex": 0
  }
  ```  
    - `ledgerId`: ID of the ledger where the message is stored.
    - `entryId`: Unique identifier of the message within the ledger.
    - `partitionIndex`: Partition index (relevant for partitioned topics; `0` for non-partitioned topics).

##### Error Responses

| Status Code          | Description                                                                                                  | Response Body Format                                                                 |
|----------------------|--------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
| **307 Temporary Redirect** | Current broker does not serve the topicâ€™s namespace. Redirect to the correct broker.                       | No body. `Location` header indicates the target broker URL.                         |
| **403 Forbidden**           | Client lacks permissions to access the topic/namespace.                                                    | JSON with `code` (e.g., `PERMISSION_DENIED`) and `message` (error details).          |
| **404 Not Found**           | Topic/namespace does not exist, or the specified `index` is invalid (out of bounds or points to a system message). | JSON with `code` (e.g., `INVALID_INDEX`) and `message` (error details).              |  

#### Pulsar Admin
Add two api in `pulsar-client-admin-api/src/main/java/org/apache/pulsar/client/admin/Topics.java`
```java
    /**
     * Get the message id by index.
     * @param topicName the partitioned topic name or non-partitioned topic name
     * @param index the index of a message
     * @return the message id of the message
     */
    MessageId getMessageIdByIndex(String topicName, long index) throws PulsarAdminException;

    /**
     * Get the message id by index asynchronously.
     * @param topicName the topic name
     * @param index the index of a message
     * @return the message id of the message
     */
    CompletableFuture<MessageId> getMessageIdByIndexAsync(String topicName, long index);
```

### Binary protocol

### Configuration

### CLI
Add new subcommand to pulsar-admin:

```bash
    pulsar-admin topics get-message-id-by-offset \
    --offset 12345 \
    persistent://tenant/ns/topic
```
### Metrics

# Monitoring

# Security Considerations
# Backward & Forward Compatibility

## Upgrade

## Downgrade / Rollback

## Pulsar Geo-Replication Upgrade & Downgrade/Rollback Considerations


# Alternatives

# General Notes

# Links

* Mailing List discussion thread:
* Mailing List voting thread:
