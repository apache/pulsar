# Background knowledge

<!--
Describes all the knowledge you need to know in order to understand all the other sections in this PIP

* Give a high level explanation on all concepts you will be using throughout this document. For example, if you want to talk about Persistent Subscriptions, explain briefly (1 paragraph) what this is. If you're going to talk about Transaction Buffer, explain briefly what this is.
  If you're going to change something specific, then go into more detail about it and how it works.
* Provide links where possible if a person wants to dig deeper into the background information.

DON'T
* Do not include links *instead* explanation. Do provide links for further explanation.

EXAMPLES
* See [PIP-248](https://github.com/apache/pulsar/issues/19601), Background section to get an understanding on how you add the background knowledge needed.
  (They also included the motivation there, but ignore it as we place that in Motivation section explicitly).
-->

Pulsar producers have the option to enable chunking and enable batching when initialized. Chunking is a mechanism by which large messages can be split into smaller ones so that they are not constrained to the maximum message size. Batching involves the producer sending a number of messages together in a batch, instead of one-by-one. These two settings are mutually exclusive - if chunking is enabled, batching must be disabled.

If there is a not a normal response from a Pulsar consumer after a message is consumed, that message is sent to a retry letter topic. The message will then be retried a set number of times. If there is still no normal response, it will go to a dead letter topic where it can be manually processed. The producers for retry letter and dead letter are created internally in the consumer.

# Motivation

<!--
Describe the problem this proposal is trying to solve.

* Explain what is the problem you're trying to solve - current situation.
* This section is the "Why" of your proposal.
-->

Currently, there is no means of specifying that the retry letter producer nor dead letter producer should use batching or chunking. Retry letter explicitly sets batching to 'false' and dead letter does not set a value, making it the default 'true' (and chunking is 'false' by default for both).

If the user does intend to use chunking, this causes problems. If the message cannot be consumed properly for some reason - for instance, due to a timeout - it will be sent to the retry topic. But that will immediately throw an error saying that the message exceeds the max size, since it does not recognize chunking. While it is possible to increase the max message size overall, if the user knows these messages will get quite large - but not exactly how large - this may not be viable.

It would be better for the user to be able to specify that chunking(/batching) should be set to certain values when the consumer creates the retry letter and dead letter producers.

# Goals

## In Scope

<!--
What this PIP intend to achieve once It's integrated into Pulsar.
Why does it benefit Pulsar.
-->

1. Expose properties to enable chunking for retry and dead letter producers.
2. Expose properties to enable batching for retry and dead letter producers.

## Out of Scope

<!--
Describe what you have decided to keep out of scope, perhaps left for a different PIP/s.
-->

None


# High Level Design

<!--
Describe the design of your solution in *high level*.
Describe the solution end to end, from a birds-eye view.
Don't go into implementation details in this section.

I should be able to finish reading from beginning of the PIP to here (including) and understand the feature and
how you intend to solve it, end to end.

DON'T
* Avoid code snippets, unless it's essential to explain your intent.
-->

The consumer may already be configured with a `DeadLetterPolicy`, which is currently used to set the topic names, max retries, etc. We can add 4 total properties: enable chunking for dead letter, enable batching for dead letter, enable chunking for retry letter, and enable batching for retry letter. These properties will be fetched at the respective places that the producers are created, and passed to `enableChunking` and `enableBatching`.

# Detailed Design

## Design & Implementation Details

<!--
This is the section where you dive into the details. It can be:
* Concrete class names and their roles and responsibility, including methods.
* Code snippets of existing code.
* Interface names and its methods.
* ...
-->

There is a change set with these updates currently in a PR: https://github.com/apache/pulsar/pull/20936/files

Update `DeadLetterPolicy` class with 4 new properties: `retryLetterBatchingEnabled`, `retryLetterChunkingEnabled`, `deadLetterBatchingEnabled`, and `deadLetterChunkingEnabled`. These will all have default values so that they do not have to be set, which reflect the current hardcoded/default settings.

Update `ConsumerImpl`:

- When the `DeadLetterPolicy` field is initialized based on the configuration provided, copy the four new properties values from the configuration.
- When the retry letter producer is created, pass `retryLetterChunkingEnabled` to `enableChunking` and `retryLetterBatchingEnabled` to `enableBatching`.
- When the dead letter producer is created, pass `deadLetterChunkingEnabled` to `enableChunking` and `deadLetterBatchingEnabled` to `enableBatching`.

## Public-facing Changes

<!--
Describe the additions you plan to make for each public facing component.
Remove the sections you are not changing.
Clearly mark any changes which are BREAKING backward compatability.
-->

### Public API
<!--
When adding a new endpoint to the REST API, please make sure to document the following:

* path
* query parameters
* HTTP body parameters, usually as JSON.
* Response codes, and for each what they mean.
  For each response code, please include a detailed description of the response body JSON, specifying each field and what it means.
  This is the place to document the errors.
-->

The `DeadLetterPolicy` is part of the public API and will be changed to add `retryLetterBatchingEnabled`, `retryLetterChunkingEnabled`, `deadLetterBatchingEnabled`, and `deadLetterChunkingEnabled`. These will all have defaults, so there should be no issues with backwards compatibility.

# Monitoring

<!--
Describe how the changes you make in this proposal should be monitored.
Don't describe the detailed metrics - they should be at "Public-facing Changes" / "Metrics" section.
Describe how the user will use the metrics to monitor the feature: Which alerts they should set up, which thresholds, ...
-->

Not applicable

# Security Considerations
<!--
A detailed description of the security details that ought to be considered for the PIP. This is most relevant for any new HTTP endpoints, new Pulsar Protocol Commands, and new security features. The goal is to describe details like which role will have permission to perform an action.

An important aspect to consider is also multi-tenancy: Does the feature I'm adding have the permissions / roles set in such a way that prevent one tenant accessing another tenant's data/configuration? For example, the Admin API to read a specific message for a topic only allows a client to read messages for the target topic. However, that was not always the case. CVE-2021-41571 (https://github.com/apache/pulsar/wiki/CVE-2021-41571) resulted because the API was incorrectly written and did not properly prevent a client from reading another topic's messages even though authorization was in place. The problem was missing input validation that verified the requested message was actually a message for that topic. The fix to CVE-2021-41571 was input validation.

If there is uncertainty for this section, please submit the PIP and request for feedback on the mailing list.
-->

None

# Backward & Forward Compatibility

## Revert

<!--
Describe a cookbook detailing the steps required to revert pulsar to previous version *without* this feature.
-->

No special steps should be required to revert this change. If the new properties are being explicitly set in client code, they will need to be removed from the `DeadLetterPolicy` builder.

## Upgrade

<!--
Specify the list of instructions, if there are such, needed to perform before/after upgrading to Pulsar version containing this feature.
-->

No special steps should be required to upgrade to this change.

# Alternatives

<!--
If there are alternatives that were already considered by the authors or, after the discussion, by the community, and were rejected, please list them here along with the reason why they were rejected.
-->

None discussed yet

# General Notes

# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread:
* Mailing List voting thread:
