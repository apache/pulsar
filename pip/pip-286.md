# Background knowledge

In https://github.com/apache/pulsar/pull/11139 we support get position based on timestamp, but it doesn't work well with topic compaction enabled because the data may have been move to the compacted ledger.

In [PIP-278](https://github.com/apache/pulsar/pull/20624) we introduced the pluggable topic compaction service to extend the compaction.

# Motivation

In order for `get-message-id` to work well with topic compaction enabled we need to find the position according to publish time from topic compaction service,
but `TopicCompactionService` missing a method that find positions according to publish time or other metadata, so we should add it.

In addition, this method can also be used to find the position/offset according to offset/timestamp in the KoP.

# Goals

# High Level Design

We need to add a method to `Topic Compaction Service` that can find the matching position and other metadata information according to a given condition.

# Detailed Design

Add `RawEntryMetadata` interface.

Add `findFirstEntryMetadata` in the `TopicCompactionService` API.

Implement it in the `PulsarTopicCompactionService` using binary search.

When get messageId by timestamp, find position from topicCompactionService if we can't find position in the manageLedger.

## Public-facing Changes

 ```java
  /**
   * Raw entry metadata object with position / messageMetadata / brokerEntryMetadata
   */
  public interface RawEntryMetadata {
      PositionImpl getPosition();
      
      MessageMetadata getMessageMetadata();
      
      @javax.annotation.Nullable 
      BrokerEntryMetadata getBrokerEntryMetadata();
  }

  public interface TopicCompactionService extends AutoCloseable { 

   /**
    * Find the first raw entry metadata that matches the given condition.
    *
    * @param condition  the condition to match.
    * @return the first entry metadata that matches the given condition, this raw entry metadata can be null.
    */
    CompletableFuture<RawEntryMetadata> findFirstEntryMetadata(@Nonnull Predicate<RawEntryMetadata> condition);
  }
  ```

# Links

* Mailing List discussion thread: https://lists.apache.org/thread/85o3sx6rhohvc370j4r7yd2nb1tx736c
* Mailing List voting thread: 