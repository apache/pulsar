# PIP-413: Support use external schema registry service for Pulsar client

# Background knowledge

Schema is an important feature for messaging systems. Pulsar integrates schema manager into the Pulsar broker.
This implementation has some weaknesses. Managing the schema increases the Pulsar broker and Pulsar protocol complexity;
users canâ€™t leverage other schema registry services in Pulsar client, such as Kafka Schema Registry.

# Motivation

The Pulsar client should have the ability to access external schema registry service to manage the schema (register schema,
get schema, validate schema, etc.). The schema registry service can be an independent service, if using external schema registry service,
the Pulsar broker don't need to care about the schema of the messages.

# Goals

## In Scope

- Support using external schema registry service for Pulsar client.

## Out Scope

This PIP will not include the implementation for accessing external schema system,
and not include the Pulsar external schema registry service design.

# High Level Design

This PIP is just for providing some abilities.

- Decouple schema management from creating producer or add consumer subscription commands.
- Provide a way to build external schema management system clients and integrate with Pulsar clients.

# Detailed Design

## Design & Implementation Details

This PIP's target is making Pulsar client has the ability to leverage external schema registry service to manage schema.
The external schema registry is responsible for managing the schema, the broker don't care about the messaging schema. 
The Pulsar client should ignore the schema information when creating producer and adding consumer subscription.

Users can implement the `SchemaInfoProvider` interface and `Schema` interface to access external schema registry service.
The `Schema` interface has mainly two methods `encode` and `decode`, the customized schemas can register schema or get schema with these methods.
The encoded messaging depends on the external schema system, Pulsar broker just treats the message as bytes data, and it won't change the message version of message metadata.
Unlike Pulsar using schema version to identify the schema, some external schema system use the schema ID to identify the schema,
if using external schema system the Pulsar message metadata will not maintain schema ID, the customized decoding method can try to retrieve the schema ID from the encoded data.

## Public-facing Changes

Add new methods for `SchemaInfoProvider` interface.
The `SchemaInfoProvider` provide necessary params for connecting to the external schema registry service with the method `getConfigs`.
If the schema info provider is external, the new producer command, consumer subscribe command will treat the schema as bytes schema, the broker will ignore schema validation.
```java
public interface SchemaInfoProvider {

    /**
      * Returns the configs of the schema registry service, such as URL, authentication params.
      */
    default Map<String, String> getConfigs() {
        return Collections.emptyMap();
    }

    /**
      * It's used to determine whether the SchemaInfoProvider is external or not.
      */
    default boolean isExternal() {
        return false;
    }

}
```

Add a new interface `SchemaInfoProviderFactory`, it's used to initialize `SchemaInfoProvider`, each topic has its own `SchemaInfoProvider`.
```java
public interface SchemaInfoProviderFactory {

    SchemaInfoProvider of(String topic);

}
```

The client build supports setting the `SchemaInfoProviderFactory`.
```java
public interface ClientBuilder extends Serializable, Cloneable {

    ClientBuilder schemaInfoProviderFactory(SchemaInfoProviderFactory schemaInfoProviderFactory);

}
```

The `ClientConfigurationData` supports transfer `SchemaInfoProviderFactory`.
```java
public class ClientConfigurationData implements Serializable, Cloneable {

    @JsonIgnore
    private transient SchemaInfoProviderFactory schemaInfoProviderFactory;

}
```

The customized schema can get the `SchemaInfoProvider` and retrieve the configs from it.
```java
public interface Schema {

    /**
     * When setting schema info provider for schema, the schema can retrieve the configs.
     */
    default void setSchemaInfoProvider(SchemaInfoProvider schemaInfoProvider) {
    }

    /**
      * Returns the schema info provider.
      *
      * @return a {@code SchemaInfoProvider} representing the schema info provider
      */
    default SchemaInfoProvider getSchemaInfoProvider() {
        return null;
    }

}
```

### CLI

# Backward & Forward Compatibility

## Revert

No changes are needed to revert to the previous version.

## Upgrade

No other changes are needed to upgrade to the new version.

# Alternatives

None

# General Notes

# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread: https://lists.apache.org/thread/olx4xm8cdy43omp5c0jm44sj1gp0grcr
* Mailing List voting thread: https://lists.apache.org/thread/vhq6ox4nh2rx59yoxowftqzv8f9lnm4q
