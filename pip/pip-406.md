# PIP-406: Introduce metrics related to dispatch throttled number of times

# Background knowledge

## Motivation

Currently, users can monitor subscription backlogs using the `pulsar_subscription_back_log_no_delayed` metric. 
However, if [dispatch throttling](https://pulsar.apache.org/docs/next/concepts-throttling/) is configured at the broker/topic/subscription level,
this metric may not accurately reflect whether the backlog is due to insufficient consumer capacity, as it could be caused by dispatch throttling.

## Goals

Introduce metrics to indicate the count of `messages/bytes throttled` for **broker/topic/subscription** level rate limit. 
This allows users to write PromQL queries to identify subscriptions with high backlogs but low or no throttling, pinpointing backlogs caused by insufficient consumer capacity.

## In Scope

Broker Level:
- Introduce the metric `pulsar_broker_dispatch_throttled_msg_count` to represent the total number of times message dispatching was throttled on a broker due to broker rate limits.
- Introduce the metric `pulsar_broker_dispatch_throttled_bytes_count` to represent the total number of times byte dispatching was throttled on a broker due to broker rate limits.

Topic Level:
- Introduce the metric `pulsar_dispatch_throttled_msg_count` to represent the total number of times message dispatching was throttled on a topic due to topic rate limits.
- Introduce the metric `pulsar_dispatch_throttled_bytes_count` to represent the total number of times byte dispatching was throttled on a topic due to topic rate limits.
 
Subscription Level:
- Introduce the metric `pulsar_subscription_dispatch_throttled_msg_count` to represent the total number of times message dispatching was throttled on a subscription due to subscription rate limits.
- Introduce the metric `pulsar_subscription_dispatch_throttled_bytes_count` to represent the total number of times byte dispatching was throttled on a subscription due to subscription rate limits.
 

## Out of Scope
- These states are not persistent and will reset upon broker restart/ topic re-load / subscription reconnected.

# High Level Design
1. Maintain `dispatchThrottleMsgCount` and `dispatchThrottleBytesCount` in `DispatchRateLimiter`. Increase these values in the `consumeDispatchQuota` method when the TokenBucket for messages or bytes is insufficient.
2. Output these fields when retrieving metrics.


# Detailed Design

## Design & Implementation Details
1. Maintain `dispatchThrottleMsgCount` and `dispatchThrottleBytesCount` in `DispatchRateLimiter`:
```java
    private final LongAdder dispatchThrottleMsgCount = new LongAdder();
    private final LongAdder dispatchThrottleBytesCount = new LongAdder();
```

2. Each time a read occurs, if the expected number of messages or bytes is reduced, increment the metric by one. 
```diff
     private boolean applyDispatchRateLimitsToReadLimits(DispatchRateLimiter rateLimiter,
                                                         MutablePair<Integer, Long> readLimits,
                                                         DispatchRateLimiter.Type limiterType) {
+        int originalMessagesToRead = readLimits.getLeft();
+        long originalBytesToRead = readLimits.getRight();
         // update messagesToRead according to available dispatch rate limit.
         int availablePermitsOnMsg = (int) rateLimiter.getAvailableDispatchRateLimitOnMsg();
         if (availablePermitsOnMsg >= 0) {
@@ -414,6 +416,12 @@ private boolean applyDispatchRateLimitsToReadLimits(DispatchRateLimiter rateLimi
         if (availablePermitsOnByte >= 0) {
             readLimits.setRight(Math.min(readLimits.getRight(), availablePermitsOnByte));
         }
+        if (readLimits.getLeft() < originalMessagesToRead) {
+            rateLimiter.increaseDispatchThrottleMsgCount();
+        }
+        if (readLimits.getRight() < originalBytesToRead) {
+            rateLimiter.increaseDispatchThrottleBytesCount();
+        }
```
3. When get stats or metrics for broker/topic/subscription throttle count, output these fields.

## Public-facing Changes

### Metrics

1. `pulsar_broker_dispatch_throttled_msg_count`:
  - Description: The total number of times message dispatching was throttled on a broker due to broker rate limits
  - Attributes: 
    - cluster
  - Unit: throttled count
   
2. `pulsar_broker_dispatch_throttled_bytes_count`:
  - Description: The total number of times byte dispatching was throttled on a broker due to broker rate limits
  - Attributes:
    - cluster
  - Unit: throttled count
     
3. `pulsar_dispatch_throttled_msg_count`:
  - Description: The total number of times message dispatching was throttled on a topic due to topic rate limits
  - Attributes:
    - tenant
    - namespace
    - topic
  - Unit: messages count

4. `pulsar_dispatch_throttled_bytes_count`:
  - Description: The total number of times byte dispatching was throttled on a topic due to topic rate limits
  - Attributes:
    - tenant
    - namespace
    - topic
  - Unit: messages count

5. `pulsar_subscription_dispatch_throttled_msg_count`:
  - Description: The total number of times message dispatching was throttled on a subscription due to subscription rate limits
  - Attributes:
    - tenant
    - namespace
    - topic
    - subscription
  - Unit: messages count

6. `pulsar_subscription_dispatch_throttled_bytes_count`:
  - Description: The total number of times byte dispatching was throttled on a subscription due to subscription rate limits
  - Attributes:
    - tenant
    - namespace
    - topic
    - subscription
  - Unit: messages count

### API
1. Add get throttle count interface on admin api `TopicStats`.
```java
    /**
     * Total count of throttling occurrences due to message rate limiting.
     */
    long getDispatchThrottledMsgCount();

    /**
     * Total count of throttling occurrences due to byte rate limiting.
     */
    long getDispatchThrottledBytesCount();
```

2. Add get throttle count interface on admin api `SubscriptionStats`.
```java
    /**
     * Total count of throttling occurrences due to message rate limiting.
     */
    long getDispatchThrottledMsgCount();

    /**
     * Total count of throttling occurrences due to byte rate limiting.
     */
    long getDispatchThrottledBytesCount();
```

### Configuration
- None

# Backward & Forward Compatibility
- Full Compatibility

