# PIP-406: Introduce metrics related to dispatch_throttled_count

# Background knowledge

## Motivation

Currently, users can monitor subscription backlogs using the `pulsar_subscription_back_log_no_delayed` metric. 
However, if [dispatch throttling](https://pulsar.apache.org/docs/next/concepts-throttling/) is configured at the broker/topic/subscription level,
this metric may not accurately reflect whether the backlog is due to insufficient consumer capacity, as it could be caused by dispatch throttling.

## Goals

Introduce metrics to indicate the count of `messages/bytes throttled` for **broker/topic/subscription** level rate limit. 
This allows users to write PromQL queries to identify subscriptions with high backlogs but low or no throttling, pinpointing backlogs caused by insufficient consumer capacity.

## In Scope

Broker Level:
- Introduce the metric `pulsar_broker_dispatch_throttled_msg_count` to represent the total count of messages throttled for a broker.
- Introduce the metric `pulsar_broker_dispatch_throttled_bytes_count` to represent the total count of bytes throttled for a broker.

Topic Level:
- Introduce the metric `pulsar_dispatch_throttled_msg_count` to represent the total count of messages throttled for a topic.
- Introduce the metric `pulsar_dispatch_throttled_bytes_count` to represent the total count of bytes throttled for a topic.
 
Subscription Level:
- Introduce the metric `pulsar_subscription_dispatch_throttled_msg_count` to represent the total count of messages throttled for a subscription.
- Introduce the metric `pulsar_subscription_dispatch_throttled_bytes_count` to represent the total count of bytes throttled for a subscription.
 

## Out of Scope
- These states are not persistent and will reset upon broker restart/ topic re-load / subscription reconnected.

# High Level Design
1. Maintain `dispatchThrottleMsgCount` and `dispatchThrottleBytesCount` in `DispatchRateLimiter`. Increase these values in the `consumeDispatchQuota` method when the TokenBucket for messages or bytes is insufficient.
2. Output these fields when retrieving metrics.


# Detailed Design

## Design & Implementation Details
1. Maintain `dispatchThrottleMsgCount` and `dispatchThrottleBytesCount` in `DispatchRateLimiter`:
```java
    private final LongAdder dispatchThrottleMsgCount = new LongAdder();
    private final LongAdder dispatchThrottleBytesCount = new LongAdder();
```

2. During each [consumeDispatchQuota](https://github.com/apache/pulsar/blob/c4cff0ab3dac169c0a1418ef2f63f61604f6278e/pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/DispatchRateLimiter.java#L97-L104),
if token bucket is insufficient, increase these fields accordingly.
```diff
     public void consumeDispatchQuota(long numberOfMessages, long byteSize) {
         AsyncTokenBucket localDispatchRateLimiterOnMessage = dispatchRateLimiterOnMessage;
         if (numberOfMessages > 0 && localDispatchRateLimiterOnMessage != null) {
-            localDispatchRateLimiterOnMessage.consumeTokens(numberOfMessages);
+            if (!localDispatchRateLimiterOnMessage.consumeTokensAndCheckIfContainsTokens(numberOfMessages)) {
+                dispatchThrottleMsgCount.increment();
+            }
         }
         AsyncTokenBucket localDispatchRateLimiterOnByte = dispatchRateLimiterOnByte;
         if (byteSize > 0 && localDispatchRateLimiterOnByte != null) {
-            localDispatchRateLimiterOnByte.consumeTokens(byteSize);
+            if (!localDispatchRateLimiterOnByte.consumeTokensAndCheckIfContainsTokens(byteSize)) {
+                dispatchThrottleBytesCount.increment();
+            }
         }
     }
```
3. When get stats or metrics for broker/topic/subscription throttle count, output these fields.

## Public-facing Changes

### Metrics

1. `pulsar_broker_dispatch_throttled_msg_count`:
  - Description: The total count of messages throttled for a broker
  - Attributes: 
    - cluster
  - Unit: throttled count
   
2. `pulsar_broker_dispatch_throttled_bytes_count`:
  - Description: The total count of bytes throttled for a broker
  - Attributes:
    - cluster
  - Unit: throttled count
     
3. `pulsar_dispatch_throttled_msg_count`:
  - Description: The total count of messages throttled for a topic
  - Attributes:
    - tenant
    - namespace
    - topic
  - Unit: messages count

4. `pulsar_dispatch_throttled_bytes_count`:
  - Description: The total count of messages throttled for a topic
  - Attributes:
    - tenant
    - namespace
    - topic
  - Unit: messages count

5. `pulsar_subscription_dispatch_throttled_msg_count`:
  - Description: The total count of messages throttled for a subscription
  - Attributes:
    - tenant
    - namespace
    - topic
    - subscription
  - Unit: messages count

6. `pulsar_subscription_dispatch_throttled_bytes_count`:
  - Description: The total count of messages throttled for a subscription
  - Attributes:
    - tenant
    - namespace
    - topic
    - subscription
  - Unit: messages count

### API
1. Add get throttle count interface on admin api `TopicStats`.
```java
    /**
     * Total count of throttling occurrences due to message rate limiting.
     */
    long getDispatchThrottledMsgCount();

    /**
     * Total count of throttling occurrences due to byte rate limiting.
     */
    long getDispatchThrottledBytesCount();
```

2. Add get throttle count interface on admin api `SubscriptionStats`.
```java
    /**
     * Total count of throttling occurrences due to message rate limiting.
     */
    long getDispatchThrottledMsgCount();

    /**
     * Total count of throttling occurrences due to byte rate limiting.
     */
    long getDispatchThrottledBytesCount();
```

### Configuration
- None

# Backward & Forward Compatibility
- Full Compatibility

