

# PIP-334: Create a new command: pck (Pulsar Consistency Checker).

# Background knowledge
We need an administrator interface to detect whether the topic metadata is consistent with the zookeeper.

# Motivation
Orphan ledgers can be detected through the PCK cmd when the bookkeeper's disk is abnormally high.
If necessary, we can be deleted directly to free up disk space.


# Goals

## In Scope

Create a new command :

```shell
pulsar-ck pck 
Usage: pck [-hV] [COMMAND]
  -h, --help      Show this help message and exit.
  -V, --version   Print version information and exit.
Commands:
  find-orphan-ledger  find-orphan-ledger
```

  



# Detailed Design

## Design & Implementation Details


```java
private void start() throws Exception {
    Set<Long> nonOrphanedLedgers = new HashSet<>();
    ConcurrentHashMap<Long, Infos> maybeOrphanedLedgers = new ConcurrentHashMap<>();
    try {
        for (Long ledgerId : bookKeeperAdmin.listLedgers()) {
            semaphore.acquire();
            if (nonOrphanedLedgers.contains(ledgerId)) {
                semaphore.release();
                continue;
            }
            openLedger(ledgerId).thenAccept(infos -> {
                if (!infos.isPulsarLedger()) {
                    semaphore.release();
                    return;
                }
                TopicName topicName = infos.getLedgerTopic();
                if (topicName == null) {
                    maybeOrphanedLedgers.put(ledgerId, infos);
                    semaphore.release();
                    return;
                }
                infos.stillExistsInMetaStore().thenAccept(existsInMetaStore -> {
                    if (!existsInMetaStore) {
                        processOrphanedLedger(infos).whenComplete((__, ex) -> {
                            semaphore.release();
                        });
                        return;
                    }
                    getTopicUsedLedgersAsync(topicName.toString()).thenAccept(ledgers -> {
                        ledgers.forEach(lid -> {
                            nonOrphanedLedgers.add(lid);
                            maybeOrphanedLedgers.remove(lid);
                        });

                        if (!ledgers.contains(ledgerId)) {
                            this.processOrphanedLedger(infos).whenComplete((__, ex) -> {
                                semaphore.release();
                            });
                        } else {
                            semaphore.release();
                        }
                    }).exceptionally((e) -> {
                        if (e.getCause() instanceof PulsarAdminException.NotFoundException) {
                            if (infos.isSchemaLedger()) {
                                maybeOrphanedLedgers.put(ledgerId, infos);
                                semaphore.release();
                            } else {
                                processOrphanedLedger(infos).whenComplete((__, ex1) -> {
                                    semaphore.release();
                                });
                            }
                        } else {
                            LOG.error("Failed to get topic: {} ledgerId list: {}", topicName, e);
                            semaphore.release();
                        }

                        return null;
                    });

                }).exceptionally((ex) -> {
                    LOG.error("Fail to check if ledgerId {} exists in meta store", ledgerId, ex);
                    return null;
                });

            }).exceptionally(e -> {
                LOG.error("Failed to open ledgerId {}", ledgerId, e);
                return null;
            });

        }
        while (this.semaphore.availablePermits() != this.semaphorePermits) {
            Thread.sleep(100);
        }

        for (Map.Entry<Long, Infos> entry : maybeOrphanedLedgers.entrySet()) {
            Long ledgerId = entry.getKey();
            Infos infos = entry.getValue();
            semaphore.acquire();
            if (infos.isSchemaLedger()) {
                String topic = infos.getLedgerTopic().toString();
                getTopicUsedLedgersAsync(this.transferToPartition0Topic(topic)).thenAccept((ledgers) -> {
                    if (!ledgers.contains(infos.getLedgerId())) {
                        this.processOrphanedLedger(infos).whenComplete((__, ex1) -> {
                            semaphore.release();
                        });
                    }
                }).exceptionally((ex) -> {
                    if (ex.getCause() instanceof PulsarAdminException.NotFoundException) {
                        this.processOrphanedLedger(infos).whenComplete((__, ex1) -> {
                            semaphore.release();
                        });
                    } else {
                        LOG.error("Failed to get topic: {} ledger list: {}", topic, ex);
                        semaphore.release();
                    }

                    return null;
                });
            } else {
                this.processOrphanedLedger(infos).whenComplete((__, ex1) -> {
                    semaphore.release();
                });
            }
        }
    } catch (Exception e){
        LOG.error("Fail to find orphaned ledger", e);
    } finally {
        admin.close();
        bookKeeperAdmin.close();
        zooKeeper.close();
    }
}
```

Specific implementation logic is referred to in this [link](https://docs.streamnative.io/platform/pck-tutorial#find-orphan-ledgers-from-bookie).


# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread:
* Mailing List voting thread:
