

# PIP-334: Create a new admin API: pck (Pulsar Consistency Checker).

# Background knowledge
We need an administrator interface to detect whether the topic metadata is consistent with the zookeeper.

# Motivation
Orphan ledgers can be detected through the PCK API when the bookkeeper's disk is abnormally high.
If necessary, we can be deleted directly to free up disk space.


# Goals

## In Scope

Create a new admin API:

- POST /admin/v2/pck/detect-orphan-ledger
  - Get ledgers from the topic's metadata and zookeeper, then compare them, find orphaned ledgers that are not used in the topic, and remove them if necessary.

  



# Detailed Design

## Design & Implementation Details


```java
@Path("/pck")
@Produces(MediaType.APPLICATION_JSON)
@Api(value = "/pck", description = "pck apis", tags = "consistency checker")
public class ConsistencyChecker extends AdminResource {

    @POST
    @Path("/detect-orphan-ledger")
    @ApiOperation(value = "detect orphan ledger.", response = OrphanedLedgerInfo.class, responseContainer = "List")
    @ApiResponses(value = {
            @ApiResponse(code = 500, message = "Internal server error")})
    public void detectOrphanLedger(@Suspended AsyncResponse asyncResponse,
            @ApiParam(value = "Delete the orphan ledgers.")
            @QueryParam("delete") @DefaultValue("false") boolean delete,
            @ApiParam(value = "Delete the orphan ledgers.")
            @ApiParam(value = "The minimum stale time (in days) for topic ledgers.", defaultValue = "7")
            @PathParam("staleTime") int staleTime) {
    }


  private void internalDetectOrphanLedger(AsyncResponse asyncResponse, boolean delete, int staleTime) {
    ManagedLedgerFactoryImpl managedLedgerFactory = (ManagedLedgerFactoryImpl) pulsar().getManagedLedgerFactory();
    BookKeeperAdmin bookKeeperAdmin = new BookKeeperAdmin(managedLedgerFactory.getBookKeeper());
    Set<Long> nonOrphanedLedgers = new ConcurrentHashSet<>();
    int semaphorePermits = 1;
    Semaphore semaphore = new Semaphore(semaphorePermits);
    Set<BookieInfo> maybeOrphanedLedgers = new ConcurrentHashSet<>();
    Set<OrphanedLedgerInfo> orphanedLedgers = new ConcurrentHashSet<>();
    try {
      bookKeeperAdmin.listLedgers().forEach(ledgerId -> {
        if (!nonOrphanedLedgers.contains(ledgerId)) {
          try {
            semaphore.acquire();
            openLedger(ledgerId).thenAccept((infosx) -> {
              if (!infosx.isPulsarLedger()) {
                log.warn("Ledger:{} is not a pulsar ledger.", ledgerId);
                semaphore.release();
                return;
              }

              TopicName topic = infosx.getLedgerTopic();
              if (topic == null) {
                maybeOrphanedLedgers.add(infosx);
                semaphore.release();
              } else {
                infosx.stillExistsInMetaStore().thenAccept((exists) -> {
                  if (!exists) {
                    processOrphanedLedger(infosx, staleTime).whenComplete((r, ex) -> {
                      r.ifPresent(orphanedLedgers::add);
                      semaphore.release();
                    });
                  } else {
                    getTopicUsedLedgersAsync(topic.toString()).thenAccept((ledgers) -> {
                      ledgers.forEach((lid) -> {
                        nonOrphanedLedgers.add(lid);
                        maybeOrphanedLedgers.remove(lid);
                      });
                      if (!ledgers.contains(ledgerId)) {
                        processOrphanedLedger(infosx, staleTime).whenComplete((r, ex) -> {
                          r.ifPresent(orphanedLedgers::add);
                          semaphore.release();
                        });
                      } else {
                        semaphore.release();
                      }

                    }).exceptionally((ex) -> {
                      if (ex.getCause() instanceof PulsarAdminException.NotFoundException) {
                        if (infosx.isSchemaLedger()) {
                          maybeOrphanedLedgers.add(infosx);
                          semaphore.release();
                        } else {
                          processOrphanedLedger(infosx, staleTime).whenComplete((r, ex1) -> {
                            r.ifPresent(orphanedLedgers::add);
                            semaphore.release();
                          });
                        }
                      } else {
                        log.error("Failed to get topic: {} ledger list: {}", topic, ex);
                        semaphore.release();
                      }

                      return null;
                    });
                  }

                }).exceptionally((ex) -> {
                  log.error("Failed to get topic: {} ledger list: {}", topic, ex);
                  semaphore.release();
                  return null;
                });
              }


            });
          } catch (InterruptedException e) {
            asyncResponse.resume(new RestException(e));
          }
        }
      });

      while (semaphore.availablePermits() != semaphorePermits) {
        Thread.sleep(100);
      }

      maybeOrphanedLedgers.forEach(infos -> {
        try {
          semaphore.acquire();
        } catch (InterruptedException e) {
          asyncResponse.resume(new RestException(e));
        }

        if (infos.isSchemaLedger()) {
          String topic = infos.getLedgerTopic().toString();
          getTopicUsedLedgersAsync(transferToPartition0Topic(topic)).thenAccept((ledgers) -> {
            if (!ledgers.contains(infos.getLedgerId())) {
              this.processOrphanedLedger(infos, staleTime).whenComplete((r, ex1) -> {
                r.ifPresent(orphanedLedgers::add);
                semaphore.release();
              });
            }
          }).exceptionally((ex) -> {
            if (ex.getCause() instanceof PulsarAdminException.NotFoundException) {
              this.processOrphanedLedger(infos, staleTime).whenComplete((r, ex1) -> {
                r.ifPresent(orphanedLedgers::add);
                semaphore.release();
              });
            } else {
              log.error("Failed to get topic: {} ledger list: {}", topic, ex);
              semaphore.release();
            }

            return null;
          });
        }

      });

      while (semaphore.availablePermits() != semaphorePermits) {
        Thread.sleep(100);
      }

      if (delete) {
        deleteLedger(orphanedLedgers);
      }
      asyncResponse.resume(orphanedLedgers);
    } catch (Exception e) {
      asyncResponse.resume(new RestException(e));
    }
  }
}



@Data
public class OrphanedLedgerInfo {
    private long ledgerId;
    private long createTimestamp;
    private Map<String, String> metadata;
}
```
Specific implementation logic is referred to in this [link](https://docs.streamnative.io/platform/pck-tutorial#find-orphan-ledgers-from-bookie).


# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread:
* Mailing List voting thread:
