# PIP-401: Support set batching configurations for Pulsar Functions&Sources

# Background knowledge

Pulsar Functions and Sources enable the batching feature hard-coded, and also set the `batchingMaxPublishDelay` to 10ms, it only
supports set the `batch-builder` for now, this is not suitable for all the use cases, and also not feasible for users.

# Motivation

Support setting batching configurations for Pulsar Functions&Sources, to make it more flexible and suitable for users.

# Goals

## In Scope

- Support setting batching configurations for Pulsar Functions&Sources.

# High Level Design

Make users able to enable&disable batching and set batching configurations for Pulsar Functions&Sources.

# Detailed Design

## Design & Implementation Details

- Add below cli arguments to create&update functions/sources command to support setting batching configurations.
  - `--batching-enabled` with default value = true (to keep the compatibility)
  - `--batching-max-publish-delay-ms` with default value = 10 (to keep the compatibility)
  - `--batching-max-messages`
  - `--batching-max-bytes`
- Add below fields to the `FunctionConfig` and `SourceConfig`
  - `bool batchingEnabled`
  - `int batchingMaxPublishDelayMs`
  - `int batchingMaxMessages`
  - `int batchingMaxBytes`
- Add a new message `BatchingSpec` with below fields in `Function.proto`, and add it as a new filed `batchingSpec` to the `ProducerSpec` message
  - `bool enabled`
  - `int32 batchingMaxPublishDelayMs`
  - `int32 batchingMaxMessages`
  - `int32 batchingMaxBytes`
  - `string batchBuilder`
- Add a new class `BatchingConfig` with below fields and add it as a new field `batchingConfig` to the `ProducerConfig`:
  - `bool enabled`
  - `int batchingMaxPublishDelayMs`
  - `int batchingMaxMessages`
  - `int batchingMaxBytes`
  - `String batchBuilder`

And related logic also will be added:
- set the batching related configs in the `FunctionConfig` and `SourceConfig` according to the cli arguments
- convert the batching related configs in `FunctionConfig`/`SourceConfig` to the `batchingSpec` field of the `ProducerSpec` in `FunctionDetails` and vice versa
- convert the `batchingSpec` field of the `ProducerSpec` from `FunctionDetails` to the `batchingConfig` field of the `ProducerConfig` and vice versa

To keep the compatibility, when the `batchingSpec` of the `ProducerSpec` is null when creating the `ProducerConfig` from the `ProducerSpec` of `FunctionDetails`,
the `batchingConfig` field will be fallback to: `BatchingConfig(enabled=true, batchingMaxPublishDelayMs=10)`.

## Public-facing Changes

### CLI

Four new arguments are added to the create&update functions/sources command:

- `--batching-enabled`
- `--batching-max-publish-delay-ms`
- `--batching-max-messages`
- `--batching-max-bytes`

# Monitoring

No new metrics are added in this proposal.

# Security Considerations

No new security considerations are added in this proposal.

# Backward & Forward Compatibility

## Revert

No changes are needed to revert to the previous version.

## Upgrade

No other changes are needed to upgrade to the new version.

# Alternatives

None

# General Notes

# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread: 
* Mailing List voting thread: 
