# PIP-424: Support Getting Position by Index in ManagedLedger Interface

# Background knowledge

- **ManagedLedger**: Core Pulsar component managing message storage in BookKeeper ledgers
- **Message Index**: A monotonically increasing counter (0-based) that uniquely identifies each user message within a
  single partition of a topic.
    - The index counts individual user messages, not batch entries or broker control/transaction/compaction markers.
    - The index is scoped per partition; each partition maintains its own independent sequence of indexes.
    - Retention, deletion, and offload do not affect the continuity of the index: once assigned, indexes are never
      reused, and gaps may exist if messages are deleted or offloaded.
- **LedgerInfo**: Metadata stored per ledger in ZK/metastore (ledgerID, size, etc.)

# Motivation

Current approaches to get message ID by index rely on **broker entry metadata** (PIP-415), but custom ManagedLedger
implementations (like StreamNative's Ursa engine) may not use broker entry metadata for tracking message indexes.

So it is necessary to add `getPositionByIndex()` in the **ManagedLedger** interface directly.

# Goals

## In Scope

- Add `getPositionByIndex()` to `ManagedLedger`

## Out of Scope

不适用

# High Level Design

1. **Custom Engine Support**: Alternative implementations via `ManagedLedger` interface

# Detailed Design

## Design & Implementation Details

## Public-facing Changes

**1. `ManagedLedger` Interface Change**

```java
public interface ManagedLedger {
    CompletableFuture<Position> getPositionByIndex(long index);
}
```

### Public API

No changes

### Binary protocol

No changes

### Configuration

No changes

### CLI

No changes

### Metrics

No changes

# Backward & Forward Compatibility

## Avoiding Breaking Changes

Adding a new method to the `ManagedLedger` interface can break existing implementations that do not provide an
implementation for the new method. To avoid this:

- **Default Method:** The new `getPositionByIndex(long index)` method will be added as a `default` method in the
  interface, which throws `UnsupportedOperationException` by default. This ensures that existing implementations will
  continue to compile and run, but will throw an exception if the new method is called and not overridden.

  ```java
  default CompletableFuture<MessageId> getPositionByIndex(long index) {
      throw new UnsupportedOperationException("getPositionByIndex is not implemented");
  }

# Links

* Mailing List discussion thread: https://lists.apache.org/thread/wp8ydz02t0oh0533q8f8w8r1h09rtlt3
* Mailing List voting thread:
