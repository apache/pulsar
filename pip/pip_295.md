# PIP 295: Support storing brokerClient certificates in ZooKeeper

# Background knowledge

The use case is under configuring the geo-replication to a remote cluster with TLS enabled and will require to set `brokerClientTlsEnabled` as true and configure the `brokerClientTrustCertsFilePath` when using the [createCluster](https://pulsar.apache.org/admin-rest-api/?version=2.11.0#operation/createCluster) API. But this is hard to maintain because users need to :

*  Users need to copy and deploy the destination cluster trusted TLS certificate file to the local cluster for each broker.
*  Users need to make sure the destination cluster trusted TLS certificate file location is consistent with each broker.
*  Users need to record and maintain the certificate file path on brokers, cleaning this location will impact the geo-replication.

# Motivation

So, I am proprosing to support uploading the TLS certificates on the `createCluster` API and the broker can help store the destination cluster trusted TLS certificates in ZooKeeper since it's an existing data storage systems. When the local cluster needs to connect to the destination cluster, local cluster brokers can extract the trusted TLS certificate file from ZooKeeper and setup the connection to the destination cluster.

# Goals

## In Scope

* This PIP will propose the extend the `createCluster` API to introduce a new parameter to support uploading a remote cluster TLS certificate and store this certificate in ZooKeeper. 
* Local cluster brokers can extract the trusted TLS certificate file from ZooKeeper and connection to the destination cluster when replicating the data. 
* Update and delete the LS certificate file stored in ZooKeeper. 

## Out of Scope

Upload existing certificates under Pulsar Broker `brokerClientTrustCertsFilePath` is not supported in this PIP. 

# High Level Design

We can add a new parameter `brokerClientTrustCerts` to the `createCluster` API to support this PIP proposal. And this PIP will be used like this way:

1. Users need to set the `brokerClientTlsEnabled` as `True` and `brokerClientTrustCerts` to enable this feature and specify the TLS certificate in local path for the `brokerClientTrustCerts`. 
2. The TLS certificate will be encoded into base64 and stored into ZooKeeper with the cluster medatadata. One remote cluster only has one single TLS certificate and supports to replace the certificate through the `updateCluster` API. 
3. When the replicator in Broker tries to setup the connection to remote cluster, broker can extract the certificate in target cluster medatadata and decode to use. 
4. If user deleting the remote cluster by `deleteCluster` API, the stored certificate should be cleaned up together. 

# Detailed Design

TBD

# Backward & Forward Compatibility

This PIP will keep compatibility in the `createCluster` API by:
* The new parameter `brokerClientTrustCerts` will only take affect when not using the `brokerClientTrustCertsFilePath`
* If both `brokerClientTrustCertsFilePath` and `brokerClientTrustCerts` parameters are configured, Broker will use the `brokerClientTrustCertsFilePath`. 

# Links

* Mailing List discussion thread: https://lists.apache.org/thread/1r9hq2gxob801ttxypqvv8b2rxffzv80