# Background knowledge

In Pulsar, a pulsar function support storing state, such as a `WordCount` function which stores the state of its counters.

```python
from pulsar import Function

class WordCount(Function):
    def process(self, item, context):
        for word in item.split():
            context.incr_counter(word, 1)
```

Currently, Pulsar uses Bookkeeper as the default state storage interface. We can also use other state stores, which can be configured in the `conf/functions_worker.yml` using the field: `stateStorageProviderImplementation`, this YAML file will be parsed and loaded in Pulsar as the `WorkerConfig`.

The `WorkerConfig` is used to configure the Pulsar functions worker and has two fields related to the state store:

1. `stateStorageProviderImplementation`: The implementation class for the state store which should implement the interface `StateStoreProvider`, such as `org.apache.pulsar.functions.instance.state.BKStateStoreProviderImpl`

2. `stateStorageServiceUrl`: The service URL of state storage, such as: `bk://localhost:4181`

## `Runtime` and `RuntimeFactory`:

Pulsar Function supports three kinds of runtime and, correspondingly, has three related `RuntimeFactory` to create them,

1. ThreadRuntime: Each instance runs as a thread; it will load the `JavaInstanceRunnable`

2. ProcessRuntime: Each instance runs as a process; it will start a `ProcessBuilder` with commands to start `JavaInstanceStarter`, the `JavaInstanceStarter` will load the `ThreadRuntime` and finally load the `JavaInstanceRunnable`, this is for `Java` function, for other languages, the commands will start related "instance"

3. KubernetesRubtime: Function is submitted as Kubernetes StatefulSet by workers and each function instance runs as a pod; similar to the process runtime, the StatefulSet's command will start the `JavaInstanceStarter` and finally load the `JavaInstanceRunnable`, for other languages, the command will start related "instance"


# Motivation

Pulsar functions don't support configuring the `StateStoreProviderImplClass` with extra configurations, although there is a `Map<String, Object> config` parameter in the `StateStoreProvider#init` method, it's initialized as a map with only one field `stateStorageServiceUrl` in `javaInstanceRunnable`

see:

https://github.com/apache/pulsar/blob/0a39b819a9ec371322bfde61685497a2c21d9ab3/pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java#L366-L369

Then when using a custom `StateStoreProvider`, it cannot get other configurations from the `init` method.

# Goals

## In Scope

Make `StateStoreProvider` "truly" configurable, custom `StateStoreProvider` can be configured more easily and explicitly.

## Out of Scope


# High Level Design

We will add a configuration key to the Pulsar Function Worker configuration, containing the configuration for the `StateStoreProvider` implementation as a `Map<String, Object>`.
This `Map<String, Object>`, will be trickled down to different runtimes, all the way to `JavaInstanceRunnable`, the ultimate Main class all runtimes use to execute the function.
This class is also the one instantiating the `StateStoreProvider`.

# Detailed Design

## Design & Implementation Details

1. Add a `stateStorageConfig` to the `WorkerConfig`
2. In all three runtime factories, pass this config to the created runtime
3. Add a new cli argument to `JavaInstanceStarter` and `LocalRunner` so process&k8s runtime can pass state related config to them
4. Add new state config parameter to `JavaInstanceRunnable` to accept the state provider related configurations

## Public-facing Changes

### Public API

### Binary protocol

### Configuration

- A new `map<String, Object>` field like `stateStorageConfig` is added to `WorkerConfig`

### CLI

- A new argument like `--stateStorageConfig` is added to `pulsar-admin functions localrun` command, it should be a JSON string that can be deserialized to a `Map<String, Object>`

### Metrics

# Monitoring

# Security Considerations

# Backward & Forward Compatability

## Revert

## Upgrade

# Alternatives

# General Notes

# Links

* Mailing List discussion thread: https://lists.apache.org/thread/pwfv7nj64frfnbw7jfydzx8my15b3lj6
* Mailing List voting thread:
