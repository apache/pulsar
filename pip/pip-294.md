# Background knowledge

Load balance module in Pulsar broker rely on zk to store and synchronize metadata about load. Every broker will upload its `LocalBrokerData` to zk, and leader broker will retrieve all `LocalBrokerData` from zk ,generate all `BundleData` from each `LocalBrokerData`, and update all `BundleData` to zk. 


# Motivation

As every bundle in the cluster corresponds to a zk node, it is common that there are thousands of zk nodes in a cluster, which results into thousands of read/update operations to zk. This will cause a lot of pressure on zk.

**As All Load Shedding Algorithm pick bundles from top to bottom based on throughput/msgRate, bundles with low throughput/msgRate are rarely be selected for shedding. So there is no need to update these bundleData to zk frequently.**


# Goals

Filter out bundles with low throughput/msgRate, and do not update these bundles to zk frequently to reduce the pressure on zk.


# High Level Design

Filter out bundles with low throughput/msgRate when leader update bundleData to zk.


# Detailed Design

## Design & Implementation Details
Add throughput/msg-based bundle report control in the `ExtensibleLoadManager` and `ModularLoadManagerImpl`.

### Configuration

add configuration:
```
    @FieldContext(
            dynamic = true,
            category = CATEGORY_LOAD_BALANCER,
            doc = "minimum throughput in of bundle to be considered for updating data in metadata store"
    )
    private int loadBalancerBundleThroughputThresholdInByte = 0;

    @FieldContext(
            dynamic = true,
            category = CATEGORY_LOAD_BALANCER,
            doc = "minimum message rate in of bundle to be considered for updating data in metadata store"
    )
    private int loadBalancerBundleMsgThreshold = 0;
```
if the value of `loadBalancerBundleThroughputThresholdInByte` or `loadBalancerBundleMsgThreshold` is 0, it means that the corresponding filter is disabled.


# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread:
* Mailing List voting thread:
