# Background knowledge

There are mainly two `LoadManager` implementation in Pulsar broker: `ExtensibleLoadManager` and `ModularLoadManagerImpl`. `ModularLoadManagerImpl` is the default load manager, and `ExtensibleLoadManager` is a new load manager which is proposed after 3.0.0 version.

## ModularLoadManagerImpl
`ModularLoadManagerImpl` rely on zk to store and synchronize metadata about load, which pose greate pressure on zk, threatening the stability of system. Every broker will upload its `LocalBrokerData` to zk, and leader broker will retrieve all `LocalBrokerData` from zk, generate all `BundleData` from each `LocalBrokerData`, and update all `BundleData` to zk. 

## ExtensibleLoadManager
`ExtensibleLoadManager` depends on system topics and table views for load balance metadata store and replication. Though not using zk to store and synchronize metadata about load, it is still necessary to control the number of bundles that need to be updated, for which there is a `loadBalancerMaxNumberOfBundlesInBundleLoadReport` configuration in `ExtensibleLoadManager` that select the top k bundles.

# Motivation

## ModularLoadManagerImpl
As every bundle in the cluster corresponds to a zk node, it is common that there are thousands of zk nodes in a cluster, which results into thousands of read/update operations to zk. This will cause a lot of pressure on zk.

**As All Load Shedding Algorithm pick bundles from top to bottom based on throughput/msgRate, bundles with low throughput/msgRate are rarely be selected for shedding. So there is no need to update these bundleData to zk frequently.**

## ExtensibleLoadManager
As the number of bundles and the throughput in the cluster changes dynamically, users can't select a reasonable number of bundles easily, while based on throughput, we can be sure that bundles with throughput less than 0.1M is useless for load balance no matter how the cluster change.

We can also add this throughput-based bundle report size control in the ExtensibleLoadManager, working together with `loadBalancerMaxNumberOfBundlesInBundleLoadReport`.


# Goals

Reduce the load report size by excluding the bundles with low throughput/msgRate in the bundle load report.

# High Level Design

Filter out bundles with low throughput/msgRate in when leader update bundleData to zk.


# Detailed Design

## Design & Implementation Details
Add throughput/msg-based bundle report control in the `ExtensibleLoadManager` and `ModularLoadManagerImpl`.

### Configuration

add configuration:
```
    @FieldContext(
            dynamic = true,
            category = CATEGORY_LOAD_BALANCER,
            doc = "minimum throughput in of bundle to be considered for updating data in metadata store"
    )
    private int loadBalancerBundleMinThroughputInBytesInBundleLoadReport = 0;

    @FieldContext(
            dynamic = true,
            category = CATEGORY_LOAD_BALANCER,
            doc = "minimum message rate in of bundle to be considered for updating data in metadata store"
    )
    private int loadBalancerBundleMinMessageRateInBundleLoadReport = 0;
```
if the value of `loadBalancerBundleMinThroughputInBytesInBundleLoadReport` or `loadBalancerBundleMinMessageRateInBundleLoadReport` is 0, it means that the corresponding filter is disabled.


# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread: https://lists.apache.org/thread/nsty5pbwl5lqflfjb7sd44g3h5tpcrpn
* Mailing List voting thread: https://lists.apache.org/thread/ofh1xwpzd74xkp5smjr303fl0gw6v2kc
* PR for feature: https://github.com/apache/pulsar/pull/21011