# PIP-374: Visibility of messages in receiverQueue for the consumers

# Background knowledge

When a consumer connects to the server, the server starts dispatching the messages based on receiverQueueSize configured. 
But the consumer will not be able to see whether the messages dispatched by the server and whether it is actually received by the consumer or not. 
We need a mechanism to see whether the messages are dispatched and it is in the recieverQueue or not.

-->

# Motivation

* We need to receive queue filling of the event as the particular message is already on particular consumer's receiver queue and waiting 
for the consumer to pickup and process. It may wait in the recieverQueue longer if the consumer processing takes more time. 
It's very important to provide the visibility of the messages that are waiting in receiverQueue for processing.

* Availability of a consumer application w.r.t any messaging system depends on the number of messages dispatched from the server/broker 
against the number of messages acknowledged from the consumer app. This metric defines the processing rate of a consumer.

Currently, the number of acknowledged messages can be counted by having a counter in onAcknowledge() method of ConsumerInterceptor.
But, there is no way to capture the preFetch(or dispatchRate) in ConsumerInterceptor.

What does this solve?
* Visibility about the message in receiverQueue for the consumer.
* Stuck consumer state visibility
* Scale the consumers to process the spikes in producer traffic
* Reduce the overhead of processing the redeliveries


# Goals

## In Scope

Add an abstract method in ConsumerInterceptor called preFetch() and hook this method call in the internal consumer of MultiTopicConsumerImpl and ConsumerImpl. 
By this way, we will get the preFetch(dispatchRate) count and the consumer app can use this method to get the dispatchRate count.


# High Level Design

Add preFetch() abstract method in ConsumerInterceptor interface.
Hook this method call where the consumer receives the batch messages at once(based on configured receiverQueueSize).


# Detailed Design

## Design & Implementation Details

* ConsumerInterceptor.java
```
Message<T> preFetch(Consumer<T> consumer, Message<T> message);
```

* Add hook in ConsumerBase.notifyPendingBatchReceivedCallBack() whci calls preFetch method which calculated the dispatchRate.
```
Message<T> interceptMsg = preFetch(msg);
```



# Backward & Forward Compatibility

## Upgrade

Since we added an abstract method in interface, one who has provided the implementations for COnsumerInterceptor should provide the implementation for newly
added method preFetch().

# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread:
* Mailing List voting thread:
