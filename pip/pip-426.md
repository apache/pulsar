
# PIP-426: Enhanced Consumer Throttling and Unacknowledged Message Tracking for Exclusive and Failover Subscriptions

# Background knowledge

<!--
Describes all the knowledge you need to know in order to understand all the other sections in this PIP

* Give a high level explanation on all concepts you will be using throughout this document. For example, if you want to talk about Persistent Subscriptions, explain briefly (1 paragraph) what this is. If you're going to talk about Transaction Buffer, explain briefly what this is. 
  If you're going to change something specific, then go into more detail about it and how it works. 
* Provide links where possible if a person wants to dig deeper into the background information. 

DON'T
* Do not include links *instead* explanation. Do provide links for further explanation.

EXAMPLES
* See [PIP-248](https://github.com/apache/pulsar/issues/19601), Background section to get an understanding on how you add the background knowledge needed.
  (They also included the motivation there, but ignore it as we place that in Motivation section explicitly).
-->

Apache Pulsar currently lacks full support for enforcing unacknowledged message limits and consumer-side flow control in exclusive and failover subscriptions. While these mechanisms function correctly for shared subscriptions, their absence in exclusive/failover modes causes critical limitations:

1. **Throttling Inaccuracies**  
   Consumers can exceed configured `maxUnackedMessagesOnConsumer` limits, risking resource exhaustion.

2. **Tracking Deficiencies**  
   `pendingAcks` tracking is disabled or partially functional, compromising visibility into message processing.

3. **Feature Incompatibilities**  
   Current implementation lacks support for:
   - Cumulative acknowledgements
   - Message batching
   - Transactional operations

# Motivation

This proposal addresses these gaps by extending the `pendingAcks` system to support all subscription types.

# Goals

## In Scope

1. **Strict Throttling Enforcement**  
   Apply `maxUnackedMessagesOnConsumer` limits to exclusive and failover subscriptions.

2. **Unified Tracking Mechanism**  
   Enable `pendingAcks` for accurate unacknowledged message tracking across all subscription types.

3. **Feature Compatibility**  
   Support cumulative acknowledgements, message batching, and transactional operations.

4. **Consistent Flow Control**  
   Align flow control behavior across all subscription modes.
<!--
5. **Feature Flag**  
   Add a feature flag to enable/disable the new feature.
-->

## Out of Scope

- No changes to the existing public API or wire protocol.
- No change in behavior for shared subscriptions.

# High Level Design

<!--
Describe the design of your solution in *high level*.
Describe the solution end to end, from a birds-eye view.
Don't go into implementation details in this section.

I should be able to finish reading from beginning of the PIP to here (including) and understand the feature and 
how you intend to solve it, end to end.

DON'T
* Avoid code snippets, unless it's essential to explain your intent.
-->

1. Remove the `Subscription.isIndividualAckMode()` restriction that limits `pendingAcks` usage to shared subscriptions.
2. Extend `PendingAckHandleImpl` for exclusive/failover consumers.
3. Enhance flow control in `PersistentDispatcherSingleActiveConsumer`

# Detailed Design

## Design & Implementation Details

The implementation is available in [PR #24396](https://github.com/apache/pulsar/pull/24396)



## Public-facing Changes

<!--
Describe the additions you plan to make for each public facing component. 
Remove the sections you are not changing.
Clearly mark any changes which are BREAKING backward compatability.
-->

### Public API
<!--
When adding a new endpoint to the REST API, please make sure to document the following:

* path
* query parameters
* HTTP body parameters, usually as JSON.
* Response codes, and for each what they mean.
  For each response code, please include a detailed description of the response body JSON, specifying each field and what it means.
  This is the place to document the errors.
-->

### Binary protocol

### Configuration

### CLI

### Metrics

<!--
For each metric provide:
* Full name
* Description
* Attributes (labels)
* Unit
-->


# Monitoring

<!-- 
Describe how the changes you make in this proposal should be monitored. 
Don't describe the detailed metrics - they should be at "Public-facing Changes" / "Metrics" section.
Describe how the user will use the metrics to monitor the feature: Which alerts they should set up, which thresholds, ...
-->

# Security Considerations
<!--
A detailed description of the security details that ought to be considered for the PIP. This is most relevant for any new HTTP endpoints, new Pulsar Protocol Commands, and new security features. The goal is to describe details like which role will have permission to perform an action.

An important aspect to consider is also multi-tenancy: Does the feature I'm adding have the permissions / roles set in such a way that prevent one tenant accessing another tenant's data/configuration? For example, the Admin API to read a specific message for a topic only allows a client to read messages for the target topic. However, that was not always the case. CVE-2021-41571 (https://github.com/apache/pulsar/wiki/CVE-2021-41571) resulted because the API was incorrectly written and did not properly prevent a client from reading another topic's messages even though authorization was in place. The problem was missing input validation that verified the requested message was actually a message for that topic. The fix to CVE-2021-41571 was input validation. 

If there is uncertainty for this section, please submit the PIP and request for feedback on the mailing list.
-->

# Backward & Forward Compatibility

- Fully backward compatible.
- No config changes required unless explicitly setting `maxUnackedMessagesOnConsumer` for new use cases.

# Alternatives
None

# General Notes

# Links
<!--
Updated afterwards
-->
* Mailing List discussion thread: TBD
* Mailing List voting thread: TBD
- [Original Issue #24159](https://github.com/apache/pulsar/issues/24159)
- [PR #24396](https://github.com/apache/pulsar/pull/24396)


