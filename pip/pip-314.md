# PIP-314: Add metrics pulsar_subscription_redelivery_messages

# Background knowledge

## Delivery of messages in normal

To simplify the description of the mechanism, let's take the policy [Auto Split Hash Range](https://pulsar.apache.org/docs/3.0.x/concepts-messaging/#auto-split-hash-range)  as an example:

| `0 ~ 16,384`      | `16,385 ~ 32,768` | `32,769 ~ 65,536`              |
|-------------------|-------------------|--------------------------------|
| ------- C1 ------ | ------- C2 ------ | ------------- C3 ------------- |

- If the entry key is between `-1(non-include) ~ 16,384(include)`, it is delivered to C1
- If the entry key is between `16,384(non-include) ~ 32,768(include)`, it is delivered to C2
- If the entry key is between `32,768(non-include) ~ 65,536(include)`, it is delivered to C3

# Motivation

Such as the example above, if `C1` stuck or consume slowly, the Broker will push the entries which should delivery to `C1` into a memory collection `redelivery_messages` and read next entries continue, then the collection `redelivery_messages` become larger and larger and take up a lot of memory. When sending messages, it will also determine the key of the entries in the collection `redelivery_messages`, which will also affect performance.

# Goals

Add a metrics `pulsar_subscription_redelivery_messages` to indicate how many entries recorded by the collection `redelivery_messages`, used by push an alert if it is too large.

Differ with `pulsar_subscription_unacked_messages & pulsar_subscription_back_log`

- `pulsar_subscription_unacked_messages`: the messages have been delivered to the client, but has not been acked.
- `pulsar_subscription_back_log`: how many messages should be acknowledged, contains delivered messages and not delivered.

### Public API

<strong>SubscriptionStats.java</strong>
```java
long getRedeliveryMessageCount();
```

### Metrics

`pulsar_subscription_redelivery_messages`
- Full name: `pulsar_subscription_redelivery_messages_count`
- Description: how many entries which maintained in memory should be redelivery to the client.
- Attributes: `[cluster, namespace, topic, subscription]`
- Unit: `Counter`


# Monitoring

push an alert if `pulsar_subscription_redelivery_messages` is too large.