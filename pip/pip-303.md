
# Motivation

When a topic has a large number of producers or consumers (over 1k), querying the `pulsarAdmin.topics().getPartitionedStats()` interface is slow and the response size is also large.
As a result, it's essential to give users the option of querying producer and consumer information.



# Goals

## In Scope

Add the API for `org.apache.pulsar.client.admin.Topics`
```java
CompletableFuture<PartitionedTopicStats> getPartitionedStatsAsync(
        String topic, boolean perPartition, GetStatsOptions getStatsOptions);

CompletableFuture<TopicStats> getStatsAsync(String topic, GetStatsOptions getStatsOptions);
```



## Out of Scope

None.


# High Level Design

Implement the `getPartitionedStatsAsync` method, and add the `exclusivePublishers` and `exclusiveConsumers` parameters to `{tenant}/{namespace}/{topic}/partitioned-stats` API in `PersistentTopics` and `NonPersistentTopics`.

# Detailed Design

## Design & Implementation Details


Add two fields for `org.apache.pulsar.client.admin.GetStatsOptions`
```java
@Data
@Builder
public class GetStatsOptions {
    /**
     * Whether to exclusive publishers.
     */
    private final boolean exclusivePublishers;

    /**
     * Whether to exclusive consumers.
     */
    private final boolean exclusiveConsumers;
    
}
```

Implement the `getPartitionedStatsAsync` and `getStatsAsync` interface for `org.apache.pulsar.client.admin.internal.TopicsImpl`
```java
@Override
public CompletableFuture<PartitionedTopicStats> getPartitionedStatsAsync(String topic, boolean perPartition, GetStatsOptions getStatsOptions){
    TopicName tn = validateTopic(topic);
    WebTarget path = topicPath(tn, "partitioned-stats");
    path = path.queryParam("perPartition", perPartition)
            .queryParam("getPreciseBacklog", getStatsOptions.isGetPreciseBacklog())
            .queryParam("subscriptionBacklogSize", getStatsOptions.isSubscriptionBacklogSize())
            .queryParam("getEarliestTimeInBacklog", getStatsOptions.isGetEarliestTimeInBacklog());
            .queryParam("exclusivePublishers", getStatsOptions.isExclusivePublishers())
            .queryParam("exclusiveConsumers", getStatsOptions.isExclusiveConsumers());
}

@Override
public CompletableFuture<TopicStats> getStatsAsync(String topic, GetStatsOptions getStatsOptions){
    TopicName tn = validateTopic(topic);
    WebTarget path = topicPath(tn, "stats")
            .queryParam("getPreciseBacklog", getStatsOptions.isGetPreciseBacklog())
            .queryParam("subscriptionBacklogSize", getStatsOptions.isSubscriptionBacklogSize())
            .queryParam("getEarliestTimeInBacklog", getStatsOptions.isGetEarliestTimeInBacklog());
            .queryParam("exclusivePublishers",getStatsOptions.isExclusivePublishers())
            .queryParam("exclusiveConsumers",getStatsOptions.isExclusiveConsumers());
}        
```

Add the `exclusivePublishers` and `exclusiveConsumers` parameters to `{tenant}/{namespace}/{topic}/partitioned-stats` API
```java
@GET
@Path("{tenant}/{namespace}/{topic}/partitioned-stats")
public void getPartitionedStats(
        @Suspended final AsyncResponse asyncResponse,
        @ApiParam(value = "Specify the tenant", required = true)
        @PathParam("tenant") String tenant,
        @ApiParam(value = "Specify the namespace", required = true)
        @PathParam("namespace") String namespace,
        @ApiParam(value = "Specify topic name", required = true)
        @PathParam("topic") @Encoded String encodedTopic,
        @ApiParam(value = "Get per partition stats")
        @QueryParam("perPartition") @DefaultValue("true") boolean perPartition,
        @ApiParam(value = "Whether leader broker redirected this call to this broker. For internal use.")
        @QueryParam("authoritative") @DefaultValue("false") boolean authoritative,
        @ApiParam(value = "If return precise backlog or imprecise backlog")
        @QueryParam("getPreciseBacklog") @DefaultValue("false") boolean getPreciseBacklog,
        @ApiParam(value = "If return backlog size for each subscription, require locking on ledger so be careful "
                + "not to use when there's heavy traffic.")
        @QueryParam("subscriptionBacklogSize") @DefaultValue("true") boolean subscriptionBacklogSize,
        @ApiParam(value = "If return the earliest time in backlog")
        @QueryParam("getEarliestTimeInBacklog") @DefaultValue("false") boolean getEarliestTimeInBacklog,
        @ApiParam(value = "If exclusive the publishers")
        @QueryParam("exclusivePublishers") @DefaultValue("false") boolean exclusivePublishers,
        @ApiParam(value = "If exclusive the consumers")
        @QueryParam("exclusiveConsumers") @DefaultValue("false") boolean exclusiveConsumers)

```

Add the `exclusivePublishers` and `exclusiveConsumers` parameters to `{tenant}/{namespace}/{topic}/stats` API
```java
@GET
@Path("{tenant}/{namespace}/{topic}/stats")
public void getStats(
        @Suspended final AsyncResponse asyncResponse,
        @ApiParam(value = "Specify the tenant", required = true)
        @PathParam("tenant") String tenant,
        @ApiParam(value = "Specify the namespace", required = true)
        @PathParam("namespace") String namespace,
        @ApiParam(value = "Specify topic name", required = true)
        @PathParam("topic") @Encoded String encodedTopic,
        @ApiParam(value = "Whether leader broker redirected this call to this broker. For internal use.")
        @QueryParam("authoritative") @DefaultValue("false") boolean authoritative,
        @ApiParam(value = "If return precise backlog or imprecise backlog")
        @QueryParam("getPreciseBacklog") @DefaultValue("false") boolean getPreciseBacklog,
        @ApiParam(value = "If return backlog size for each subscription, require locking on ledger so be careful "
                + "not to use when there's heavy traffic.")
        @QueryParam("subscriptionBacklogSize") @DefaultValue("true") boolean subscriptionBacklogSize,
        @ApiParam(value = "If return time of the earliest message in backlog")
        @QueryParam("getEarliestTimeInBacklog") @DefaultValue("false") boolean getEarliestTimeInBacklog,
        @ApiParam(value = "If exclusive the publishers"),
        @QueryParam("exclusivePublishers") @DefaultValue("false") boolean exclusivePublishers,
        @ApiParam(value = "If exclusive the consumers")
        @QueryParam("exclusiveConsumers") @DefaultValue("false") boolean exclusiveConsumers)
```


Add parameters for `org.apache.pulsar.broker.service.Topic`
```java
TopicStatsImpl getStats(boolean getPreciseBacklog, boolean subscriptionBacklogSize,
        boolean getEarliestTimeInBacklog, boolean exclusivePublishers, boolean exclusiveConsumers);

CompletableFuture<? extends TopicStatsImpl> asyncGetStats(boolean getPreciseBacklog,
                                                          boolean subscriptionBacklogSize,
                                                          boolean getEarliestTimeInBacklog,
                                                          boolean exclusivePublishers,
                                                          boolean exclusiveConsumers);
```

Add the following logic in `org.apache.pulsar.broker.service.persistent.PersistentTopic.asyncGetStats` and `org.apache.pulsar.broker.service.persistent.PersistentSubscription.getStats`:

```java
    if (!exclusivePublishers){
        stats.addPublisher(publisherStats);
    }
    
    if (!exclusiveConsumers){
        subStats.consumers.add(consumerStats);
    }
```

## Public-facing Changes


### Public API

### Binary protocol

### Configuration

### CLI

### Metrics



# Monitoring



# Security Considerations


# Backward & Forward Compatibility

## Revert


## Upgrade

# Alternatives

# General Notes

# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread:
* Mailing List voting thread:
