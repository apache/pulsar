# PIP-433: Optimize the conflicts of the replication and automatic creation mechanisms, including the automatic creation of topics and schemas

# Background knowledge

#### Topic auto-creation by Rest API if you have enabled Geo Replication.

The source broker will copy the REST requests that is a partitioned topic creation to the remote cluster if you have already enabled a namespace-level Geo Replication.

The source broker will do the following things when you try to enable a topic-level Geo-Replication, and you did not enable a namespace-level Geo-Replication.
- The source broker checks whether the partitioned topic exists under the remote cluster
- If yes, the source broker compares both partition counts, enabling the topic-level replication if both clusters have the same number of partitions; otherwise, you will get a bad request error.
- If not, it will create the partitioned topic with the same partitions count automatically under the remote cluster.

#### Topic auto-creation by clients if you have enabled Geo Replication.
- `Client of source cluster`: start a consumer/producer for a topic
- `Client of source cluster`: Get partitions for topic
    - At this step, the client will try to get the partitioned metadata of the topic. If the topic does not exist, the broker will create the partitioned metadata automatically.
- `Client of source cluster`: Start internal consumers/producers for each sub-topic(an internal partition of a partitioned topic)
    - At this step, the client will try to connect to the sub-topic. If the sub-topic does not exist, the broker will create the partitioned metadata automatically.
- `Source broker`: starts the geo replicator when a sub-topic is loading up. 
  - The geo replicator maintains an internal producer for the topic under the remote cluster.
  - The internal producer is a single sub-topic producer; it will not trigger a partitioned metadata auto-creation.
  - When starting the internal producer, it confirms that the target topic under the remote cluster should be a non-partitioned topic or a sub-topic.
  - **(Highlight)** Otherwise, prints error logs and stops.

#### Schemas replication if you have enabled Geo Replication.
The internal producer of the geo replicator starts with an `auto-produce` schema, copies a new schema it reads from the source cluster to the remote cluster, and it will be stuck once a schema is incompatible to the remote cluster.

# Motivation

#### Issue 1: conflict topic creation if enabled Geo-Replication
**Steps to reproduce the issue**
- Configurations of both the source cluster and the remote cluster 
  - `allowAutoTopicCreation`: `true`
  - `allowAutoTopicCreationType`: `non-partitioned`
  - `defaultNumPartitions`: `2`
- The namespace `public/default` exists, but you have not enabled Geo-Replication for the namespace yet.
- Start a producer for a topic `persistent://public/default/topic` on the source cluster.
  - It triggers a partitioned topic with `2` partitions created.
- Enable namespace-level Geo-Replication for the namespace `public/default`.
- Start geo replicator for the existing sub-topic `public/default/topic-partition-0`
  - Without [PIP-414: Enforce topic consistency check](https://github.com/apache/pulsar/pull/24213), the geo replicator will trigger a non-partitioned topic creation, which is named `public/default/topic-partition-0`
  - With [PIP-414: Enforce topic consistency check](https://github.com/apache/pulsar/pull/24213), the geo replicator get a denied error.
- However, the user wants to allow the replicator to copy messages to the remote cluster.

#### Issue 2: Replication is stuck because the remote side does not allow schema updates
**Steps to reproduce the issue**
- The topic`public/default/topic` has enabled a geo replication.
- Users controls the topic schema manually, do not allow auto update schema by consumers/producers for both clusters.
- The internal producer is stuck after the user sets a new schema on the source cluster.
- However, the user wants to allowthe  replicator to copy the schema to the remote cluster.

# Goals

1. Add an optional choice: always allow the replicator to register schemas if compatible, even if users set `set-is-allow-auto-update-schema` to false.
2. Add an optional choice: always allow the replicator to trigger a topic auto-creation, including partitioned topics, even if users have disabled topic auto-creation.
  a. It only triggers auto-creation if the remote side has the same auto-creation policy of partition-type and partition-num.
3. Checks compatibility between two clusters when enabling namespace-level replication, which includes the following
  a. All topicsâ€™ partitions that have been created should be the same, including `__change_events`
  b. Auto-creation policies should be the same
  c. Support for adjusting policies automatically when enabling namespace-level policies, and provide an API to review the changes that will be applied. By the way, this feature will be an option param of enabling namespace-level geo replication

# Detailed Design

### Public API

#### Regarding Goal 1: "always allow the replicator to register schemas if compatible"

**The original design of `pulsar-admin topics set-is-allow-auto-update-schema`**

```shell
pulsar-admin namespaces set-is-allow-auto-update-schema
  -d, --disable         Disable schema validation enforced
  -e, --enable          Enable schema validation enforced
```

To add a new param `--always-allow-for-replicator-if-compatible`, which means that always allow the replicator to register a new schema if compatible. The default value is `true`.

#### Regarding the goal-2: "always allow the replicator to trigger a topic auto-creation"

**Add new API for client LookupService**

```java
/**
 * @param topicName it exists before the PIP.
 * @param metadataAutoCreationEnabled, it exists before the PIP.
 * @param expectedPartitionsAutoCreated takes effect when {@param metadataAutoCreationEnabled} is true, the broker will
 *        create a partitioned metadata topic only if the topic does not exist and the default value of
 *        "auto-topic-creation: num-partitions" is the same as {@param expectedPartitionsAutoCreated}. Otherwise, it
 *        returns a topic does not exist error of the topic does not exist.
 */
default CompletableFuture getPartitionedTopicMetadata(TopicName topicName, boolean metadataAutoCreationEnabled, Integer expectedPartitionsAutoCreated) {
    return getPartitionedTopicMetadata(topicName, metadataAutoCreationEnabled, false);
}
```

**The original design of `pulsar-admin namespaces set-auto-topic-creation`**

```shell
pulsar-admin namespaces set-auto-topic-creation 
  -d, --disable         Disable allowAutoTopicCreation on namespace
  -e, --enable          Enable allowAutoTopicCreation on namespace
  -n, --num-partitions=<defaultNumPartitions>
                        The default number of partitions of a topic to be
                          auto-created, applicable to partitioned topics only
  -t, --type=<type>     Type of topic to be auto-created. Possible values:
                          (partitioned, non-partitioned). Default value:
                          non-partitioned
                          Default: non-partitioned
```

To add a new param `--always-allow-for-replicator`, which means that always allow the replicator to trigger a topic auto-creation, including partitioned topics. The default value is `true`.

#### Regarding the goal-3: "checks compatibility between two clusters when enabling namespace-level replication"

Add a new parameter for the exits pulsar-admin command `pulsar-admin namespaces get-auto-topic-creation`

```shell
--applied get applied auto topic creation, returns a broker-level configuration if the namespace-level policy is empty.
```

Add additional checks when calling `pulsar-admin namespaces set-clusters`, which brokers will do
- Auto-creation policies must be the same, including broker-level and namespace-level.
- All exists topics that has the same name between both cluster should have the same partitions, including `__change_events`.

Add a new param for the exists pulsar-admin command `pulsar-admin namespaces set-clusters`

```shell
--adjust-namespace-level-policies-automatically broker uses the policies that applied on the source cluster as a standard
                                                value, to adjust remote cluster policies, including auto-creation
                                                policies, topic partitions of existing topics, and schema update policies.
```

Add a new parameter for the exists pulsar-admin command `pulsar-admin namespaces set-clusters` to preview what will be modified for the new feature `--adjust-namespace-level-policies-automatically`

```shell
--preview preview the changes that will be applied when enabling "--adjust-namespace-level-policies-automatically"
```

### Configuration

#### Regarding the goal-1 and goal-2
- The configuration `broker.conf -> allowAutoTopicCreation` will never affect the behavior of the replicator anymore.
- The configuration `broker.conf -> isAllowAutoUpdateSchemaEnabled` will never affect the behavior of the replicator anymore.

### Metrics

Nothing.

# Monitoring
Nothing.

# Security Considerations
Nothing.

# Backward & Forward Compatibility

Nothing is needed to be done.

## Pulsar Geo-Replication Upgrade & Downgrade/Rollback Considerations
Nothing.

# Alternatives
Nothing.

# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread: https://lists.apache.org/thread/p16gwhfx6rkxdp8dm9pckn43o5875o1s
* Mailing List voting thread: https://lists.apache.org/thread/3nwsbqlkgorswr1oynjwmcz6blkkl5vm
