# PIP-390: Improve the reusability of Pulsar integration test code and best practices for unit and integration tests in Pulsar

## Background

- Integration tests for Apache Pulsar are located in the `tests` module.

## Motivation

Apache Pulsar has several reusable test code, such as topic message test cases, container setup, and other helper functions in the `tests` module. However, since this module is only accessible within the "test" scope, it is difficult to reuse these utilities in other projects.

The Pulsar community has discussed the ideal structures for unit and integration tests in Pulsar (see discussion [here](https://lists.apache.org/thread/fn3rk1x7v9291qh3g6vf4jxhvq6zc4mm)). This PIP aims to document the results of these discussions for future reference.

## Goals

### In Scope

- Improve the reusability of Pulsar integration test code within the `tests` module.
- Document best practices for unit and integration tests in Pulsar.

### Out of Scope

- Revisiting previous guidelines on Pulsar testing practices.
- Addressing improvements to Pulsar test technology (framework).

## High-Level Design

### 1. Improve the Reusability of Pulsar Integration Test Code in the `tests` Module
- Export client test logic and cluster setup code as new modules.
- Separate messaging integration test cases (client test logic) from test cluster setups.

## Detailed Design

### 1. Improve the Reusability of Pulsar Integration Test Code in the `tests` Module

Refactor the `tests` module as follows:

- `tests`: Contains the main integration test runners built under the "test" scope (e.g., test classes using TestNG, dependent on `pulsar-inttest-lib`, `pulsar-inttest-client`, and other modules).
- `pulsar-inttest-lib`: Contains common libraries for integration tests (e.g., test utilities, test containers, and other reusable test setups).
- `pulsar-inttest-client`: Contains common client-side integration test cases (should include only client-side test logic, depending on `PulsarClient` and `PulsarAdmin`). These test cases can be reused in `tests` and other modules.

### 2. Document Best Practices for Unit and Integration Tests in Pulsar

Based on the [community discussion](https://lists.apache.org/thread/fn3rk1x7v9291qh3g6vf4jxhvq6zc4mm), Pulsar contributors should consider the following guidelines when adding new tests:

- **Reuse Test Classes**: When possible, add new test cases as `@Test` annotations within existing test classes instead of creating new classes, as additional classes can increase test overhead.

- **Unit Tests Per Class**: Contributors should add unit tests for each new class they introduce, focusing on the behavior of the classâ€™s public methods. Deep state checks using reflection tools should be avoided, as they may break with future implementation changes. Reference: [Testing on the Toilet - Test Behavior, Not Implementation](https://testing.googleblog.com/2013/08/testing-on-toilet-test-behavior-not.html?m=1).  
  If testing public methods in specific class states is necessary, a constructor with the `@VisibleForTesting` annotation can be added to allow injection of (mocked) member variables.

- **Use In-Memory Test Cluster**: For tests requiring a Pulsar cluster, consider using an in-memory test cluster (e.g., `MockedPulsarServiceBaseTest` or `PulsarTestContext`). This approach is also useful for "mocking" Pulsar behavior.

- **Use Container Test Cluster for Integration Tests**: When the test can run solely with Pulsar client logic and no Pulsar behavior mocking is needed, consider adding it as an integration test using a container-based test cluster. However, container-based tests are heavier than in-memory tests, as they require a containerized cluster setup. Integration tests are typically reserved for core features.

- **Add Shared Client Logic to `pulsar-inttest-client`**: Include/move common test client logic here if it can be reused.
- **Add Shared Libraries to `pulsar-inttest-lib`**: Place reusable test setups or utilities in this module.

## Public-Facing Changes

### Configuration

- N/A

### API Changes

- N/A

## Backward & Forward Compatibility

These changes apply only to test classes, so they do not affect backward or forward compatibility.

## Security Considerations

- N/A

## Links

- [Initial mailing list discussion thread](https://lists.apache.org/thread/fn3rk1x7v9291qh3g6vf4jxhvq6zc4mm)
- Mailing list PIP voting thread (to be added)
