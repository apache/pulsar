# PIP-370: An optional flag: disable the replicators to automatically trigger topic creation

# Background knowledge

Users using Geo-Replication backup data across multiple clusters, as well as Admin APIs related to Geo-Replication and internal replicators of brokers, will trigger topics of auto-creation between clusters.
- For partitioned topics.
  - After enabling namespace-level Geo-Replication: the broker will create topics on the remote cluster automatically when calling `pulsar-admin topics create-partitioned-topic`. It does not depend on enabling `allowAutoTopicCreation`.
  - When enabling topic-level Geo-Replication on a partitioned topic: the broker will create topics on the remote cluster automatically. It does not depend on enabling `allowAutoTopicCreation`.
- For non-partitioned topics and partitions of partitioned topics.
  - The internal Geo-Replicator will trigger topics auto-creation for remote clusters. **(Highlight)** It depends on enabling `allowAutoTopicCreation`. In fact, this behavior is not related to Geo-Replication, it is the behavior of the internal producer of Geo-Replicator,   

# Motivation

In the following scenarios, automatic topic creation across clusters is problematic due to race conditions during deployments, and there is no choice that prevents pulsar resource creation affects each other between clusters.
1. Users want to maintain pulsar resources manually.
2. Users pulsar resources using `GitOps CD` automated deployment, for which
  a. Clusters are deployed simultaneously without user intervention.
  b. Each cluster is precisely configured from git repo config variables - including the list of all tenants/namespaces/topics to be created in each cluster.
  c. Clusters are configured to be exact clones of each other in terms of pulsar resources.

**Passed solution**: disable `allowAutoTopicCreation`, the APIs `pulsar-admin topics create-partitioned-topic` still create topics on the remote cluster when enabled namespace level replication, the API `enable topic-level replication` still create topics, And the internal replicator will keep printing error logs due to a not found error.

# Goals

Introduce a flag to disable the replicators to automatically trigger topic creation.

# Detailed Design

## Configuration

**broker.conf**
```properties
# It is not a dynamic config, the default value is "true" to preserve backward-compatible behavior.
# See details below.
replicationTriggerRemoteTopicCreation=true
```

## Design & Implementation Details

- If `replicationTriggerRemoteTopicCreation` is set to `false`.
  1. After enabling namespace-level Geo-Replication: the broker will not create topics on the remote cluster automatically when calling `pulsar-admin topics create-partitioned-topic`.
  2. When enabling topic-level Geo-Replication on a partitioned topic: broker will not create topics on the remote cluster automatically.
  3. The internal Geo-Replicator will not trigger topic auto-creation for remote clusters, it just keeps retrying to check if the topic exists on the remote cluster, once the topic is created, the replicator starts.
  4. It does not change the behavior that creating subscriptions after enabling `enableReplicatedSubscriptions`, the subscription will also be created on the remote cluster after users enable. `enableReplicatedSubscriptions`.
  5. The config `allowAutoTopicCreation` still works for the local cluster as before, it will not be affected by the new config `replicationTriggerRemoteTopicCreation`.
- If `replicationTriggerRemoteTopicCreation` is set to `true`.
  a. All components work as before. 

# Backward & Forward Compatibility

The feature that disables `replicationTriggerRemoteTopicCreation` depends on the API `PulsarClient.getPartitionsForTopic(String topic, boolean metadataAutoCreationEnabled)`, which was introduced by [PIP-344](https://github.com/apache/pulsar/blob/master/pip/pip-344.md).
- Only when user's all clusters support PIP-344, users can disable `replicationTriggerRemoteTopicCreation`( `>=3.0.6` or `>=3.3.1` ).

# Links
* Mailing List discussion thread: https://lists.apache.org/thread/9fx354cqcy3412w1nx8kwdf9h141omdg
* Mailing List voting thread:
