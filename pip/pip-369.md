# PIP-369: Flag based selective unload on changing ns-isolation-policy 

# Background knowledge

In Apache Pulsar, namespace isolation policies are used to limit the ownership of certain subsets of namespaces to specific broker groups. 
These policies are defined using regular expressions to match namespaces and specify primary and secondary broker groups along with failover policy configurations. 
This ensures that the ownership of the specified namespaces is restricted to the designated broker groups.

For more information, refer to the [Pulsar documentation on namespace isolation](https://pulsar.apache.org/docs/next/administration-isolation/#isolation-levels).

# Motivation

In Apache Pulsar 3.x, changing a namespace isolation policy results in unloading all namespace bundles that match the namespace's regular expression provided in the isolation policy.
This can be problematic for cases where the regex matches a large subset of namespaces, such as `tenant-x/.*`. One of such case is mentioned on this issue: [\[Bug\] Breaking contract b/w 2.9 / 2.10 and 3.0 for ns-isolation-policy](https://github.com/apache/pulsar/issues/23092).
This PIP aims to address the need to either prevent unnecessary unloading or provide a more granular approach to determine what should be unloaded.

Some of the cases covered by this PIP are discussed in [#23092](https://github.com/apache/pulsar/issues/23092) by @grssam.
> - unload nothing as part of the set policy call
> - unload every matching namespace as part of the policy set call
> - unload only the changed namespaces (newly added + removed)

# Goals

## In Scope
This PIP proposes a flag-based approach to control what should be unloaded when an isolation policy is applied. The possible values for this flag are:
- **ALL**: Unload all namespaces that are either added or removed after updating the isolation policy.
- **CHANGED**: Only unload namespaces that are either added or removed due to the policy change.
- **NONE**: Do not unload anything. Unloading can occur naturally due to load balancing or can be done manually using the unload admin call.

This flag will be present in both REST APIs and in admin client as an optional parameter. The default behavior will remain to unload all namespaces matching the new policy.

## Out of Scope

Applying concurrency reducer to limit how many async calls will happen in parallel is out of the scope for this PIP. 
This should be addressed in a separate PIP, as solving the issue of infinite asynchronous calls probably requires changes to broker configurations and is a problem present in multiple areas.
# Detailed Design

## Design & Implementation Details

A new flag will be introduced to control the unloading behavior. This flag will be used by REST APIs and the Pulsar admin client.

```java
enum UnloadOption {
    ALL,        // unloads everything, OLD ⋃ NEW
    CHANGED,    // unload namespaces delta, (new ⋃ old) - (new ∩ old) 
    NONE,       // skip unloading anything, ϕ
};
UnloadOption DEFAULT_VALUE = UnloadOption.ALL;
```
Filters will be added based on the above when namespaces are selected for unload in set policy call.

> **_NOTE:_**  
> For 3.0 unchanged behaviour, the `ALL` option should only unload namespaces matching new policy (NEW). This matches the current behavior and maintains backward compatibility from implementation POV.
> 
> For 4.x,
> 1. The behaviour for the `ALL` flag should change to unload everything matching either the old or new policy (union of both).
> 2. The default flag value should be `CHANGED`, so accidentally missing this flag while applying the policy shouldn't impact workloads already on the correct broker group.

## Public-facing Changes

New methods will be added to take this flag as an input.

Class: pulsar/client/admin/Clusters.java
```java
void createNamespaceIsolationPolicy(
        String cluster, String policyName, NamespaceIsolationData namespaceIsolationData, UnloadOption flag) throws PulsarAdminException;

CompletableFuture<Void> createNamespaceIsolationPolicyAsync(
        String cluster, String policyName, NamespaceIsolationData namespaceIsolationData, UnloadOption flag);

void updateNamespaceIsolationPolicy(
        String cluster, String policyName, NamespaceIsolationData namespaceIsolationData, UnloadOption flag) throws PulsarAdminException;

CompletableFuture<Void> updateNamespaceIsolationPolicyAsync(
        String cluster, String policyName, NamespaceIsolationData namespaceIsolationData, UnloadOption flag);
```

To maintain backward compatibility, default methods will be added.

Class: pulsar/client/admin/Clusters.java
```java
default void createNamespaceIsolationPolicy(
        String cluster, String policyName, NamespaceIsolationData namespaceIsolationData) throws PulsarAdminException {
    createNamespaceIsolationPolicy(cluster, policyName, namespaceIsolationData, DEFAULT_VALUE);
}

default CompletableFuture<Void> createNamespaceIsolationPolicyAsync(
    String cluster, String policyName, NamespaceIsolationData namespaceIsolationData) {
    return createNamespaceIsolationPolicyAsync(cluster, policyName, namespaceIsolationData, DEFAULT_VALUE);
}

default void updateNamespaceIsolationPolicy(
        String cluster, String policyName, NamespaceIsolationData namespaceIsolationData)throws PulsarAdminException {
    updateNamespaceIsolationPolicy(cluster, policyName, namespaceIsolationData, DEFAULT_VALUE);
}
        
default CompletableFuture<Void> updateNamespaceIsolationPolicyAsync(
        String cluster, String policyName, NamespaceIsolationData namespaceIsolationData) {
    return updateNamespaceIsolationPolicyAsync(cluster, policyName, namespaceIsolationData, DEFAULT_VALUE);
}
```

### Public API

There is only a single change in setNamespaceIsolationPolicy() POST call. Addition of query param with the same defaults as discussed above. API params will remain unchanged.
Path: `/{cluster}/namespaceIsolationPolicies/{policyName}`
```java
@DefaultValue("UnloadOption.ALL")
@QueryParam("unloadBundles") UnloadOption flag
```

### CLI

```shell
# set call will have an optional flag. Sample command as shown below:
#
pulsar-admin ns-isolation-policy set cluster-name policy-name --unload-option NONE
# Possible values for UnloadOption: [ALL, CHANGED, NONE]
```


# Backward & Forward Compatibility

This change does not affect how isolation policies work. The changes focus on the implementation of what namespaces will be unloaded based on policy changes.

# Alternatives

Boolean flag to decide either unload the delta namespaces (removed and added) without affecting unchanged namespaces or unload nothing. PR: https://github.com/apache/pulsar/pull/23094

Limitation: This approach does not consider cases where unloading is needed for every matching namespace as part of the policy set call. 
Manual unloading would be required for unchanged namespaces not on the correct broker group.

# Links

<!--
Updated afterwards
-->
* Mailing List discussion thread:
* Mailing List voting thread:
